name: 'Trivy scan'

inputs:
  PR-number:
    description: 'Pull request number'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: refs/pull/${{ inputs.PR-number }}/head

    - name: Run Trivy vulnerability scanner
      uses: intel-innersource/frameworks.actions.trivy@main
      with:
        TRIVY_REPORT_FORMAT: 'json'
        TRIVY_SCAN_TYPE: 'fs'
        TRIVY_OUTPUT_FILE: 'trivy_fs_report_${{ github.sha }}.json'
        TRIVY_SCAN_PATH: '.'
        TRIVY_EXIT_CODE: '1'
        TRIVY_VULN_TYPE: 'os,library'
        TRIVY_SEVERITY: 'CRITICAL,HIGH'
        TRIVY_CUSTOM_PARAMS: "--debug --list-all-pkgs"

    - name: Upload artifacts - csv
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v4
      with:
        name: "trivy_fs_report_${{ github.sha }}"
        path: "trivy_fs_report_${{ github.sha }}.json"
