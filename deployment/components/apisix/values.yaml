# https://github.com/apache/apisix-helm-chart/blob/master/charts/

# APISIX Helm chart configs
apisix:
  serviceAccount:
    create: true
  ingress-controller:
    enabled: true
    rbac:
      create: true
    serviceAccount:
      create: true
    config:
      apisix:
        serviceName: auth-apisix-admin
        serviceNamespace: auth-apisix
    image:
      tag: "1.8.4"
  # Disable built-in etcd subchart (we deploy our own via templates/etcd.yaml)
  etcd:
    enabled: false
  # Configure external etcd (no auth - Istio mTLS handles security)
  externalEtcd:
    host:
      - http://auth-apisix-etcd-client:2379
    user: "" # Empty for disabled auth, security handled by Istio mTLS
  extraInitContainers:
    - name: wait-for-etcd
      image: alpine/curl
      imagePullPolicy: IfNotPresent
      command:
        - sh
        - -c
        - |
          echo "Waiting for etcd to be ready..."
          until curl -sf http://auth-apisix-etcd-client:2379/health | grep -q '"health":"true"'; do
            echo "etcd not ready, waiting..."
            sleep 3
          done
          echo "etcd is ready!"
  extraEnvVars:
    - name: CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: apisix-secret
          key: CLIENT_SECRET

  apisix:
    nginx:
      configurationSnippet:
        httpStart: |
          proxy_read_timeout 3600s;
          proxy_send_timeout 3600s;

# Custom etcd deployment (CoreOS etcd without auth - Istio mTLS for security)
etcd:
  enabled: true
  image:
    repository: quay.io/coreos/etcd
    tag: v3.5.15
    pullPolicy: IfNotPresent
  persistence:
    enabled: true
    storageClass: ""
    size: 8Gi
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  # Cluster configuration
  clusterToken: "apisix-etcd-cluster"
  # Security context
  securityContext:
    fsGroup: 1000
    runAsUser: 1000
    runAsNonRoot: true
  # Probes configuration
  livenessProbe:
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
  readinessProbe:
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
