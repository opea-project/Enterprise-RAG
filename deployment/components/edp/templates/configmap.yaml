# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

apiVersion: v1
kind: ConfigMap
metadata:
  name: edp-configmap
  namespace: {{ .Release.Namespace }}
data:
  HIERARCHICAL_DATAPREP_ENDPOINT: {{ if .Values.hierarchicalDataprep.enabled }}{{ print "http://" .Values.hierarchicalDataprep.nameOverride ":9399/v1/hierarchical_dataprep" | quote }}{{ else }}""{{ end }}
  TEXT_EXTRACTOR_ENDPOINT: {{ if not .Values.hierarchicalDataprep.enabled }}{{ print "http://" .Values.textExtractor.nameOverride ":9398/v1/text_extractor" | quote }}{{ else }}""{{ end }}
  TEXT_COMPRESSION_ENDPOINT: {{ if not .Values.hierarchicalDataprep.enabled }}{{ print "http://" .Values.textCompression.nameOverride ":9397/v1/text_compression" | quote }}{{ else }}""{{ end }}
  TEXT_SPLITTER_ENDPOINT: {{ if not .Values.hierarchicalDataprep.enabled }}{{ print "http://" .Values.textSplitter.nameOverride ":9399/v1/text_splitter" | quote }}{{ else }}""{{ end }}
  LATE_CHUNKING_ENABLED: {{ .Values.lateChunking.enabled | quote }}
  LATE_CHUNKING_ENDPOINT: {{ if .Values.lateChunking.enabled }}{{ print "http://" .Values.lateChunking.nameOverride ":8003/v1/late_chunking" | quote }}{{ else }}""{{ end }}
  EMBEDDING_ENDPOINT: {{ if .Values.embedding.enabled }}{{ print "http://" .Values.embedding.nameOverride ":6000/v1/embeddings" | quote }}{{ else }}{{ .Values.embedding.remoteEmbeddingUri | quote }}{{ end }}
  INGESTION_ENDPOINT: {{ print "http://" .Values.ingestion.nameOverride ":6120/v1/ingestion" | quote }}
  RETRIEVER_ENDPOINT: http://retriever-svc.chatqa.svc:6620/v1/retrieval
  RERANKER_ENDPOINT: http://reranking-svc.chatqa.svc:8000/v1/reranking
  BUCKET_NAME_REGEX_FILTER: {{ .Values.bucketNameRegexFilter | quote }}
  DPGUARD_ENDPOINT: {{ if .Values.dpguard.enabled }}{{ print "http://" .Values.dpguard.nameOverride ":8070/v1/llmguarddataprep" | quote }}{{ else }}""{{ end }}
  DPGUARD_ENABLED: {{ .Values.dpguard.enabled | quote }}
  FINGERPRINT_ENDPOINT: "http://fingerprint-svc.fingerprint.svc:6012/v1/system_fingerprint/append_arguments"
  PRESIGNED_URL_CREDENTIALS_SYSTEM_FALLBACK: {{ .Values.presignedUrlCredentialsSystemFallback | quote }}
  {{- /* Query TorchServe configuration from chatqa namespace */ -}}
  {{- $torchserveReplicas := 1 }}
  {{- $torchserveBatchSize := 32 }}
  {{- $torchserveMaxWorkers := 4 }}
  {{- /* Lookup TorchServe deployment */ -}}
  {{- $torchserveDeployments := lookup "apps/v1" "Deployment" "chatqa" "" }}
  {{- if $torchserveDeployments }}
    {{- range $torchserveDeployments.items }}
      {{- if hasPrefix "torchserve-embedding-svc-" .metadata.name }}
        {{- $torchserveReplicas = .spec.replicas }}
      {{- end }}
    {{- end }}
  {{- end }}
  {{- /* Lookup TorchServe ConfigMap for batch size and workers */ -}}
  {{- $torchserveConfigMap := lookup "v1" "ConfigMap" "chatqa" "torchserve-embedding-config" }}
  {{- if $torchserveConfigMap }}
    {{- if $torchserveConfigMap.data.TORCHSERVE_BATCH_SIZE }}
      {{- $torchserveBatchSize = $torchserveConfigMap.data.TORCHSERVE_BATCH_SIZE | int }}
    {{- end }}
    {{- if $torchserveConfigMap.data.TORCHSERVE_MAX_WORKERS }}
      {{- $torchserveMaxWorkers = $torchserveConfigMap.data.TORCHSERVE_MAX_WORKERS | int }}
    {{- end }}
  {{- end }}
  {{- /* Calculate CELERY_BATCH_SIZE = replicas × max_workers × batch_size */ -}}
  {{- $celeryBatchSize := mul (mul $torchserveReplicas $torchserveMaxWorkers) $torchserveBatchSize }}
  CELERY_BATCH_SIZE: {{ $celeryBatchSize | quote }}
