# Copyright (C) 2024-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

apiVersion: v1
kind: ConfigMap
metadata:
  name: edp-configmap
  namespace: {{ .Release.Namespace }}
data:
  HIERARCHICAL_DATAPREP_ENDPOINT: {{ if .Values.hierarchicalDataprep.enabled }}{{ print "http://" .Values.hierarchicalDataprep.nameOverride ":9399/v1/hierarchical_dataprep" | quote }}{{ else }}""{{ end }}
  TEXT_EXTRACTOR_ENDPOINT: {{ if not .Values.hierarchicalDataprep.enabled }}{{ print "http://" .Values.textExtractor.nameOverride ":9398/v1/text_extractor" | quote }}{{ else }}""{{ end }}
  TEXT_COMPRESSION_ENDPOINT: {{ if not .Values.hierarchicalDataprep.enabled }}{{ print "http://" .Values.textCompression.nameOverride ":9397/v1/text_compression" | quote }}{{ else }}""{{ end }}
  TEXT_SPLITTER_ENDPOINT: {{ if not .Values.hierarchicalDataprep.enabled }}{{ print "http://" .Values.textSplitter.nameOverride ":9399/v1/text_splitter" | quote }}{{ else }}""{{ end }}
  LATE_CHUNKING_ENABLED: {{ .Values.lateChunking.enabled | quote }}
  LATE_CHUNKING_ENDPOINT: {{ if .Values.lateChunking.enabled }}{{ print "http://" .Values.lateChunking.nameOverride ":8003/v1/late_chunking" | quote }}{{ else }}""{{ end }}
  EMBEDDING_ENDPOINT: {{ if .Values.embedding.enabled }}{{ print "http://" .Values.embedding.nameOverride ":6000/v1/embeddings" | quote }}{{ else }}{{ .Values.embedding.remoteEmbeddingUri | quote }}{{ end }}
  INGESTION_ENDPOINT: {{ print "http://" .Values.ingestion.nameOverride ":6120/v1/ingestion" | quote }}
  RETRIEVER_ENDPOINT: http://retriever-svc.chatqa.svc:6620/v1/retrieval
  RERANKER_ENDPOINT: http://reranking-svc.chatqa.svc:8000/v1/reranking
  BUCKET_NAME_REGEX_FILTER: {{ .Values.bucketNameRegexFilter | quote }}
  DPGUARD_ENDPOINT: {{ if .Values.dpguard.enabled }}{{ print "http://" .Values.dpguard.nameOverride ":8070/v1/llmguarddataprep" | quote }}{{ else }}""{{ end }}
  DPGUARD_ENABLED: {{ .Values.dpguard.enabled | quote }}
  FINGERPRINT_ENDPOINT: "http://fingerprint-svc.fingerprint.svc:6012/v1/system_fingerprint/append_arguments"
  PRESIGNED_URL_CREDENTIALS_SYSTEM_FALLBACK: {{ .Values.presignedUrlCredentialsSystemFallback | quote }}
  USE_BEARER_TOKEN_AUTH: {{ .Values.useBearerTokenAuth | default "false" | quote }}
  {{- /* Query embedding service configuration from chatqa namespace */ -}}
  {{- $embeddingReplicas := 1 }}
  {{- $maxNewWorkers := 8 }}
  {{- $celeryBatchSize := 128 }}
  {{- /* Lookup deployments in chatqa namespace */ -}}
  {{- $deployments := lookup "apps/v1" "Deployment" "chatqa" "" }}
  {{- if $deployments }}
    {{- range $deployments.items }}
      {{- /* Check for vLLM or TorchServe embedding service */ -}}
      {{- if or (hasPrefix "vllm-embedding-svc-" .metadata.name) (hasPrefix "torchserve-embedding-svc-" .metadata.name) }}
        {{- $embeddingReplicas = .spec.replicas }}
      {{- end }}
    {{- end }}
  {{- end }}
  {{- /* Calculate MAX_NEW_WORKERS = replicas × 8 */ -}}
  {{- $maxNewWorkers = mul $embeddingReplicas 8 }}
  {{- /* Calculate CELERY_BATCH_SIZE = replicas × 128 */ -}}
  {{- $celeryBatchSize = mul $embeddingReplicas 128 }}
  MAX_NEW_WORKERS: {{ $maxNewWorkers | quote }}
  CELERY_BATCH_SIZE: {{ $celeryBatchSize | quote }}
