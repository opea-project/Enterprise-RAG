{{- define "postgresql_init_container" -}}
- name: wait-for-postgres
  image: postgres:18.0-alpine
  imagePullPolicy: IfNotPresent
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    runAsUser: 1000
  env:
    - name: VECTOR_STORE
      valueFrom:
        secretKeyRef:
          name: vector-database-config
          key: VECTOR_STORE
    - name: POSTGRES_URL
      valueFrom:
        secretKeyRef:
          name: vector-database-config
          key: POSTGRES_URL
    - name: POSTGRES_USERNAME
      valueFrom:
        secretKeyRef:
          name: vector-database-config
          key: POSTGRES_USERNAME
    - name: POSTGRES_DB
      valueFrom:
        secretKeyRef:
          name: vector-database-config
          key: POSTGRES_DB
    - name: POSTGRES_HOST
      valueFrom:
        secretKeyRef:
          name: vector-database-config
          key: POSTGRES_HOST
    - name: POSTGRES_PORT
      valueFrom:
        secretKeyRef:
          name: vector-database-config
          key: POSTGRES_PORT
  command:
    - sh
    - -c
    - |
        if [ -z "$POSTGRES_URL" ]; then
          echo "Environment variable POSTGRES_URL is not set. Skipping wait-for-postgres init container.";
          exit 1
        else
          POSTGRES_URL_OBFUSCATED=$(echo $POSTGRES_URL | sed -e 's|//.*:.*@|//********:********@|')
          until pg_isready -h "$POSTGRES_HOST" -p "$POSTGRES_PORT" -d "$POSTGRES_DB" -U "$POSTGRES_USERNAME"; do
            echo "waiting for postgres server $POSTGRES_URL_OBFUSCATED to be ready...";
            sleep 2;
          done;
        fi;
{{- end -}}
