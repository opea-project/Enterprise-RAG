{{- define "redis_init_container" -}}
- name: wait-for-redis
  image: redis:alpine
  imagePullPolicy: IfNotPresent
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    runAsUser: 1000
  env:
    - name: REDIS_URL
      valueFrom:
        secretKeyRef:
          name: vector-database-config
          key: REDIS_URL
    - name: VECTOR_STORE
      valueFrom:
        secretKeyRef:
          name: vector-database-config
          key: VECTOR_STORE
  command:
    - sh
    - -c
    - |
        if [ -z "$REDIS_URL" ]; then
          echo "Environment variable REDIS_URL is not set. Skipping wait-for-redis init container.";
          exit 1
        else
          REDIS_CLUSTER_FLAG=$([ "$VECTOR_STORE" = "redis-cluster" ] && echo "-c" || echo "")
          REDIS_URL_OBFUSCATED=$(echo $REDIS_URL | sed -e 's|//.*:.*@|//********:********@|')
          until redis-cli $REDIS_CLUSTER_FLAG -u "$REDIS_URL" ping | grep -q PONG; do
            echo "waiting for redis server $REDIS_URL_OBFUSCATED to be ready...";
            sleep 2;
          done;
        fi;
{{- end -}}
