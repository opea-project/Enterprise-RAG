# Copyright (C) 2024-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: {{ include "nri-balloons-controller.fullname" . }}-{{ .Values.webhook.mutatingWebhookConfiguration.name }}
  {{- if .Values.certManager.enabled }}
  annotations:
    cert-manager.io/inject-ca-from: {{ .Release.Namespace }}/{{ include "nri-balloons-controller.fullname" . }}-{{ .Values.certManager.certificate.name }}
  {{- end }}
  labels:
    {{- include "nri-balloons-controller.labels" . | nindent 4 }}
webhooks:
  - name: pod-mutator.nri-balloons-controller.intel.com
    clientConfig:
      service:
        name: {{ include "nri-balloons-controller.fullname" . }}-{{ .Values.webhook.service.name }}
        namespace: {{ .Release.Namespace }}
        path: "/mutate-v1-pod"
      {{- if not .Values.certManager.enabled }}
      caBundle: Cg==
      {{- end }}
    rules:
      - operations: ["CREATE"]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["pods"]
    admissionReviewVersions: ["v1", "v1beta1"]
    sideEffects: None
    timeoutSeconds: {{ .Values.webhook.mutatingWebhookConfiguration.timeoutSeconds }}
    failurePolicy: {{ .Values.webhook.mutatingWebhookConfiguration.failurePolicy }}
