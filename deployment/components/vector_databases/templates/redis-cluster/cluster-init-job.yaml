{{- /*
# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
*/ -}}
{{- if eq .Values.vectorStore "redis-cluster" }}
{{- $redisCluster := index .Values "redis-cluster" -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Namespace }}-redis-cluster-init
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation
  labels:
    app.kubernetes.io/name: redis-cluster
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: cluster-init
spec:
  backoffLimit: 10
  template:
    metadata:
      labels:
        app.kubernetes.io/name: redis-cluster
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: cluster-init
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ $redisCluster.serviceAccount.name }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
      - name: cluster-init
        image: "{{ $redisCluster.redis.image.repository }}:{{ $redisCluster.redis.image.tag | default "latest" }}"
        imagePullPolicy: {{ $redisCluster.redis.image.pullPolicy | default "IfNotPresent" }}
        securityContext:
          {{- toYaml .Values.securityContext | nindent 10 }}
        env:
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ $redisCluster.existingSecret }}
              key: {{ $redisCluster.existingSecretPasswordKey }}
        - name: CLUSTER_NODES
          value: {{ $redisCluster.cluster.nodes | quote }}
        - name: NAMESPACE
          value: {{ .Release.Namespace | quote }}
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: secrets
          mountPath: /secrets
          readOnly: true
        command:
        - sh
        - -c
        - |
          set -e
          
          echo "=== Redis Cluster Initialization ==="
          echo ""
          
          # Wait for all pods to be ready
          echo "Waiting for all Redis pods to be ready..."
          for i in $(seq 0 $((CLUSTER_NODES - 1))); do
            NODE_DNS="vdb-redis-cluster-${i}.vdb-redis-cluster-headless.${NAMESPACE}.svc.cluster.local"
            until redis-cli -h "$NODE_DNS" -a "$REDIS_PASSWORD" ping 2>/dev/null | grep -q PONG; do
              echo "  Waiting for ${NODE_DNS}..."
              sleep 2
            done
            echo "  ✅ ${NODE_DNS} is ready"
          done
          echo ""
          
          # Check if cluster already exists
          FIRST_NODE="vdb-redis-cluster-0.vdb-redis-cluster-headless.${NAMESPACE}.svc.cluster.local"
          CLUSTER_STATE=$(redis-cli -h "$FIRST_NODE" -a "$REDIS_PASSWORD" CLUSTER INFO 2>/dev/null | grep "cluster_state:" | cut -d':' -f2 | tr -d '\r\n ' || echo "")
          SLOTS_ASSIGNED=$(redis-cli -h "$FIRST_NODE" -a "$REDIS_PASSWORD" CLUSTER INFO 2>/dev/null | grep "cluster_slots_assigned:" | cut -d':' -f2 | tr -d '\r\n ' || echo "0")
          
          echo "Current cluster state: $CLUSTER_STATE"
          echo "Slots assigned: $SLOTS_ASSIGNED / 16384"
          echo ""
          
          # If cluster already has slots assigned, do nothing
          if [ "$SLOTS_ASSIGNED" -gt "0" ]; then
            echo "✅ Cluster already exists (has $SLOTS_ASSIGNED slots). Nothing to do."
            echo ""
            redis-cli -h "$FIRST_NODE" -a "$REDIS_PASSWORD" CLUSTER NODES 2>/dev/null
            exit 0
          fi
          
          # Create new cluster
          echo "No cluster detected. Creating new cluster..."
          echo ""
          
          # Build node list
          CLUSTER_IPS=""
          for i in $(seq 0 $((CLUSTER_NODES - 1))); do
            NODE_DNS="vdb-redis-cluster-${i}.vdb-redis-cluster-headless.${NAMESPACE}.svc.cluster.local"
            CLUSTER_IPS="$CLUSTER_IPS $NODE_DNS:6379"
          done
          
          echo "Creating cluster with nodes:$CLUSTER_IPS"
          echo ""
          
          redis-cli -a "$REDIS_PASSWORD" --cluster create $CLUSTER_IPS \
            --cluster-replicas 0 \
            --cluster-yes
          
          # Verify creation
          sleep 5
          FINAL_STATE=$(redis-cli -h "$FIRST_NODE" -a "$REDIS_PASSWORD" CLUSTER INFO 2>/dev/null | grep "cluster_state:" | cut -d':' -f2 | tr -d '\r\n ')
          FINAL_SLOTS=$(redis-cli -h "$FIRST_NODE" -a "$REDIS_PASSWORD" CLUSTER INFO 2>/dev/null | grep "cluster_slots_assigned:" | cut -d':' -f2 | tr -d '\r\n ')
          
          echo ""
          if [ "$FINAL_STATE" = "ok" ] && [ "$FINAL_SLOTS" = "16384" ]; then
            echo "✅ Cluster created successfully!"
            echo ""
            redis-cli -h "$FIRST_NODE" -a "$REDIS_PASSWORD" CLUSTER NODES 2>/dev/null
            exit 0
          else
            echo "❌ Cluster creation failed"
            exit 1
          fi
      volumes:
      - name: tmp
        emptyDir: {}
      - name: secrets
        secret:
          secretName: {{ $redisCluster.existingSecret }}
          items:
          - key: {{ $redisCluster.existingSecretPasswordKey }}
            path: password
{{- end }}
