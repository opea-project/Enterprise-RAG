# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

# resources-reference-cpu.yaml is a file that contains the resource requests and limits for each microservice in the microservices-connector deployment.

services:
  text-extractor-usvc:
    replicas: 2
    resources:
      requests:
        cpu: 4
        memory: 1Gi
      limits:
        cpu: 8
        memory: 8Gi
  text-compression-usvc:
    replicas: 1
    resources:
      requests:
        cpu: 0.5
        memory: 64Mi
      limits:
        cpu: 2
        memory: 1Gi
  text-splitter-usvc:
    replicas: 1
    resources:
      requests:
        cpu: 1
        memory: 1Gi
      limits:
        cpu: 4
        memory: 2Gi
  docsum-usvc:
    replicas: 1
    resources:
      requests:
        cpu: 1
        memory: 2Gi
      limits:
        cpu: 4
        memory: 4Gi
  llm-usvc:
    replicas: 2
    resources:
      requests:
        cpu: 1
        memory: 2Gi
      limits:
        cpu: 4
        memory: 6Gi
  vllm:
    replicas: 1
    # NOTE:
    # The resources block below is used for vllm ONLY if the balloons policy is NOT enabled.
    # If balloons policy is enabled, vllm resources must be defined in the inventory config.yaml as balloons.services.vllm.resources
    resources:
      requests:
        cpu: 32
        memory: 64Gi
      limits:
        cpu: 32
        memory: 100Gi
    hpa:
      minReplicas: 1
      maxReplicas: 2
        # setting max replicas to 2 as to get good performance numbers we need either to:
        #  use multinode and spread vllm instances accross the nodes or to pin the cores/memory to socket
      targetValue: 100m
      # average processing time of single token
      # 1/target value would mean tokens/sec
      # depends on used LLM model and hardware platform used
      # 'sum(rate(vllm:time_per_output_token_seconds_sum{service="vllm-service-m"}[1m])) by (<<.GroupBy>>) / (0.001 + sum(rate(vllm:time_per_output_token_seconds_count{service="vllm-service-m"}[1m])) by (<<.GroupBy>>))'
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 180
          policies:
          - type: Percent
            value: 25
            periodSeconds: 90
        scaleUp:
          selectPolicy: Max
          stabilizationWindowSeconds: 60
          policies:
          - type: Pods
            value: 1
            periodSeconds: 90
