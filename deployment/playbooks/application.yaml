# Copyright (C) 2024-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
- name: Install application
  hosts: localhost
  environment:
    K8S_AUTH_KUBECONFIG: >-
      {{
        kubeconfig if (kubeconfig is defined and kubeconfig != "" and kubeconfig != "FILL_HERE")
        else lookup('env', 'KUBECONFIG')
      }}
    KUSTOMIZE_HOME: "{{ playbook_dir }}/../renderer"
  vars_files:
    - "../version.yaml"
  vars:
    deployment_dir: "{{ playbook_dir }}/.."
    components_dir: "{{ deployment_dir }}/components"
    pipelines_dir: "{{ deployment_dir }}/pipelines/"
    log_dir: "{{ deployment_dir }}/ansible-logs"
    tmp_dir: "{{ log_dir }}/tmp"
    secure_logs: true
    tdx_post_renderer_executable: "{{ playbook_dir }}/../renderer/customize.sh"

    # Upload-optimized pipeline configuration (used when upload_pipelines=true)
    # This is the default configuration for upload mode, applied when upload_pipelines flag is set
    upload_pipelines_config:
      - namespace: chatqa
        samplePath: chatqa/reference-cpu-upload.yaml
        resourcesPath: chatqa/resources-reference-cpu-upload.yaml
        modelConfigPath: chatqa/resources-model-cpu.yaml
        type: chatqa

  pre_tasks:
    - name: Pre-configure environment role
      ansible.builtin.include_role:
        name: configure
      tags:
        - configure

    - name: Pre-install role
      ansible.builtin.include_role:
        name: pre_install
      tags:
        - install
        - display-configuration
        - uninstall
        - update-configuration
        - pre-upgrade

    - name: Override pipeline configuration for upload mode
      ansible.builtin.set_fact:
        pipelines: "{{ upload_pipelines_config }}"
      when: upload_pipelines | default(false) | bool
      tags:
        - always
        - update-configuration

    - name: Check deployment version and validate upgrade
      ansible.builtin.include_role:
        name: deployment_manifest
        tasks_from: check_version.yaml
      tags:
        - install
        - pre-upgrade
      when: not ansible_check_mode

    - name: Initial deployment manifest configuration
      ansible.builtin.include_role:
        name: deployment_manifest
      tags:
        - install
        - uninstall
        - pre-upgrade
      when: not ansible_check_mode

  tasks:
    - name: Pre-install health check
      ansible.builtin.include_role:
        name: check_pods
      vars:
        check_pods_no_wait: true
        check_pods_no_fail: true
        check_pods_store_result: true
      tags:
        - install
        - pre-upgrade

    - name: Store pre-install health check result
      set_fact:
        pre_install_health_check: "{{ check_pods_result }}"
      when: check_pods_result is defined
      tags:
        - install
        - pre-upgrade

    - name: Generate data consistency report
      ansible.builtin.include_role:
        name: data_consistency_check
      tags:
        - install
        - pre-upgrade
        - data-consistency

    - name: Build and push images
      ansible.builtin.include_role:
        name: images
      tags:
        - build-images

    - name: Verify TDX variables
      ansible.builtin.include_role:
        name: tdx
        tasks_from: verify_variables.yaml
        apply:
          tags:
            - pre-upgrade
      tags:
        - install
        - display-configuration
        - pre-upgrade

    - name: TDX Attest
      ansible.builtin.include_role:
        name: tdx
        tasks_from: attest.yaml
      tags:
        - install
      when: tdx.enabled and tdx.attestation.enabled

    - name: Install NRI balloons policy
      include_role:
        name: nri_balloons
      when: (balloons.enabled ) or "pre-upgrade" in ansible_run_tags
      tags:
        - install
        - uninstall
        - pre-upgrade
        - update-configuration
        - topology-preview

    - name: Clean-up NRI plugin resources if balloons disabled or upload mode
      include_role:
        name: nri_balloons
        tasks_from: uninstall.yaml
      when: not balloons.enabled
      tags:
        - install

    - name: Istio role
      ansible.builtin.include_role:
        name: istio
      when: istio.enabled
      tags:
        - install
        - uninstall

    - name: Enable Istio for namespaces in the solution
      ansible.builtin.include_role:
        name: istio
        tasks_from: configure.yaml
      when: istio.enabled
      tags:
        - install
        - uninstall

    - name: Run vector_databases role
      include_role:
        name: vector_databases
      when: vector_databases.enabled or "pre-upgrade" in ansible_run_tags
      tags:
        - install
        - uninstall
        - pre-upgrade

    - name: RAG Utils role
      ansible.builtin.include_role:
        name: rag_utils
      when: rag_utils.enabled
      tags:
        - install
        - uninstall

    - name: Fingerprint role
      ansible.builtin.include_role:
        name: fingerprint
      when: fingerprint.enabled or "pre-upgrade" in ansible_run_tags
      tags:
        - install
        - uninstall
        - pre-upgrade

    - name: Chat History role
      ansible.builtin.include_role:
        name: chat_history
      when: chat_history.enabled or "pre-upgrade" in ansible_run_tags
      tags:
        - install
        - uninstall
        - pre-upgrade

    - name: Audio role
      ansible.builtin.include_role:
        name: audio
      when: audio.enabled or "pre-upgrade" in ansible_run_tags
      tags:
        - install
        - uninstall
        - pre-upgrade

    - name: Pipeline role
      ansible.builtin.include_role:
        name: pipeline
      with_items: "{{ pipelines }}"
      tags:
        - install
        - uninstall
        - pre-upgrade
        - update-configuration

    - name: Ingress role
      ansible.builtin.include_role:
        name: ingress
      when: ingress.enabled or "pre-upgrade" in ansible_run_tags
      tags:
        - install
        - uninstall
        - pre-upgrade

    - name: Keycloak role
      ansible.builtin.include_role:
        name: keycloak
      when: keycloak.enabled or "pre-upgrade" in ansible_run_tags
      tags:
        - install
        - uninstall
        - pre-upgrade

    - name: Apisix role
      ansible.builtin.include_role:
        name: apisix
      when: apisix.enabled or "pre-upgrade" in ansible_run_tags
      tags:
        - install
        - uninstall
        - pre-upgrade

    - name: UI role
      ansible.builtin.include_role:
        name: ui
      when: ui.enabled or "pre-upgrade" in ansible_run_tags or "update-configuration" in ansible_run_tags
      tags:
        - install
        - uninstall
        - pre-upgrade
        - update-configuration

    - name: EDP role
      ansible.builtin.include_role:
        name: edp
      when: edp.enabled or "pre-upgrade" in ansible_run_tags or "update-configuration" in ansible_run_tags
      tags:
        - install
        - uninstall
        - pre-upgrade
        - update-configuration

    - name: Telemetry role
      ansible.builtin.include_role:
        name: telemetry
      when: telemetry.enabled
      tags:
        - install
        - uninstall

    - name: Configure APISIX
      ansible.builtin.include_role:
        name: apisix
        tasks_from: configure.yaml
      when: apisix.enabled or "pre-upgrade" in ansible_run_tags
      tags:
        - install
        - uninstall

    - name: Finalize deployment manifest
      ansible.builtin.include_role:
        name: deployment_manifest
        tasks_from: finalize_manifest.yaml
      tags:
        - install
        - uninstall
        - pre-upgrade
      when: not ansible_check_mode

    - name: Detect upgrade mode from tags
      set_fact:
        is_upgrade_mode: true
      when: "'pre-upgrade' in ansible_run_tags or 'test-upgrade' in ansible_run_tags"
      tags:
        - pre-upgrade
        - test-upgrade

    - name: Run metadata upgrade validation (pre-upgrade tag)
      ansible.builtin.include_tasks:
        file: "{{ playbook_dir }}/../roles/application/upgrade/tasks/metadata_upgrade.yaml"
        apply:
          tags:
            - pre-upgrade
            - test-upgrade
      tags:
        - pre-upgrade
        - test-upgrade

    - name: Generate pre-upgrade report
      ansible.builtin.include_role:
        name: upgrade
        tasks_from: pre_upgrade_report.yaml
        apply:
          tags:
            - pre-upgrade
            - test-upgrade
      tags:
        - pre-upgrade
        - test-upgrade

    - name: Evaluate pre-upgrade result
      ansible.builtin.include_role:
        name: upgrade
        tasks_from: upgrade_result.yaml
        apply:
          tags:
            - pre-upgrade
            - test-upgrade
      tags:
        - pre-upgrade
        - test-upgrade

    - name: Post-install health check
      ansible.builtin.include_role:
        name: check_pods
      vars:
        check_pods_no_fail: false
        check_pods_store_result: "{{ is_upgrade_mode | default(false) | bool }}"
      tags:
        - install
        - uninstall
        - update-configuration

    - name: Store post-install health check result
      set_fact:
        post_install_health_check: "{{ check_pods_result }}"
      when: is_upgrade_mode | default(false) | bool and check_pods_result is defined
      tags:
        - install

    - name: Evaluate upgrade health checks
      block:
        - name: Display post-upgrade health check status
          debug:
            msg: "Post-upgrade health check: {{ post_install_health_check.status }}"

        - name: Report upgrade health assessment
          debug:
            msg: >
              Upgrade health assessment: {{
                'SUCCESS - All pods are healthy' if post_install_health_check.status == 'success'
                else 'FAILED - Health check failed with ' ~ (post_install_health_check.undesirable_pods | length) ~ ' problematic pod(s)'
              }}

        - name: Fail if post-upgrade health check shows issues
          fail:
            msg: |
              Upgrade health check failed: System has unhealthy pods after deployment.

              Post-upgrade issues:
                - Undesirable pods: {{ post_install_health_check.undesirable_pods | length }}
                - Not ready containers: {{ post_install_health_check.not_ready_containers | length }}
                - Problematic pods: {{ post_install_health_check.undesirable_pods }}

              Please review and fix the deployment issues before proceeding.
          when: post_install_health_check.status != 'success'
      when: is_upgrade_mode | default(false) | bool and post_install_health_check is defined
      tags:
        - install

    # Post-tasks section (finalization and cleanup)

    - name: Generate post-upgrade data consistency report
      ansible.builtin.include_tasks:
        file: "{{ playbook_dir }}/../roles/application/data_consistency_check/tasks/post_upgrade_check.yaml"
        apply:
          tags:
            - install
      when: is_upgrade_mode | default(false) | bool and run_data_consistency_verification | default(true) | bool
      tags:
        - install

    - name: Verify data consistency between pre and post upgrade
      ansible.builtin.include_tasks:
        file: "{{ playbook_dir }}/../roles/application/data_consistency_check/tasks/verify_consistency.yaml"
        apply:
          tags:
            - install
      when: is_upgrade_mode | default(false) | bool and run_data_consistency_verification | default(true) | bool
      tags:
        - install

    - name: Generate upgrade summary report
      ansible.builtin.include_tasks:
        file: "{{ playbook_dir }}/../roles/application/upgrade/tasks/upgrade_summary.yaml"
        apply:
          tags:
            - install
      when: is_upgrade_mode | default(false) | bool
      tags:
        - install

    - name: Remove log directory
      ansible.builtin.file:
        path: "{{ log_dir }}"
        state: absent
      tags:
        - uninstall

    - name: Delete tmp directory
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
        mode: '755'
      loop:
        - "{{ tmp_dir }}"
      tags:
        - install
