# Copyright (C) 2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
# Phase 1: Pre-Upgrade Assessment
# Run from SOURCE deployment directory to validate upgrade readiness
#
# Required variables:
#   target_deployment_path: Path to target deployment directory
#   target_config_path: Path to target deployment's config.yaml
#
# Optional:
#   allow_upgrade_without_backup: Skip backup verification (default: false)
#   backup_max_age_hours: Maximum backup age in hours (default: 6)
#   within_rollback: Enable rollback guidance mode (default: false)

- name: Pre-Upgrade Assessment (Phase 1)
  hosts: localhost
  gather_facts: true
  environment:
    K8S_AUTH_KUBECONFIG: >-
      {{
        kubeconfig if (kubeconfig is defined and kubeconfig != "" and kubeconfig != "FILL_HERE")
        else lookup('env', 'KUBECONFIG')
      }}
  vars_files:
    - "../version.yaml"
  vars:
    deployment_dir: "{{ playbook_dir }}/.."
    log_dir: "{{ deployment_dir }}/ansible-logs"
    secure_logs: true
    backup_max_age_hours: 6
    allow_upgrade_without_backup: false
    within_rollback: false

  pre_tasks:
    - name: Validate target config is provided
      ansible.builtin.assert:
        that:
          - target_config_path is defined
          - target_config_path | length > 0
        fail_msg: |
          Required variable not provided:
            target_config_path: Path to target deployment's config.yaml

          The config can be in any of these locations:
            - <deployment>/inventory/<cluster>/config.yaml
            - <deployment>/config.yaml

          Example:
            ansible-playbook playbooks/pre_upgrade.yaml \
              -e target_config_path=/path/to/target/deployment/inventory/test-cluster/config.yaml \
              -e @inventory/test-cluster/config.yaml

    - name: Resolve target config path
      ansible.builtin.set_fact:
        target_config_resolved: "{{ target_config_path | realpath }}"

    - name: Validate target config exists
      ansible.builtin.stat:
        path: "{{ target_config_resolved }}"
      register: target_config_stat
      failed_when: not target_config_stat.stat.exists

    - name: Auto-resolve deployment path from config
      when: target_deployment_path is not defined or target_deployment_path | length == 0
      block:
        - name: Compute candidate deployment roots
          ansible.builtin.set_fact:
            candidate_roots:
              - "{{ target_config_resolved | dirname }}"
              - "{{ target_config_resolved | dirname | dirname }}"
              - "{{ target_config_resolved | dirname | dirname | dirname }}"

        - name: Check for version.yaml in candidate roots
          ansible.builtin.stat:
            path: "{{ item }}/version.yaml"
          register: version_checks
          loop: "{{ candidate_roots }}"

        - name: Find valid deployment root
          ansible.builtin.set_fact:
            target_deployment_path: "{{ item.item }}"
          when: item.stat.exists
          loop: "{{ version_checks.results }}"
          loop_control:
            label: "{{ item.item }}"

        - name: Fail if deployment root cannot be resolved
          ansible.builtin.fail:
            msg: |
              Cannot auto-resolve deployment path from config: {{ target_config_resolved }}

              Checked for version.yaml at:
              {% for root in candidate_roots %}
              - {{ root }}/version.yaml
              {% endfor %}

              Please provide target_deployment_path explicitly.

              Expected config locations:
              - <deployment>/inventory/<cluster>/config.yaml
              - <deployment>/config.yaml
          when: target_deployment_path is not defined or target_deployment_path | length == 0

    - name: Resolve paths
      ansible.builtin.set_fact:
        source_deployment_path: "{{ deployment_dir }}"
        target_deployment_resolved: "{{ target_deployment_path | realpath }}"

    - name: Validate target deployment exists
      ansible.builtin.stat:
        path: "{{ target_deployment_resolved }}"
      register: target_deploy_stat
      failed_when: not target_deploy_stat.stat.exists or not target_deploy_stat.stat.isdir

    - name: Load target version
      ansible.builtin.slurp:
        src: "{{ target_deployment_resolved }}/version.yaml"
      register: target_version_content

    - name: Parse target version
      ansible.builtin.set_fact:
        target_version_data: "{{ target_version_content.content | b64decode | from_yaml }}"
        source_version: "{{ solution_version }}"

    - name: Set target version
      ansible.builtin.set_fact:
        target_version: "{{ target_version_data.solution_version }}"

    - name: Pre-configure environment role
      ansible.builtin.include_role:
        name: configure

  tasks:
    - name: Display upgrade context
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "Pre-Upgrade Assessment (Phase 1)"
          - "========================================"
          - "Source deployment: {{ source_deployment_path }}"
          - "Source version: {{ source_version }}"
          - "Target deployment: {{ target_deployment_resolved }}"
          - "Target version: {{ target_version }}"
          - "Target config: {{ target_config_resolved }}"
          - "========================================"

    - name: Compare versions
      ansible.builtin.script:
        cmd: "{{ deployment_dir }}/roles/application/deployment_manifest/files/compare_versions.py"
      environment:
        DEPLOYED_VERSION: "{{ source_version }}"
        INSTALLING_VERSION: "{{ target_version }}"
      register: version_comparison
      changed_when: false

    - name: Parse version comparison
      ansible.builtin.set_fact:
        version_result: "{{ version_comparison.stdout | from_json }}"

    - name: Display detected mode
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "Upgrade Mode Detection Result"
          - "========================================"
          - "Mode: {{ version_result.mode | upper }}"
          - "Source: {{ version_result.deployed_version }}"
          - "Target: {{ version_result.installing_version }}"
          - "========================================"

    - name: Load target upgrade base version
      ansible.builtin.set_fact:
        target_upgrade_base_version: "{{ target_version_data.upgrade_base_version | default('') }}"

    - name: Block upgrade if target version does not support upgrades
      ansible.builtin.fail:
        msg: |
          ========================================
          Upgrade Not Supported
          ========================================
          Source version: {{ source_version }}
          Target version: {{ target_version }}

          The target version {{ target_version }} contains breaking changes
          and does not support upgrades from any previous version.

          Recommended approach:
          1. Backup your data using the backup workflow
          2. Perform a clean installation of version {{ target_version }}
          3. Restore your data from backup

          For detailed instructions, see: docs/upgrade.md
          ========================================
      when:
        - target_upgrade_base_version | length > 0
        - target_upgrade_base_version == 'unsupported'

    - name: Verify source version meets upgrade base requirement
      when:
        - target_upgrade_base_version | length > 0
        - target_upgrade_base_version != 'unsupported'
      block:
        - name: Compare source version with upgrade base version
          ansible.builtin.script:
            cmd: "{{ deployment_dir }}/roles/application/deployment_manifest/files/compare_versions.py"
          environment:
            DEPLOYED_VERSION: "{{ target_upgrade_base_version }}"
            INSTALLING_VERSION: "{{ source_version }}"
          register: base_version_result
          changed_when: false
          failed_when: false

        - name: Parse base version comparison
          ansible.builtin.set_fact:
            base_version_check: "{{ base_version_result.stdout | from_json }}"

        - name: Block upgrade if source version does not match exactly
          ansible.builtin.fail:
            msg: |
              ========================================
              Unsupported Upgrade Path
              ========================================
              Source version: {{ source_version }}
              Required exact version: {{ target_upgrade_base_version }}
              Target version: {{ target_version }}
              Detected mode: {{ base_version_check.mode }}

              {% if base_version_check.mode == 'downgrade' %}
              Your current deployment version ({{ source_version }}) is BELOW
              the required base version ({{ target_upgrade_base_version }}).

              To proceed:
              1. Upgrade to version {{ target_upgrade_base_version }} first
              2. Then upgrade to {{ target_version }}
              {% else %}
              Your current deployment version ({{ source_version }}) is ABOVE
              the required base version ({{ target_upgrade_base_version }}).

              This upgrade path is not supported. The upgrade from {{ source_version }}
              to {{ target_version }} must go through the exact base version.

              Please check the upgrade documentation or release notes for
              supported upgrade paths from version {{ source_version }}.
              {% endif %}

              For downgrade/restore scenarios, use backup/restore workflow.
              ========================================
          when: base_version_check.mode != 'refresh'

        - name: Display upgrade base version check result
          ansible.builtin.debug:
            msg:
              - "Upgrade base version check: PASSED"
              - "Source version: {{ source_version }} == Required: {{ target_upgrade_base_version }}"

    - name: Block downgrade
      ansible.builtin.fail:
        msg: |
          Downgrade blocked: {{ source_version }} -> {{ target_version }}
          Downgrades are not supported through the upgrade workflow.
          For recovery, use backup/restore workflow.
      when: version_result.mode == "downgrade"

    - name: Verify backup availability
      ansible.builtin.include_role:
        name: backup
        tasks_from: verify_backup.yaml
      when: not (allow_upgrade_without_backup | bool)

    - name: Skip backup verification warning
      ansible.builtin.debug:
        msg: "WARNING: Backup verification skipped (allow_upgrade_without_backup=true)"
      when: allow_upgrade_without_backup | bool

    - name: Pre-install health check
      ansible.builtin.include_role:
        name: check_pods
      vars:
        check_pods_no_wait: true
        check_pods_no_fail: true
        check_pods_store_result: true

    - name: Store pre-upgrade health status
      ansible.builtin.set_fact:
        pre_upgrade_health: "{{ check_pods_result | default({'status': 'unknown'}) }}"

    - name: Determine assessment result
      ansible.builtin.set_fact:
        pre_upgrade_passed: "{{ pre_upgrade_health.status | default('unknown') == 'success' }}"
        pre_upgrade_warnings: []

    - name: Add health warning if needed
      ansible.builtin.set_fact:
        pre_upgrade_warnings: "{{ pre_upgrade_warnings + ['Health check has issues'] }}"
      when: pre_upgrade_health.status | default('unknown') != 'success'

    - name: Display rollback instructions
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "Rollback Instructions (if needed)"
          - "========================================"
          - "If issues occur after upgrade, execute these steps:"
          - ""
          - "Step 1 - Uninstall target deployment:"
          - "  cd {{ target_deployment_resolved }}"
          - "  ansible-playbook playbooks/application.yaml --tags uninstall -e @{{ target_config_resolved }}"
          - ""
          - "Step 2 - Reinstall source deployment:"
          - "  cd {{ source_deployment_path }}"
          - "  ansible-playbook playbooks/application.yaml --tags install -e @<source-config.yaml>"
          - ""
          - "Step 3 - Restore from backup:"
          - "  cd {{ source_deployment_path }}"
          - "  ansible-playbook playbooks/backup.yaml --tags restore -e @<source-config.yaml> -e velero.restore_from=<backup-name>"
          - ""
          - "Note: Execute each step from the CORRECT deployment directory"
          - "========================================"

    - name: Display Phase 1 assessment result
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "Pre-Upgrade Assessment Complete"
          - "========================================"
          - "Status: {{ 'READY' if pre_upgrade_passed else 'WARNINGS' }}"
          - "Mode: {{ version_result.mode | upper }}"
          - "Version: {{ source_version }} -> {{ target_version }}"
          - "Health: {{ pre_upgrade_health.status | default('unknown') }}"
          - "Warnings: {{ pre_upgrade_warnings | length }}"
          - "========================================"
          - ""
          - "{% if pre_upgrade_passed %}To proceed with upgrade (Phase 2):{% else %}Review warnings, then proceed:{% endif %}"
          - "  cd {{ target_deployment_resolved }}"
          - "  ansible-playbook playbooks/application.yaml --tags install -e @{{ target_config_resolved }}"
          - "========================================"

    - name: Rollback guidance mode
      when: within_rollback | bool
      block:
        - name: Verify rollback execution location
          ansible.builtin.debug:
            msg:
              - "========================================"
              - "Rollback Guidance Mode Active"
              - "========================================"
              - "Current location: {{ source_deployment_path }}"
              - ""
              - "For UNINSTALL: Run from TARGET deployment ({{ target_deployment_resolved }})"
              - "For INSTALL/RESTORE: Run from SOURCE deployment (here - {{ source_deployment_path }})"
              - "========================================"
