# Copyright (C) 2024-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
- name: Set override_values.yaml path
  ansible.builtin.set_fact:
    apisix_helm_override_values_path: "{{ log_dir }}/{{ apisix.helm.chart_name }}-override-values.yaml"
    apisix_routes_helm_override_values_path: "{{ log_dir }}/{{ apisix_routes.helm.chart_name }}-override-values.yaml"
  tags:
    - install

- name: Gather existing namespaces
  kubernetes.core.k8s_info:
    kind: Namespace
  register: k8s_namespaces
  when: apisix.enabled
  tags:
    - install

- name: Set list of existing namespace names
  ansible.builtin.set_fact:
    existing_namespaces: "{{ k8s_namespaces.resources | map(attribute='metadata.name') | list }}"
  when: apisix.enabled
  tags:
    - install

- name: Load default values from apisix routes values.yaml
  include_vars:
    file: "{{ apisix_routes.helm.default_values_file }}"
    name: apisix_routes_raw_config
  when: apisix.enabled
  tags:
    - install

- name: Generate dynamic pipeline endpoints from pipelines configuration
  ansible.builtin.set_fact:
    dynamic_pipeline_endpoints: >-
      {{
        dynamic_pipeline_endpoints | default([]) + [{
          'name': ('chatqna' if item.namespace == 'chatqa' else item.namespace),
          'enabled': true,
          'namespace': item.namespace,
          'path': '/api/v1/' ~ ('chatqna' if item.namespace == 'chatqa' else item.namespace),
          'backend_service': 'router-service',
          'service_port': 8080,
          'service_path': '/',
          'rate_limit_count': 30,
          'permissions': ['admin#admin-access', 'user#user-access']
        }]
      }}
  loop: "{{ pipelines | default([]) }}"
  loop_control:
    label: "{{ item.namespace }}"
  when:
    - apisix.enabled
    - pipelines is defined
  tags:
    - install

- name: Merge dynamic pipeline endpoints with default endpoints
  ansible.builtin.set_fact:
    apisix_routes_raw_config: >-
      {{
        apisix_routes_raw_config | combine({
          'endpoints': apisix_routes_raw_config.endpoints + (dynamic_pipeline_endpoints | default([]))
        }, recursive=True)
      }}
  when:
    - apisix.enabled
    - dynamic_pipeline_endpoints is defined
  tags:
    - install

- name: Generate dynamic API watcher endpoints from pipelines configuration
  ansible.builtin.set_fact:
    dynamic_api_endpoints: >-
      {{
        dynamic_api_endpoints | default([]) + [{
          'name': 'k8s-api-watcher-' ~ item.namespace,
          'namespace': 'default',
          'path': '/api/v1/' ~ item.namespace ~ '/status',
          'backend_service': 'kubernetes',
          'rate_limit_count': 30,
          'service_port': 443,
          'scheme': 'https',
          'service_path': '/apis/gmc.opea.io/v1alpha3/namespaces/' ~ item.namespace ~ '/gmconnectors/' ~ item.namespace ~ '/status',
          'permissions': ['admin#admin-access']
        }]
      }}
  loop: "{{ pipelines | default([]) }}"
  loop_control:
    label: "{{ item.namespace }}"
  when:
    - apisix.enabled
    - pipelines is defined
  tags:
    - install

- name: Merge dynamic API watcher endpoints with default endpoints_api
  ansible.builtin.set_fact:
    apisix_routes_raw_config: >-
      {{
        apisix_routes_raw_config | combine({
          'endpoints_api': apisix_routes_raw_config.endpoints_api + (dynamic_api_endpoints | default([]))
        }, recursive=True)
      }}
  when:
    - apisix.enabled
    - dynamic_api_endpoints is defined
  tags:
    - install

- name: Filter endpoints with existing namespaces
  ansible.builtin.set_fact:
    filtered_endpoints: >-
      {{
        apisix_routes_raw_config.endpoints | selectattr("namespace", "in", existing_namespaces) | list
      }}
  when: apisix.enabled
  tags:
    - install

- name: Write override values to enable only endpoints in existing namespaces
  copy:
    dest: "{{ apisix_routes_helm_override_values_path }}"
    content: |
      endpoints:
      {% for item in apisix_routes_raw_config.endpoints %}
        - name: {{ item.name }}
          enabled: {{ 'true' if item.namespace in existing_namespaces else 'false' }}
      {% endfor %}
  when: apisix.enabled
  tags:
    - install

- name: Deep merge default and override endpoints by name
  ansible.builtin.set_fact:
    merged_endpoints: "{{ merged_endpoints | default([]) + [updated_endpoint] }}"
  vars:
    # Use apisix_routes_raw_config which already has dynamic endpoints merged
    default_endpoints: "{{ apisix_routes_raw_config.endpoints }}"
    override_map: >-
      {{
        (lookup('file', apisix_routes_helm_override_values_path) | from_yaml)
        .endpoints | default([]) | items2dict(key_name='name', value_name='enabled')
      }}
    updated_endpoint: "{{ item | combine({'enabled': override_map[item.name] | default(item.enabled)}) }}"
  loop: "{{ default_endpoints }}"
  loop_control:
    label: "{{ item.name }}"
  when: apisix.enabled
  tags:
    - install

- name: Merge full values structure with updated endpoints
  set_fact:
    merged_apisix_values: >-
      {{
        apisix_routes_raw_config
        | combine({'endpoints': merged_endpoints}, recursive=True)
      }}
  when: apisix.enabled
  tags:
    - install

- name: Install apisix routes
  kubernetes.core.helm:
    name: "{{ apisix_routes.helm.release_name }}"
    chart_ref: "{{ apisix_routes.helm.chart_directory }}"
    namespace: "{{ apisix_routes.namespace }}"
    values: "{{ merged_apisix_values }}"
    state: present
    force: true
  when: apisix.enabled
  tags:
    - install

- name: Delete apisix routes
  kubernetes.core.helm:
    name: "{{ apisix_routes.helm.release_name }}"
    chart_ref: "{{ apisix_routes.helm.chart_directory }}"
    namespace: "{{ apisix_routes.namespace }}"
    state: absent
  when: apisix.enabled
  tags:
    - uninstall

# temporary until we split apisix routes per component
- name: Delete ApisixUpstream resources from default namespace
  kubernetes.core.k8s:
    api_version: apisix.apache.org/v2
    kind: ApisixUpstream
    name: kubernetes-api-upstream
    namespace: default
    state: absent
  ignore_errors: true
  when: apisix.enabled
  tags:
    - uninstall

# temporary until we split apisix routes per component
- name: Delete dynamic ApisixRoute resources from default namespace (k8s API watchers)
  kubernetes.core.k8s:
    api_version: apisix.apache.org/v2
    kind: ApisixRoute
    name: "k8s-api-watcher-{{ item.namespace }}-route"
    namespace: default
    state: absent
  loop: "{{ pipelines | default([]) }}"
  loop_control:
    label: "{{ item.namespace }}"
  ignore_errors: true
  when:
    - apisix.enabled
    - pipelines is defined
  tags:
    - uninstall
