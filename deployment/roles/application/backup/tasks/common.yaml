# Copyright (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
- name: Verify if velero is enabled for backup and restore operations
  ansible.builtin.fail:
    msg: Velero must be enabled for backup and restore operations.
  when: not velero.enabled

- name: Set default velero namespace if not defined
  ansible.builtin.set_fact:
    velero: "{{ velero | combine({'namespace': 'velero'}) }}"
  when: velero.namespace is not defined

- name: Check if velero namespace exists
  kubernetes.core.k8s_info:
    kind: Namespace
    name: "{{ velero.namespace }}"
  register: velero_namespace_info
  failed_when: false

- name: Fail if velero namespace does not exist
  ansible.builtin.fail:
    msg: |
      Velero namespace '{{ velero.namespace }}' does not exist.

      Please install Velero using one of the following methods:
      1. Using our infrastructure playbook:
         ansible-playbook playbooks/infrastructure.yaml --tags post-install -e velero.enabled=true
      2. Using Velero CLI:
         velero install --provider <your-provider> --bucket <your-bucket> ...
      3. Using Helm:
         helm install velero vmware-tanzu/velero --namespace {{ velero.namespace }} --create-namespace ...
  when: velero_namespace_info.resources | length == 0

- name: Check if Velero CRDs are installed
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: "{{ item }}"
  register: velero_crd_check
  failed_when: false
  loop:
    - backups.velero.io
    - restores.velero.io
    - backupstoragelocations.velero.io
    - volumesnapshotlocations.velero.io

- name: Gather missing CRDs
  ansible.builtin.set_fact:
    missing_crds: "{{ velero_crd_check.results | selectattr('resources', 'equalto', []) | map(attribute='item') | list }}"

- name: Fail if Velero CRDs are not installed
  ansible.builtin.fail:
    msg: |
      The following Velero CRDs are not installed: {{ missing_crds | join(', ') }}

      This error typically occurs when:
      1. Velero is not installed
      2. Velero installation is incomplete
      3. Velero CRDs were not properly created

      Please ensure Velero CRDs are installed. They should be created automatically during Velero installation.
      To verify: kubectl get crd | grep velero
  when: missing_crds | length > 0

- name: Wait for velero pods to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ velero.namespace }}"
    label_selectors: >-
      {{ velero.velero_pod_labels.keys() | zip(velero.velero_pod_labels.values()) | map('join', '=') | list }}
  register: velero_pods_info
  until: >
    velero_pods_info.resources | length > 0 and
    velero_pods_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0 and
    velero_pods_info.resources[0].status.containerStatuses | default([]) | selectattr('ready', 'equalto', true) | list | length > 0
  retries: 30
  delay: 10
  failed_when: false

- name: Fail if velero pods are not ready
  ansible.builtin.fail:
    msg: |
      Velero pods are not ready in namespace '{{ velero.namespace }}'.

      Current state:
      {% if velero_pods_info.resources | length == 0 %}
      - No Velero pods found
      {% else %}
      {% for pod in velero_pods_info.resources %}
      - Pod: {{ pod.metadata.name }}
        Status: {{ pod.status.phase }}
        Ready: {{ pod.status.containerStatuses | default([]) | selectattr('ready', 'equalto', true) | list | length }}/{{ pod.status.containerStatuses | default([]) | length }}
      {% endfor %}
      {% endif %}

      Please ensure Velero is properly installed and all pods are running and ready.
      Check pod logs with: kubectl logs -n {{ velero.namespace }} -l app.kubernetes.io/name=velero
  when: >
    velero_pods_info.resources | length == 0 or
    velero_pods_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == 0 or
    velero_pods_info.resources[0].status.containerStatuses | default([]) | selectattr('ready', 'equalto', true) | list | length == 0

- name: Check Velero BackupStorageLocation status
  kubernetes.core.k8s_info:
    api_version: velero.io/v1
    kind: BackupStorageLocation
    namespace: "{{ velero.namespace }}"
  register: bsl_info
  failed_when: false

- name: Fail if no BackupStorageLocation is configured
  ansible.builtin.fail:
    msg: |
      No BackupStorageLocation found in namespace '{{ velero.namespace }}'.
      Velero requires at least one BackupStorageLocation to be configured.

      To configure storage location:
      - Check existing locations: kubectl get backupstoragelocations -n {{ velero.namespace }}
      - If none exist, you may need to reinstall Velero with proper storage configuration
      - Or create a BackupStorageLocation manually: kubectl apply -f <bsl-config.yaml>
  when: bsl_info.resources | length == 0

- name: Check if BackupStorageLocation is available
  ansible.builtin.set_fact:
    bsl_unavailable: "{{ bsl_info.resources | rejectattr('status.phase', 'equalto', 'Available') | list }}"

- name: Warn if BackupStorageLocation is not available
  ansible.builtin.debug:
    msg: |
      WARNING: Some BackupStorageLocations are not in Available state:
      {% for bsl in bsl_unavailable %}
      - {{ bsl.metadata.name }}: {{ bsl.status.phase | default('Unknown') }}
      {% endfor %}

      Backup/restore operations may fail if storage is not accessible.
  when: bsl_unavailable | length > 0

- name: Display Velero readiness confirmation
  ansible.builtin.debug:
    msg: |
      Velero validation successful:
        - Namespace: {{ velero.namespace }}
        - CRDs: Installed
        - Pods: {{ velero_pods_info.resources | length }} running
        - BackupStorageLocation: {{ bsl_info.resources | length }} configured

      Ready to proceed with backup/restore operations.
