# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Set override_values.yaml path
  ansible.builtin.set_fact:
    chat_history_helm_override_values_path: >-
      {{ tmp_dir }}/{{ chat_history.helm.release_name }}-override-values.yaml
  tags:
    - install

- name: Build Helm chart dependencies
  ansible.builtin.command:
    cmd: helm dependency build
    chdir: "{{ chat_history.helm.chart_directory }}"
  register: helm_repo_add_result
  until: helm_repo_add_result is succeeded
  retries: 5
  delay: 15
  tags:
    - install

- name: Generate password
  ansible.builtin.include_role:
    name: generate_password
    tasks_from: generate_password.yaml
  loop:
    - name: CHAT_HISTORY_POSTGRES
      user: "{{ chat_history.database.auth.user.db_user }}"
  tags:
    - install

# Creates chatqa_namespace
- name: Get chatqa namespace
  ansible.builtin.include_role:
    name: utils
    tasks_from: get_chatqa_namespace.yaml
  tags:
    - install

- name: Ensure namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ item }}"
  loop:
    - "{{ chat_history.namespace }}"
    - "{{ chatqa_namespace }}"
  tags:
    - install

- name: Enforce PSS
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ chat_history.namespace }}"
        labels:
          pod-security.kubernetes.io/enforce: "restricted"
  when: enforcePSS
  tags:
    - install

- name: Create password secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ chat_history.database.auth.password_secret_name }}"
        namespace: "{{ item }}"
      data:
        POSTGRES_PASSWORD: "{{ CHAT_HISTORY_POSTGRES_PASSWORD | b64encode }}"
        POSTGRES_USER: >-
          {{ chat_history.database.auth.user.db_user | b64encode }}
        POSTGRES_DB: "{{ 'postgres' | b64encode }}"
  no_log: "{{ secure_logs }}"
  loop:
    - "{{ chat_history.namespace }}"
  tags:
    - install

- name: Generate override values file from template
  ansible.builtin.template:
    src: "values.yaml.j2"
    dest: "{{ chat_history_helm_override_values_path }}"
    mode: '0644'
  tags:
    - install

- name: Set values_files list
  ansible.builtin.set_fact:
    values_files: >
      {{
        [chat_history.helm.default_values_file] +
        ([chat_history.helm.tdx_resources_file]
        if (tdx.coco.enabled | bool) else []) +
        [chat_history_helm_override_values_path]
      }}
  tags:
    - install

- name: Install or Upgrade Helm chart
  kubernetes.core.helm:
    name: "{{ chat_history.helm.release_name }}"
    chart_ref: "{{ chat_history.helm.chart_directory }}"
    namespace: "{{ chat_history.namespace }}"
    values_files: "{{ values_files }}"
    state: present
    create_namespace: true
    timeout: "{{ helm_timeout }}"
#    This can replace chart and template based deployments with TDX
#    post_renderer:
#      "{{ tdx_post_renderer_executable ~
#       ' --post-renderer-args \"' ~ chat_history.namespace ~
#       ' ' ~ KBS_ADDRESS ~ '\"'
#       if tdx.coco.enabled else omit }}"
  register: helm_repo_install_result
  until: helm_repo_install_result is succeeded
  retries: 5
  delay: 15
  tags:
    - install

- name: Mark secret for password management
  ansible.builtin.include_role:
    name: password_mgmt
    tasks_from: markup.yaml
    apply:
      tags:
        - install
  vars:
    namespace: "{{ chat_history.namespace }}"
    secret_name: "{{ chat_history.database.auth.password_secret_name }}"
    password_mappings:
      - key: POSTGRES_PASSWORD
        variable: CHAT_HISTORY_POSTGRES_PASSWORD
        user: "{{ chat_history.database.auth.user.db_user }}"
  tags:
    - install

- name: Uninstall Helm chart
  kubernetes.core.helm:
    name: "{{ chat_history.helm.release_name }}"
    namespace: "{{ chat_history.namespace }}"
    state: absent
  tags:
    - uninstall

- name: Delete namespace
  kubernetes.core.k8s:
    state: absent
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ chat_history.namespace }}"
  tags:
    - uninstall
