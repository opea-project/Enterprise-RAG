# Copyright (C) 2024-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Main block for role execution
  block:
    - name: Increment verification attempt counter
      set_fact:
        execution_counter: "{{ (execution_counter | default(0) | int) + 1 }}"
      tags:
        - install
        - restore
        - uninstall
        - update-configuration

    - name: Define operation_mode
      set_fact:
        operation_mode: >-
          {{
            'install' if 'install' in ansible_run_tags
            or 'restore' in ansible_run_tags
            or 'update-configuration' in ansible_run_tags else
            'uninstall' if 'uninstall' in ansible_run_tags
          }}
      tags:
        - install
        - restore
        - uninstall
        - update-configuration

    - name: Include tasks to get enabled namespaces
      ansible.builtin.include_role:
        name: utils
        tasks_from: get_namespaces.yaml
      tags:
        - install
        - restore
        - uninstall
        - update-configuration

    - name: Get all namespaces
      kubernetes.core.k8s_info:
        kind: Namespace
      register: namespaces_info
      tags:
        - install
        - restore
        - uninstall
        - update-configuration

    - name: Compare enabled namespaces with existing namespaces
      set_fact:
        missing_namespaces: >-
          {{
            enabled_namespaces | unique |
            difference(namespaces_info.resources | map(attribute='metadata.name') | list)
          }}
      tags:
        - install
        - restore
        - uninstall
        - update-configuration

    - name: Get pods in enabled namespaces
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ item }}"
      with_items: "{{ enabled_namespaces | unique }}"
      when: item in (namespaces_info.resources | map(attribute='metadata.name') | list)
      register: pods_info
      tags:
        - install
        - restore
        - uninstall
        - update-configuration

    - name: Identify empty namespaces
      set_fact:
        empty_namespaces: >-
          {{
            pods_info.results | selectattr('resources', 'defined') |
            selectattr('resources', 'equalto', []) |
            map(attribute='item') | list
          }}
      tags:
        - install
        - restore
        - uninstall
        - update-configuration

    - name: Identify containers with "not ready" status
      set_fact:
        not_ready_containers: >-
          {%- set result = [] -%}
          {%- for pod in pods_info.results |
                selectattr('resources', 'defined') |
                rejectattr('resources', 'equalto', []) |
                map(attribute='resources') | flatten |
                selectattr('status.phase', 'equalto', 'Running') -%}
            {%- for container in pod.status.containerStatuses | default([]) -%}
              {%- if not container.ready -%}
                {%- set _ = result.append({'pod': pod.metadata.name, 'container': container.name}) -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
          {{ result }}
      tags:
        - install
        - restore
        - update-configuration

    - name: Filter out Job pods from verification
      set_fact:
        all_pods: >-
          {{
            pods_info.results | selectattr('resources', 'defined') |
            rejectattr('resources', 'equalto', []) |
            map(attribute='resources') | flatten | list
          }}
      tags:
        - install
        - restore
        - uninstall
        - update-configuration

    - name: Verify pods based on operation_mode
      set_fact:
        undesirable_pods: >-
          {%- set result = [] -%}
          {%- for pod in all_pods -%}
            {%- set is_job_pod = pod.metadata.ownerReferences | default([]) | selectattr('kind', 'equalto', 'Job') | list | length > 0 -%}
            {%- if operation_mode == 'install' -%}
              {%- if not is_job_pod and pod.status.phase not in ['Running', 'Succeeded'] -%}
                {%- set _ = result.append(pod.metadata.name) -%}
              {%- endif -%}
            {%- else -%}
              {%- if not is_job_pod -%}
                {%- set _ = result.append(pod.metadata.name) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ result }}
      tags:
        - install
        - restore
        - uninstall
        - update-configuration

    - name: Store health check result
      set_fact:
        check_pods_result:
          status: >-
            {{
              'failed' if (
                (operation_mode == 'install' and not_ready_containers | length > 0) or
                (operation_mode == 'install' and undesirable_pods | length > 0) or
                (operation_mode == 'uninstall' and undesirable_pods | length > 0) or
                (operation_mode == 'install' and missing_namespaces | length > 0) or
                (empty_namespaces | length > 0)
              ) else 'success'
            }}
          not_ready_containers: "{{ not_ready_containers | default([]) }}"
          undesirable_pods: "{{ undesirable_pods | default([]) }}"
          empty_namespaces: "{{ empty_namespaces | default([]) }}"
          missing_namespaces: "{{ missing_namespaces | default([]) }}"
      when: check_pods_store_result | bool
      tags:
        - install
        - restore
        - uninstall
        - pre-upgrade

    - name: Failure summary message
      fail:
        msg: >-
          {{
            (
              ("The following pods contain not ready containers:" ~ not_ready_containers
              if operation_mode == 'install' and not_ready_containers | length > 0 else "") +
              ("The following pods are not in running or succeeded state:" ~ undesirable_pods
              if operation_mode == 'install' and undesirable_pods | length > 0 else
              "The following pods are still present in the cluster:" ~ undesirable_pods
              if operation_mode == 'uninstall' and undesirable_pods | length > 0 else "") +
              ("The following namespaces have zero pods and are not terminated:" ~ empty_namespaces
              if empty_namespaces | length > 0 else "") +
              ("The following namespaces are missing:" ~ missing_namespaces
              if operation_mode == 'install' and missing_namespaces | length > 0 else "")
            ) | trim
          }}
      when: (not check_pods_no_fail | bool) and (
            (operation_mode == 'install' and not_ready_containers | length > 0) or
            (operation_mode == 'install' and undesirable_pods | length > 0) or
            (operation_mode == 'uninstall' and undesirable_pods | length > 0) or
            (operation_mode == 'install' and missing_namespaces | length > 0) or
            (empty_namespaces | length > 0))
      tags:
        - install
        - restore
        - uninstall
        - update-configuration

    - name: Success summary message
      debug:
        msg: >-
          {{
            "All pods are in running or succeeded state."
            if operation_mode == 'install' else
            "All pods from enabled namespaces have been removed from the cluster."
          }}
      when: (operation_mode == 'install' and undesirable_pods | length == 0) or
            (operation_mode == 'uninstall' and undesirable_pods | length == 0)
      tags:
        - install
        - restore
        - uninstall
        - update-configuration

  rescue:
    - name: Store health check result on rescue
      set_fact:
        check_pods_result:
          status: 'failed'
          error: "Role execution failed after {{ execution_counter | default(1) }} attempts."
          not_ready_containers: "{{ not_ready_containers | default([]) }}"
          undesirable_pods: "{{ undesirable_pods | default([]) }}"
          empty_namespaces: "{{ empty_namespaces | default([]) }}"
          missing_namespaces: "{{ missing_namespaces | default([]) }}"
      when: check_pods_store_result | bool
      tags:
        - install
        - restore
        - uninstall
        - pre-upgrade

    - name: Return failed status after maximum retries
      fail:
        msg: "Role execution failed after {{ check_pods_role_retries | default(5) }} attempts."
      when: (not check_pods_no_fail | bool) and (execution_counter | int) >= (check_pods_role_retries | default(5) if not check_pods_no_wait | bool else 1)
      tags:
        - install
        - restore
        - uninstall
        - update-configuration

    - name: Wait 60 seconds before retry
      pause:
        seconds: 60
      when: (not check_pods_no_wait | bool) and (execution_counter | int) < (check_pods_role_retries | default(5))
      tags:
        - install
        - restore
        - uninstall
        - update-configuration

    - name: Retry the role on failure
      include_role:
        name: check_pods
      when: (not check_pods_no_wait | bool) and (execution_counter | int) < (check_pods_role_retries | default(5))
      tags:
        - install
        - restore
        - uninstall
        - update-configuration
