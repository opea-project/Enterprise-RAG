# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Check Fingerprint data consistency
  tags:
    - pre-upgrade
    - data-consistency
  block:
    - name: Get Fingerprint MongoDB deployment name
      kubernetes.core.k8s_info:
        kind: StatefulSet
        namespace: "{{ fingerprint.namespace }}"
        label_selectors:
          - app.kubernetes.io/name=fingerprint-mongodb-postgresql
          - app.kubernetes.io/instance=fingerprint
      register: fingerprint_mongodb_deployment

    - name: Get Fingerprint MongoDB pod name
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ fingerprint.namespace }}"
        label_selectors:
          - app.kubernetes.io/name=fingerprint-mongodb-postgresql
          - app.kubernetes.io/instance=fingerprint
      register: fingerprint_mongodb_pods

    - name: Set Fingerprint MongoDB pod name
      ansible.builtin.set_fact:
        fingerprint_mongodb_pod: "{{ fingerprint_mongodb_pods.resources[0].metadata.name }}"
        fingerprint_mongodb_deployment_name: "{{ fingerprint_mongodb_deployment.resources[0].metadata.name if fingerprint_mongodb_deployment.resources else 'fingerprint-mongodb' }}"
      when: fingerprint_mongodb_pods.resources | length > 0

    - name: Query database
      no_log: "{{ secure_logs }}"
      block:
        - name: Query MongoDB for number of collections (using PostgreSQL backend with environment)
          kubernetes.core.k8s_exec:
            namespace: "{{ fingerprint.namespace }}"
            pod: "{{ fingerprint_mongodb_pod }}"
            command: >
              bash -c 'export PGPASSWORD="$POSTGRES_PASSWORD"; psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -t -c "SELECT COUNT(DISTINCT table_name) FROM information_schema.tables WHERE table_schema NOT IN ('"'"'pg_catalog'"'"', '"'"'information_schema'"'"', '"'"'_ferretdb_'"'"');"'
          register: fingerprint_collections_count
          when: fingerprint_mongodb_pod is defined

    - name: Set Fingerprint MongoDB data consistency facts
      ansible.builtin.set_fact:
        fingerprint_collections_total: "{{ fingerprint_collections_count.stdout | trim | default('0') }}"
      when: fingerprint_mongodb_pod is defined

    - name: Save Fingerprint data to facts for YAML report
      ansible.builtin.set_fact:
        fingerprint_report_data:
          component: "{{ fingerprint_mongodb_deployment_name }}"
          collections_count: "{{ fingerprint_collections_total | int }}"
      when: fingerprint_mongodb_pod is defined
