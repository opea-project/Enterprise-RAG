# Copyright (C) 2024-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Check SeaweedFS data consistency
  tags:
    - pre-upgrade
    - data-consistency
  block:
    - name: Get SeaweedFS deployment name
      kubernetes.core.k8s_info:
        kind: StatefulSet
        namespace: "{{ edp.seaweedfs.namespace }}"
        label_selectors:
          - app.kubernetes.io/name=seaweedfs
      register: seaweedfs_deployment

    - name: Get SeaweedFS filer pod name
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ edp.seaweedfs.namespace }}"
        label_selectors:
          - app.kubernetes.io/name=seaweedfs
          - app.kubernetes.io/component=filer
      register: seaweedfs_filer_pods

    - name: Set SeaweedFS pod name
      ansible.builtin.set_fact:
        seaweedfs_pod: "{{ seaweedfs_filer_pods.resources[0].metadata.name }}"
        seaweedfs_deployment_name: "{{ seaweedfs_deployment.resources[0].metadata.name if seaweedfs_deployment.resources else 'seaweedfs' }}"
      when: seaweedfs_filer_pods.resources | length > 0

    - name: Query SeaweedFS
      no_log: "{{ secure_logs }}"
      block:
        - name: List buckets in SeaweedFS via filer
          kubernetes.core.k8s_exec:
            namespace: "{{ edp.seaweedfs.namespace }}"
            pod: "{{ seaweedfs_pod }}"
            command: >
              ls -1 /buckets 2>/dev/null || echo ""
          register: seaweedfs_buckets_list
          when: seaweedfs_pod is defined
          failed_when: false

        - name: Parse bucket list
          ansible.builtin.set_fact:
            seaweedfs_buckets: "{{ seaweedfs_buckets_list.stdout_lines | default([]) | select() | list }}"
          when:
            - seaweedfs_buckets_list is defined
            - seaweedfs_buckets_list.stdout_lines is defined

        - name: Count files in SeaweedFS buckets
          kubernetes.core.k8s_exec:
            namespace: "{{ edp.seaweedfs.namespace }}"
            pod: "{{ seaweedfs_pod }}"
            command: >
              find /buckets -type f 2>/dev/null | wc -l
          register: seaweedfs_files_count
          when: seaweedfs_pod is defined
          failed_when: false

    - name: Set SeaweedFS data consistency facts
      ansible.builtin.set_fact:
        seaweedfs_total_files: "{{ seaweedfs_files_count.stdout | default('0') | trim }}"
        seaweedfs_bucket_count: "{{ seaweedfs_buckets | default([]) | length }}"
      when: seaweedfs_pod is defined

    - name: Save SeaweedFS data to facts for YAML report
      ansible.builtin.set_fact:
        seaweedfs_report_data:
          component: "{{ seaweedfs_deployment_name }}"
          files_count: "{{ seaweedfs_total_files | default(0) | int }}"
          buckets_count: "{{ seaweedfs_bucket_count | default(0) | int }}"
      when: seaweedfs_pod is defined
