# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Set up post-upgrade data consistency report variables
  ansible.builtin.set_fact:
    data_consistency_report_dir: "{{ deployment_dir }}/upgrade/reports"
    data_consistency_yaml_report_name: "consistency-report.post.yaml"
    data_consistency_markdown_report_name: "consistency-report-post.md"

- name: Ensure reports directory exists
  ansible.builtin.file:
    path: "{{ data_consistency_report_dir }}"
    state: directory
    mode: '0755'

- name: Remove old Markdown reports (post-upgrade)
  ansible.builtin.find:
    paths: "{{ data_consistency_report_dir }}"
    patterns: "consistency-report-post*.md"
  register: old_markdown_reports_post

- name: Delete old Markdown reports (post-upgrade)
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_markdown_reports_post.files }}"
  when: old_markdown_reports_post.files | length > 0

- name: Check EDP data consistency (post-upgrade)
  ansible.builtin.include_tasks: check_edp.yaml
  when: edp is defined and edp.enabled | default(false)

- name: Check Vector Database data consistency (post-upgrade)
  ansible.builtin.include_tasks: check_vdb.yaml
  when: vector_databases is defined and vector_databases.enabled | default(false)

- name: Check MinIO data consistency (post-upgrade)
  ansible.builtin.include_tasks: check_minio.yaml
  when: edp is defined and edp.enabled | default(false) and edp.storageType | default('') == "minio"

- name: Check Fingerprint data consistency (post-upgrade)
  ansible.builtin.include_tasks: check_fingerprint.yaml
  when: fingerprint is defined and fingerprint.enabled | default(false)

- name: Check Chat History data consistency (post-upgrade)
  ansible.builtin.include_tasks: check_chat_history.yaml
  when: chat_history is defined and chat_history.enabled | default(false)

- name: Check Keycloak data consistency (post-upgrade)
  ansible.builtin.include_tasks: check_keycloak.yaml
  when: keycloak is defined and keycloak.enabled | default(false)

- name: Generate post-upgrade summary data consistency report
  ansible.builtin.include_tasks: generate_summary.yaml

- name: Display post-upgrade data consistency report location
  ansible.builtin.debug:
    msg: "Post-upgrade data consistency report generated at: {{ data_consistency_report_dir }}/consistency-report.post.yaml"
