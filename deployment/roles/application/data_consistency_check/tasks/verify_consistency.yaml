# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Initialize consistency config if not defined
  ansible.builtin.set_fact:
    consistency_config: "{{ consistency_config | default({'mappings': []}) }}"

- name: Set up data consistency report directory
  ansible.builtin.set_fact:
    data_consistency_report_dir: "{{ deployment_dir }}/upgrade/reports"

- name: Check if pre-upgrade report exists
  ansible.builtin.stat:
    path: "{{ data_consistency_report_dir }}/consistency-report.pre.yaml"
  register: pre_report_file

- name: Check if post-upgrade report exists
  ansible.builtin.stat:
    path: "{{ data_consistency_report_dir }}/consistency-report.post.yaml"
  register: post_report_file

- name: Fail if reports are missing
  ansible.builtin.fail:
    msg: "Cannot verify data consistency: pre-upgrade or post-upgrade report is missing"
  when: not pre_report_file.stat.exists or not post_report_file.stat.exists

- name: Load pre-upgrade report
  ansible.builtin.include_vars:
    file: "{{ data_consistency_report_dir }}/consistency-report.pre.yaml"
    name: pre_report

- name: Load post-upgrade report
  ansible.builtin.include_vars:
    file: "{{ data_consistency_report_dir }}/consistency-report.post.yaml"
    name: post_report

- name: Initialize verification results
  ansible.builtin.set_fact:
    verification_results: []
    verification_passed: true

- name: Build component lookup maps
  ansible.builtin.set_fact:
    pre_components_map: "{{ pre_components_map | default({}) | combine({item.component: item}) }}"
  loop: "{{ pre_report.components }}"

- name: Build post component lookup map
  ansible.builtin.set_fact:
    post_components_map: "{{ post_components_map | default({}) | combine({item.component: item}) }}"
  loop: "{{ post_report.components }}"

- name: Build mapping lookup (old to new)
  ansible.builtin.set_fact:
    mapping_lookup: "{{ mapping_lookup | default({}) | combine({item.old_component: item.new_component}) }}"
  loop: "{{ consistency_config.mappings }}"
  when: consistency_config.mappings is defined and consistency_config.mappings | length > 0

- name: Build reverse mapping lookup (new to old)
  ansible.builtin.set_fact:
    reverse_mapping_lookup: "{{ reverse_mapping_lookup | default({}) | combine({item.new_component: item.old_component}) }}"
  loop: "{{ consistency_config.mappings }}"
  when: consistency_config.mappings is defined and consistency_config.mappings | length > 0 and item.new_component != '' and item.new_component != None

- name: Verify each pre-upgrade component
  ansible.builtin.include_tasks: verify_component.yaml
  loop: "{{ pre_report.components }}"
  loop_control:
    loop_var: pre_component

- name: Check for newly added components in post-upgrade
  ansible.builtin.include_tasks: verify_new_component.yaml
  loop: "{{ post_report.components }}"
  loop_control:
    loop_var: post_component

- name: Generate verification summary report
  ansible.builtin.template:
    src: verification_report.md.j2
    dest: "{{ data_consistency_report_dir }}/consistency-verification-report.md"
    mode: '0644'

- name: Display verification summary
  ansible.builtin.debug:
    msg:
      - "===================================================================="
      - "Data Consistency Verification Complete"
      - "===================================================================="
      - "Status: {{ 'PASSED' if verification_passed else 'FAILED' }}"
      - "Report: {{ data_consistency_report_dir }}/consistency-verification-report.md"
      - "===================================================================="

- name: Fail if verification did not pass
  ansible.builtin.fail:
    msg: "Data consistency verification FAILED. Check {{ data_consistency_report_dir }}/consistency-verification-report.md for details"
  when: not verification_passed
