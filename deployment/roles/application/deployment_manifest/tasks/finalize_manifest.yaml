# Copyright (C) 2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
- name: Finalize deployment manifest
  tags:
    - install
    - uninstall
  block:
    - name: Ensure manifest namespace exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ manifest_namespace }}"
            labels: "{{ manifest_namespace_labels }}"

    - name: Query existing manifest for startedAt timestamp
      kubernetes.core.k8s_info:
        kind: ConfigMap
        namespace: "{{ manifest_namespace }}"
        label_selectors:
          - "{{ manifest_label_selector }}"
      register: existing_manifest_query
      failed_when: false

    - name: Extract startedAt from existing manifest
      set_fact:
        existing_started_at: "{{ (existing_manifest_query.resources[0].data['manifest.yaml'] | from_yaml).deployment.startedAt if existing_manifest_query.resources | length > 0 else ansible_date_time.iso8601 }}"

    - name: Get current timestamp for completedAt
      ansible.builtin.command:
        cmd: date -u +%Y-%m-%dT%H:%M:%SZ
      register: current_timestamp
      changed_when: false

    - name: Discover ERAG components from deployment/components/ directory
      ansible.builtin.command:
        cmd: "{{ playbook_dir }}/../scripts/discover_erag_components.py {{ playbook_dir }}/../components"
      register: component_discovery_output
      changed_when: false
      failed_when: component_discovery_output.rc != 0

    - name: Parse discovered components
      set_fact:
        expected_components: "{{ component_discovery_output.stdout | from_json }}"

    - name: List all Helm releases across all namespaces
      ansible.builtin.command:
        cmd: helm list -A --output json
      register: helm_list_output
      changed_when: false
      failed_when: false

    - name: Parse Helm releases
      set_fact:
        all_helm_releases: "{{ helm_list_output.stdout | from_json }}"
      when: helm_list_output.rc == 0 and helm_list_output.stdout != ''

    - name: Initialize empty list if no releases found
      set_fact:
        all_helm_releases: []
      when: helm_list_output.rc != 0 or helm_list_output.stdout == ''

    - name: Build component versions map from source-driven discovery
      set_fact:
        component_versions_map: {}

    - name: Match each expected component with Helm release
      vars:
        matching_releases: "{{ all_helm_releases | selectattr('chart', 'match', '^' + item.name + '-') | list }}"
        found_release: "{{ matching_releases[0] if matching_releases | length > 0 else {} }}"
        is_deployed: "{{ matching_releases | length > 0 }}"
      set_fact:
        component_versions_map: >-
          {{
            component_versions_map | combine({
              item.name: {
                'deployed': is_deployed,
                'appVersion': (found_release.app_version | default(item.appVersion)),
                'chartVersion': (found_release.chart | default(item.name + '-' + item.chartVersion) | regex_replace('.*-', '')),
                'namespace': (found_release.namespace | default('unknown')),
                'chart': (found_release.chart | default(item.name + '-' + item.chartVersion)),
                'status': (found_release.status | default('not-found'))
              }
            })
          }}
      loop: "{{ expected_components }}"
      when: expected_components | length > 0

    - name: Create deployment manifest data structure
      set_fact:
        deployment_manifest_data:
          deployment:
            version: "{{ solution_version }}"
            targetVersion: null
            status: "{{ manifest_status_complete }}"
            startedAt: "{{ existing_started_at }}"
            completedAt: "{{ current_timestamp.stdout }}"
            installedBy: "ansible"
            kubernetesVersion: "{{ kubernetes_version | default('unknown') }}"
          components: "{{ component_versions_map }}"
      when: "'uninstall' not in ansible_run_tags"

    - name: Finalize deployment manifest ConfigMap
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ manifest_name }}"
            namespace: "{{ manifest_namespace }}"
            labels: "{{ manifest_labels | combine({'app.kubernetes.io/version': solution_version}) }}"
          data:
            manifest.yaml: "{{ deployment_manifest_data | to_nice_yaml }}"
      when: "'uninstall' not in ansible_run_tags"

    - name: Display deployment manifest finalization
      debug:
        msg: "Manifest finalized: {{ solution_version }} ({{ manifest_status_complete }}) - {{ component_versions_map | length }} components tracked"
      when: "'uninstall' not in ansible_run_tags"

    - name: Delete deployment manifest ConfigMap
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: ConfigMap
        name: "{{ manifest_name }}"
        namespace: "{{ manifest_namespace }}"
      failed_when: false
      when: "'uninstall' in ansible_run_tags"
