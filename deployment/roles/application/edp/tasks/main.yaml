# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Set roles facts
  ansible.builtin.set_fact:
    edp_helm_override_values_path: "{{ tmp_dir }}/{{ edp.helm.chart_name }}-override-values.yaml"
  tags:
    - install
    - pre-upgrade

- name: Ensure Helm repositories
  kubernetes.core.helm_repository:
    name: "{{ edp.helm.repo_name }}"
    repo_url: "{{ edp.helm.repo_url }}"
    state: present
  tags:
    - install
    - pre-upgrade

- name: Build Helm chart dependencies
  ansible.builtin.command:
    cmd: helm dependency build
    chdir: "{{ edp.helm.chart_directory }}"
  register: helm_repo_add_result
  until: helm_repo_add_result is succeeded
  retries: 5
  delay: 15
  tags:
    - install
    - pre-upgrade

- name: Ensure namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ edp.namespace }}"
  tags:
    - install

- name: Enforce PSS
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ edp.namespace }}"
        labels:
          pod-security.kubernetes.io/enforce: "restricted"
  when: enforcePSS
  tags:
    - install

- name: Create TLS secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ edp.tls.secret_name }}"
        namespace: "{{ edp.namespace }}"
      data:
        tls.crt: "{{ lookup('file', pathToCert) | b64encode }}"
        tls.key: "{{ lookup('file', pathToKey) | b64encode }}"
      type: kubernetes.io/tls
  tags:
    - install

# Creates chatqa_namespace
- name: Get chatqa namespace
  ansible.builtin.include_role:
    name: utils
    tasks_from: get_chatqa_namespace.yaml
  tags:
    - install

# Creates client_secret_id
- name: Get client_secret_id keycloak
  vars:
    client_id: "{{ edp.client_id }}"
  ansible.builtin.include_role:
    name: keycloak
    tasks_from: get_secret_id
    apply:
      tags:
        - pre-upgrade
  tags:
    - install
    - pre-upgrade

- name: Set secret client_secret_id
  ansible.builtin.set_fact:
    edp_client_secret_id: "{{ client_secret_id.stdout }}"
  no_log: "{{ secure_logs }}"
  tags:
    - install
    - pre-upgrade

- name: Generate random string for keys
  ansible.builtin.include_role:
    name: generate_password
    tasks_from: generate_key
    apply:
      tags:
        - pre-upgrade
  loop:
    - { name: EDP_MINIO_ACCESS_KEY }
    - { name: EDP_MINIO_SECRET_KEY }
  no_log: "{{ secure_logs }}"
  tags:
    - install
    - pre-upgrade

- name: Generate password
  ansible.builtin.include_role:
    name: generate_password
    tasks_from: generate_password
    apply:
      tags:
        - pre-upgrade
  loop:
    - { name: EDP_REDIS, user: "{{ edp.redis.auth.user.db_username }}" }
    - { name: EDP_POSTGRESQL, user: "{{ edp.postgresql.auth.user.db_username }}" }
    - { name: EDP_POSTGRESQL_ADMIN, user: "{{ edp.postgresql.auth.admin.db_username }}" }
  no_log: "{{ secure_logs }}"
  tags:
    - install
    - pre-upgrade

- name: Generate override values file from template
  ansible.builtin.template:
    src: "values.yaml.j2"
    dest: "{{ edp_helm_override_values_path }}"
    mode: '0644'
  tags:
    - install
    - pre-upgrade

- name: Set values_files list
  ansible.builtin.set_fact:
    values_files: >
      {{
        [edp.helm.default_values_file] +
        ([edp.helm.tdx_resources_file] if (tdx.coco.enabled | bool) else []) +
        [edp_helm_override_values_path]
      }}
  tags:
    - install
    - pre-upgrade

- name: Run pre-upgrade checks
  ansible.builtin.include_role:
    name: upgrade
  vars:
    release_namespace: "{{ edp.namespace }}"
    release_name: "{{ edp.helm.release_name }}"
    release_enabled: "{{ edp.enabled }}"
    chart_ref: "{{ edp.helm.chart_directory }}"
    release_values_files: "{{ values_files }}"
  tags:
    - pre-upgrade

- name: Install or Upgrade Helm chart
  kubernetes.core.helm:
    name: "{{ edp.helm.release_name }}"
    chart_ref: "{{ edp.helm.chart_directory }}"
    namespace: "{{ edp.namespace }}"
    values_files: "{{ values_files }}"
    state: present
    dependency_update: true
    create_namespace: true
    timeout: "{{ helm_timeout }}"
    wait: true
  register: helm_repo_install_result
  until: helm_repo_install_result is succeeded
  retries: 5
  delay: 15
  tags:
    - install

- name: Mark secrets for password management
  ansible.builtin.include_role:
    name: password_mgmt
    tasks_from: markup.yaml
    apply:
      tags:
        - install
  vars:
    namespace: "{{ edp.namespace }}"
    secret_name: "{{ item.secret_name }}"
    password_mappings: "{{ item.password_mappings }}"
  loop:
    - secret_name: "edp-access-secret"
      password_mappings:
        - { key: EDP_ACCESS_KEY, variable: EDP_MINIO_ACCESS_KEY, user: "" }
        - { key: EDP_SECRET_KEY, variable: EDP_MINIO_SECRET_KEY, user: "" }
    - secret_name: "edp-redis-secret"
      password_mappings:
        - { key: password, variable: EDP_REDIS_PASSWORD, user: "{{ edp.redis.auth.user.db_username }}" }
    - secret_name: "edp-postgresql-secret"
      password_mappings:
        - { key: DATABASE_PASSWORD, variable: EDP_POSTGRESQL_PASSWORD, user: "{{ edp.postgresql.auth.user.db_username }}" }
        - { key: DATABASE_ADMIN_PASSWORD, variable: EDP_POSTGRESQL_ADMIN_PASSWORD, user: "{{ edp.postgresql.auth.admin.db_username }}" }
  tags:
    - install

# UNINSTALL TASKS
- name: Uninstall EDP Helm release
  kubernetes.core.helm:
    name: "{{ edp.helm.release_name }}"
    namespace: "{{ edp.namespace }}"
    state: absent
  when: edp.enabled
  tags:
    - uninstall

- name: Delete EDP namespace
  kubernetes.core.k8s:
    state: absent
    api_version: v1
    kind: Namespace
    name: "{{ edp.namespace }}"
  when: edp.enabled
  tags:
    - uninstall
