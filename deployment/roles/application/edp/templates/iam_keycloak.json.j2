{
  "identities": {{ s3_auth_config.identities | to_json }},
  "sts": {
    "tokenDuration": "{{ sts.tokenDuration | default('1h') }}",
    "maxSessionLength": "{{ sts.maxSessionLength | default('12h') }}",
    "issuer": "{{ sts.issuer | default('seaweedfs-sts') }}",
    "signingKey": "{{ sts_signing_key }}"
  },
  "providers": [
    {
      "name": "keycloak",
      "type": "oidc",
      "enabled": true,
      "config": {
        "issuer": "{{ oidc_issuer }}",
        "clientId": "{{ clientId }}",
        "jwksUri": "{{ oidc_jwksUri }}",
        "userInfoUri": "{{ oidc_userInfoUri }}",
        "scopes": {{ scopes }},
        "audiences": {{ audiences }},
        "roleMapping": {
          "rules": [
{% for mapping in role_mapping %}
            {
              "claim": "{{ claim }}",
              "value": "{{ mapping.value }}",
              "role": "{{ mapping.role }}"
            }{{ "," if not loop.last else "" }}
{% endfor %}
          ],
          "defaultRole": "{{ default_role }}"
        }
      }
    }
  ],
  "policies": [
{% if policies and policies|length > 0 %}
{% for policy in policies %}
    {
      "name": "{{ policy.name }}",
      "document": {
        "Version": "2012-10-17",
        "Statement": [
          { "Effect": "Allow", "Action": {{ policy.actions | to_json }}, "Resource": {{ policy.resources | default(["*"]) | to_json }} }
        ]
      }
    }{{ "," if not loop.last else "" }}
{% endfor %}
{% else %}
    {
      "name": "S3AdminPolicy",
      "document": {
        "Version": "2012-10-17",
        "Statement": [
          { "Effect": "Allow", "Action": ["s3:*"], "Resource": ["*"] }
        ]
      }
    },
    {
      "name": "S3UserPolicy",
      "document": {
        "Version": "2012-10-17",
        "Statement": [
          { "Effect": "Allow", "Action": ["s3:ListBucket","s3:GetObject","s3:PutObject","s3:DeleteObject","s3:ListAllMyBuckets"], "Resource": ["arn:aws:s3:::default/*", "arn:aws:s3:::default", "arn:aws:s3:::secondary/*", "arn:aws:s3:::secondary"] }
        ]
      }
    },
    {
      "name": "S3ReadOnlyPolicy",
      "document": {
        "Version": "2012-10-17",
        "Statement": [
          { "Effect": "Allow", "Action": ["s3:ListBucket","s3:GetObject"], "Resource": ["arn:aws:s3:::default/*", "arn:aws:s3:::default", "arn:aws:s3:::secondary/*", "arn:aws:s3:::secondary"] }
        ]
      }
    }
{% endif %}
  ],
  "roles": [
{% for role in roles %}
    {
      "roleName": "{{ role.name }}",
      "roleArn": "{{ role.arn }}",
      "attachedPolicies": {{ role.policies | to_json }},
      "trustPolicy": {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": { "Federated": "*" },
            "Action": ["sts:AssumeRoleWithWebIdentity"],
            "Condition": {
              "StringEquals": { "seaweed:Issuer": "{{ oidc_issuer }}" }
            }
          }
        ]
      }
    }{{ "," if not loop.last else "" }}
{% endfor %}
  ]
}
