{#
Copyright (C) 2024-2026 Intel Corporation
SPDX-License-Identifier: Apache-2.0
#}

# PostgreSQL configuration (use existing secret)
postgresql:
  existingSecret: "{{ keycloak.postgresql.password_secret_name }}"
  passwordKey: "password"
  adminPasswordKey: "postgres-password"

keycloakx:
  # Ingress configuration (environment-specific domain)
  ingress:
    enabled: true
    ingressClassName: "nginx"
    annotations:
      nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
      nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
    rules:
      - host: {{ keycloak.domainName }}
        paths:
          - path: /
            pathType: Prefix
    tls:
      - hosts:
          - {{ keycloak.domainName }}
        secretName: {{ keycloak.tls.secret_name }}

{% if keycloak.hostAliases is defined and keycloak.hostAliases | length > 0 %}
  hostAliases:
{% for alias in keycloak.hostAliases %}
  - {{ alias | to_nice_yaml | indent(4) }}
{%- endfor %}
{% endif %}

  # Database configuration - chart generates KC_DB* env vars from these values
  database:
    vendor: postgres  # Generates KC_DB=postgres
    hostname: keycloak-postgresql  # Generates KC_DB_URL_HOST
    port: 5432  # Generates KC_DB_URL_PORT
    database: {{ keycloak.postgresql.database }}  # Generates KC_DB_URL_DATABASE
    username: {{ keycloak.postgresql.username }}  # Generates KC_DB_USERNAME
    existingSecret: {{ keycloak.postgresql.password_secret_name }}
    existingSecretKey: password

  # Set http.relativePath - chart generates KC_HTTP_RELATIVE_PATH from this
  http:
    relativePath: /

  # Override chart defaults - chart generates ispn/jdbc-ping which doesn't work in restricted environments
  cache:
    stack: custom  # Disable automatic cache configuration

  # Override proxy.mode - chart generates KC_PROXY_HEADERS from this
  proxy:
    enabled: true
    mode: xforwarded  # Generates KC_PROXY_HEADERS=xforwarded (chart default is "forwarded")
    http:
      enabled: true  # Generates KC_HTTP_ENABLED=true

  # Enable metrics and health - chart generates env vars from these
  metrics:
    enabled: true  # Generates KC_METRICS_ENABLED=true

  health:
    enabled: true  # Generates KC_HEALTH_ENABLED=true

  extraEnv: |
    - name: KC_BOOTSTRAP_ADMIN_USERNAME
      valueFrom:
        secretKeyRef:
          name: {{ keycloak.auth.admin.password_secret_name }}
          key: admin-username
    - name: KC_BOOTSTRAP_ADMIN_PASSWORD
      valueFrom:
        secretKeyRef:
          name: {{ keycloak.auth.admin.password_secret_name }}
          key: admin-password
    - name: JAVA_OPTS_APPEND
      value: >
        -XX:InitialRAMPercentage=50
        -XX:MaxRAMPercentage=50
    - name: KC_CACHE
      value: "local"
    - name: KC_HOSTNAME
      value: "https://{{ keycloak.domainName }}"
    - name: KC_HOSTNAME_STRICT
      value: "false"
    - name: KC_HOSTNAME_BACKCHANNEL_DYNAMIC
      value: "true"
    - name: KC_PROXY
      value: "edge"
    - name: KC_DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: {{ keycloak.postgresql.password_secret_name }}
          key: password
{% if httpProxy is defined and httpProxy != "" %}
    - name: http_proxy
      value: "{{ httpProxy }}"
{% endif %}
{% if httpsProxy is defined and httpsProxy != "" %}
    - name: https_proxy
      value: "{{ httpsProxy }}"
{% endif %}
{% if noProxy is defined and noProxy != "" %}
    - name: no_proxy
      value: "{{ noProxy }}"
{% endif %}
