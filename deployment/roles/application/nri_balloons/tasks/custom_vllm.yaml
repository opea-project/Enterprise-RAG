# Copyright (C) 2024-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Find pods
  ansible.builtin.include_tasks:
    file: find_custom_vllm_pods.yaml
  tags:
    - install

- name: Group pods by node with CPU limits
  ansible.builtin.set_fact:
    pods_by_node: |
      {% set node_groups = {} %}
      {% for pod in vllm_custom_pods %}
        {% set node_name = pod.node_name | default('unscheduled') %}
        {% if node_name not in node_groups %}
          {% set _ = node_groups.update({node_name: 0}) %}
        {% endif %}
        {% set cpu_limit = pod.cpu_limits | default('0') %}
        {% set cpu_value = (cpu_limit | regex_replace('m$', '') | int) if cpu_limit.endswith('m') else (cpu_limit | int * 1000) %}
        {% set _ = node_groups.update({node_name: node_groups[node_name] + cpu_value}) %}
      {% endfor %}
      {{ node_groups | to_json }}
  when: vllm_custom_pods is defined
  tags:
    - install

- name: Validate CPU allocation per node
  ansible.builtin.fail:
    msg: >-
      Node {{ item.key }} has exceeded CPU allocation.
      Current: {{ item.value }} millicores,
      Maximum allowed: {{ (optimal_replicas[item.key].replicas | int) * (optimal_replicas[item.key].adjusted_vllm_size | int) * 1000 }} millicores
      Follow balloons - topology aware resource scheduling section in docs/advanced_configuration.md to fix this issue
  loop: "{{ pods_by_node | from_json | dict2items }}"
  when:
    - (item.value | int) > ((optimal_replicas[item.key].replicas | int) * (optimal_replicas[item.key].adjusted_vllm_size | int) * 1000)
  tags:
    - install

- name: Fail if no custom vLLM pods found
  ansible.builtin.fail:
    msg: "No custom vLLM pods found. Expected vllm_custom_pods to be defined and not empty."
  when: vllm_custom_pods is not defined or vllm_custom_pods | length == 0
  tags:
    - install

- name: Restart pods with custom vLLM container to apply balloons policy
  kubernetes.core.k8s:
    kind: Pod
    name: "{{ item.name }}"
    namespace: "{{ item.namespace }}"
    state: absent
    wait: true
    wait_timeout: 60
  loop: "{{ vllm_custom_pods }}"
  when: vllm_custom_pods is defined and vllm_custom_pods | length > 0
  tags:
    - install

- name: Set vllm_old_pods from vllm_custom_pods
  ansible.builtin.set_fact:
    vllm_old_pods: "{{ vllm_custom_pods | to_json }}"
  tags:
    - install

- name: Wait for pods to be recreated
  block:
    - name: Set the retry count
      set_fact:
        retry_count: "{{ 0 if retry_count is undefined else retry_count|int + 1 }}"

    - name: Find custom vLLM pods
      ansible.builtin.include_tasks:
        file: find_custom_vllm_pods.yaml

    - name: Check if all pods are recreated
      ansible.builtin.assert:
        that:
          - vllm_custom_pods is defined
          - (vllm_custom_pods | length) == (vllm_old_pods | from_json | length)
        fail_msg: "Waiting for pods to be recreated..."
  when: vllm_old_pods is defined
  rescue:
    - fail:
        msg: Ended after 10 retries
      when: retry_count|int == 10

    - debug:
        msg: "Pods were not recreated"

    - include_tasks: find_custom_vllm_pods.yaml
  tags:
    - install
