# Copyright (C) 2024-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Set nri_balloons_controller facts
  ansible.builtin.set_fact:
    nri_balloons_controller_override_values_path: >-
      {{ tmp_dir }}/nri-balloons-controller-values.yaml
  tags:
    - install

- name: Generate nri-balloons-controller values file
  ansible.builtin.template:
    src: "controller-values.yaml.j2"
    dest: "{{ nri_balloons_controller_override_values_path }}"
    mode: '0644'
  tags:
    - install

- name: Check if cert-manager is installed
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: cert-manager
  register: cert_manager_check
  tags:
    - install

- name: Add jetstack chart repo
  kubernetes.core.helm_repository:
    name: jetstack
    repo_url: "https://charts.jetstack.io"
  when: cert_manager_check.resources | length == 0
  tags:
    - install

- name: Install cert-manager if not present
  kubernetes.core.helm:
    name: cert-manager
    chart_ref: jetstack/cert-manager
    release_namespace: cert-manager
    create_namespace: true
    chart_version: v1.16.4
    values:
      installCRDs: true
    state: present
    wait: true
  when: cert_manager_check.resources | length == 0
  tags:
    - install

- name: Label cert-manager namespace as installed by erag
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: cert-manager
    definition:
      metadata:
        labels:
          installed-by: erag
  when: cert_manager_check.resources | length == 0
  tags:
    - install

- name: Install NRI Balloons Controller
  kubernetes.core.helm:
    name: "nri-balloons-controller"
    chart_ref: "{{ playbook_dir }}/../components/nri-balloons-controller"
    namespace: "{{ balloons.controller.namespace }}"
    create_namespace: true
    values_files:
      - "{{ nri_balloons_controller_override_values_path }}"
    state: present
    wait: true
  tags:
    - install

- name: Find pods
  ansible.builtin.include_tasks:
    file: find_custom_vllm_pods.yaml
  tags:
    - install

- name: Group pods by node with CPU limits
  ansible.builtin.set_fact:
    pods_by_node: |
      {% set node_groups = {} %}
      {% for pod in vllm_custom_pods %}
        {% set node_name = pod.node_name | default('unscheduled') %}
        {% if node_name not in node_groups %}
          {% set _ = node_groups.update({node_name: 0}) %}
        {% endif %}
        {% set cpu_limit = pod.cpu_limits | default('0') %}
        {% set cpu_value = (cpu_limit | regex_replace('m$', '') | int)
           if cpu_limit.endswith('m')
           else (cpu_limit | int * 1000) %}
        {% set _ = node_groups.update({
             node_name: node_groups[node_name] + cpu_value
           }) %}
      {% endfor %}
      {{ node_groups | to_json }}
  when: vllm_custom_pods is defined
  tags:
    - install

- name: Validate CPU allocation per node
  ansible.builtin.fail:
    msg: >-
      Allocated CPU {{ item.value }} millicores on node {{ item.key }}
      exceeds available capacity
      {{ (optimal_replicas[item.key].replicas | int) *
      (optimal_replicas[item.key].adjusted_vllm_size | int) * 1000 }}
      millicores.
      Follow balloons - topology aware resource scheduling section in
      docs/advanced_configuration.md to fix this issue
  loop: "{{ pods_by_node | from_json | dict2items }}"
  when:
    - (item.value | int) >
      ((optimal_replicas[item.key].replicas | int) *
      (optimal_replicas[item.key].adjusted_vllm_size | int) * 1000)
  tags:
    - install

- name: Fail if no custom vLLM pods found
  ansible.builtin.fail:
    msg: >-
      No custom vLLM pods found. Expected vllm_custom_pods to be defined
      and not empty.
  when: vllm_custom_pods is not defined or vllm_custom_pods | length == 0
  tags:
    - install

- name: Restart pods with custom vLLM container to apply balloons policy
  kubernetes.core.k8s:
    kind: Pod
    name: "{{ item.name }}"
    namespace: "{{ item.namespace }}"
    state: absent
    wait: false
    wait_timeout: 60
  loop: "{{ vllm_custom_pods }}"
  when: vllm_custom_pods is defined and vllm_custom_pods | length > 0
  tags:
    - install

- name: Set vllm_old_pods
  ansible.builtin.set_fact:
    vllm_old_pods: "{{ vllm_custom_pods | to_json }}"
  tags:
    - install

- name: Wait for pods to be recreated
  block:
    - name: Set the retry count
      set_fact:
        retry_count: >-
          {{ 0 if retry_count is undefined else retry_count|int + 1 }}

    - name: Find custom vLLM pods
      ansible.builtin.include_tasks:
        file: find_custom_vllm_pods.yaml

    - name: Check if all pods are recreated
      ansible.builtin.assert:
        that:
          - vllm_custom_pods is defined
          - (vllm_custom_pods | length) == (vllm_old_pods | from_json | length)
        fail_msg: "Waiting for pods to be recreated..."
  when: vllm_old_pods is defined
  rescue:
    - fail:
        msg: Ended after 10 retries
      when: retry_count|int == 10

    - debug:
        msg: "Pods were not recreated"

    - include_tasks: find_custom_vllm_pods.yaml
  tags:
    - install
