# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Ensure Helm repository is added
  kubernetes.core.helm_repository:
    name: "{{ balloons.helm.repo_name }}"
    repo_url: "{{ balloons.helm.repo_url }}"
    state: present
  tags:
    - install
    - pre-upgrade

- name: Get all BalloonsPolicies
  kubernetes.core.k8s_info:
    api_version: config.nri/v1alpha1
    kind: BalloonsPolicy
    namespace: "{{ balloons.namespace }}"
  register: balloons_policies
  tags:
    - install

- name: Remove all BalloonsPolicies
  kubernetes.core.k8s:
    api_version: config.nri/v1alpha1
    kind: BalloonsPolicy
    name: "{{ item.metadata.name }}"
    namespace: "{{ balloons.namespace }}"
    state: absent
  loop: "{{ balloons_policies.resources }}"
  tags:
    - install

- name: Gather NUMA topology info
  ansible.builtin.include_role:
    name: utils
    tasks_from: get_nodes_topology.yaml
    apply:
      tags:
        - pre-upgrade
  when: cpu_topology_per_node is not defined
  tags:
    - install
    - pre-upgrade
    - uninstall
    - topology-preview

- name: Ensure namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ balloons.namespace }}"
  when: balloons.namespace != 'kube-system'
  tags:
    - install
    - pre-upgrade

- name: Enforce PSS
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ balloons.namespace }}"
        labels:
          pod-security.kubernetes.io/enforce: "privileged"
  when:
    - enforcePSS
    - balloons.namespace != 'kube-system'
  tags:
    - install

- name: Run pre-upgrade checks
  ansible.builtin.include_role:
    name: upgrade
  vars:
    release_namespace: "{{ balloons.namespace }}"
    release_name: "{{ balloons.helm.release_name }}"
    release_enabled: "{{ balloons.enabled }}"
    chart_ref: "{{ balloons.helm.repo_name }}/{{ balloons.helm.chart_name }}"
    release_values_files: "{{ balloons.helm.reset_values_file }}"
  tags:
    - pre-upgrade

- name: Set balloons_chart_name fact for cross-role usage
  ansible.builtin.set_fact:
    balloons_chart_name: "{{ balloons.helm.chart_name }}"
  tags:
    - install
    - pre-upgrade

- name: Apply nri-resource-policy-balloons chart
  kubernetes.core.helm:
    name: "{{ balloons.helm.release_name }}"
    chart_ref: "{{ balloons.helm.repo_name }}/{{ balloons.helm.chart_name }}"
    namespace: "{{ balloons.namespace }}"
    chart_version: "{{ balloons.helm.chart_version }}"
    create_namespace: false
    values_files: "{{ balloons.helm.reset_values_file }}"
    state: present
    wait: true
    timeout: "{{ helm_timeout }}"
#   This is a method to use a post-renderer script to modify the rendered manifests before they are applied to the cluster.
#   Commented due to unknown issue with balloon while enabling TDX
#    post_renderer:
#      "{{ tdx_post_renderer_executable ~ ' --post-renderer-args \"' ~ balloons.namespace ~ ' ' ~ KBS_ADDRESS ~ '\"'
#       if tdx.coco.enabled else omit }}"
  register: helm_repo_add_result
  until: helm_repo_add_result is succeeded
  retries: 3
  delay: 15
  tags:
    - install

- name: Calculate maxReplicasGaudi_VLLM
  ansible.builtin.set_fact:
    maxReplicasGaudi_VLLM: >-
      {%- if item.type in ['chatqa', 'docsum'] and item.modelConfigPath is defined -%}
        {%- set model_config = (lookup('file', pipelines_dir + '/' + item.modelConfigPath) | from_yaml).get('modelConfigs', {}) -%}
        {%- set model_entry = model_config.get(llm_model_gaudi ~ '', {}) -%}
        {%- set tp_size = model_entry.get('tensor_parallel_size', none) -%}
        {%- if tp_size is not none and (tp_size | int) != 0 -%}
          {{ 8 // (tp_size | int) }}
        {%- else -%}
          {{ none }}
        {%- endif -%}
      {%- else -%}
        {{ none }}
      {%- endif -%}
  loop: "{{ pipelines }}"
  tags:
    - install

- name: Apply balloons/labels/taints for each node
  ansible.builtin.include_role:
    name: utils
    tasks_from: apply_scheduling_strategy.yaml
  loop: "{{ cpu_topology_per_node | dict2items }}"
  loop_control:
    loop_var: item
  tags:
    - install

- name: Find pods with custom vLLM container name
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ item }}"
  loop: "{{ query('kubernetes.core.k8s', kind='Namespace', kubeconfig=kubeconfig) | map(attribute='metadata.name') | list }}"
  register: all_pods
  when: balloons.vllm_custom_name is defined
  tags:
    - install

- name: Filter pods containing custom vLLM container
  ansible.builtin.set_fact:
    vllm_custom_pods: |
      {% set filtered_pods = [] %}
      {% for result in all_pods.results | selectattr('resources', 'defined') %}
        {% for pod in result.resources | selectattr('spec', 'defined') | selectattr('spec.containers', 'defined') %}
          {% for container in pod.spec.containers %}
            {% if balloons.vllm_custom_name in container.name %}
              {% set _ = filtered_pods.append({'name': pod.metadata.name, 'namespace': pod.metadata.namespace}) %}
            {% endif %}
          {% endfor %}
        {% endfor %}
      {% endfor %}
      {{ filtered_pods | unique | to_json }}
  when: balloons.vllm_custom_name is defined and all_pods.results is defined
  tags:
    - install

- name: Parse vllm_custom_pods JSON
  ansible.builtin.set_fact:
    vllm_custom_pods: "{{ vllm_custom_pods | from_json }}"
  when: balloons.vllm_custom_name is defined and vllm_custom_pods is defined
  tags:
    - install

- name: Restart pods with custom vLLM container to apply balloons policy
  kubernetes.core.k8s:
    kind: Pod
    name: "{{ item.name }}"
    namespace: "{{ item.namespace }}"
    state: absent
    wait: true
    wait_timeout: 60
  loop: "{{ vllm_custom_pods }}"
  when: balloons.vllm_custom_name is defined and vllm_custom_pods is defined and vllm_custom_pods | length > 0
  tags:
    - install

- name: Uninstall NRI balloons policy
  ansible.builtin.include_tasks:
    file: uninstall.yaml
  tags:
    - uninstall
