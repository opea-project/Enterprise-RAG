# Copyright (C) 2024-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Determine effective pipeline paths based on upload mode
  ansible.builtin.set_fact:
    effective_sample_path: >-
      {{
        (upload_pipelines_config | selectattr('type', 'equalto', item.type) | map(attribute='samplePath') | first)
        if (upload_pipelines | default(false) | bool)
        else item.samplePath
      }}
    effective_resources_path: >-
      {{
        (upload_pipelines_config | selectattr('type', 'equalto', item.type) | map(attribute='resourcesPath') | first)
        if (upload_pipelines | default(false) | bool)
        else item.resourcesPath
      }}
  tags:
    - install
    - pre-upgrade
    - update-configuration

- name: Debug pipeline item configuration
  debug:
    msg: |
      Pipeline item details:
        namespace: {{ item.namespace }}
        samplePath: {{ effective_sample_path }}
        resourcesPath: {{ effective_resources_path }}
        modelConfigPath: {{ item.modelConfigPath | default('not set') }}
        upload_pipelines: {{ upload_pipelines | default(false) }}
        type: {{ item.type }}
  tags:
    - install
    - pre-upgrade
    - update-configuration

- name: Set override facts
  ansible.builtin.set_fact:
    helm_override_values_path: "{{ tmp_dir }}/{{ gmc.helm.chart_name }}-override-values.yaml"
    helm_resources_path: "{{ pipelines_dir }}/{{ effective_resources_path }}"
    helm_override_resources_path: "{{ tmp_dir }}/{{ gmc.helm.chart_name }}-override-resources.yaml"
    helm_override_model_config_path: "{{ pipelines_dir }}/{{ item.modelConfigPath }}"
  tags:
    - install
    - pre-upgrade
    - update-configuration

- name: Generate override values file from template
  ansible.builtin.template:
    src: "values.yaml.j2"
    dest: "{{ helm_override_values_path }}"
    mode: '0644'
  tags:
    - install
    - pre-upgrade
    - update-configuration

- name: Initialize optimal_replicas if not defined
  ansible.builtin.set_fact:
    optimal_replicas: {}
  when: optimal_replicas is not defined
  tags:
    - install
    - pre-upgrade
    - update-configuration

- name: Generate override resources values file from template
  ansible.builtin.template:
    src: "resources-values.yaml.j2"
    dest: "{{ helm_override_resources_path }}"
    mode: '0644'
  tags:
    - install
    - pre-upgrade
    - update-configuration

- name: Ensure pipeline namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ item.namespace }}"
  tags:
    - install
    - update-configuration

- name: Enforce PSS
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ item.namespace }}"
        labels:
          pod-security.kubernetes.io/enforce: "restricted"
  when: enforcePSS
  tags:
    - install

- name: Ensure GMC namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ gmc.namespace }}"
  tags:
    - install
    - update-configuration

- name: Enforce PSS
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ gmc.namespace }}"
        labels:
          pod-security.kubernetes.io/enforce: "restricted"
  when: enforcePSS
  tags:
    - install

- name: Set fact for Helm values files
  ansible.builtin.set_fact:
    values_files: >
      {{
        [gmc.helm.default_values_file] +
        [gmc.helm.default_resources_file] +
        ([gmc.helm.tdx_resources_file] if (tdx is defined and tdx.coco is defined and tdx.coco.enabled | bool) else []) +
        ([helm_resources_path] if item.resourcesPath is defined else []) +
        [helm_override_resources_path] +
        [helm_override_values_path] +
        ([helm_override_model_config_path] if item.modelConfigPath is defined else [])
      }}
  tags:
    - install
    - pre-upgrade
    - update-configuration

- name: Ensure namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ item.namespace }}"
  tags:
    - install
    - update

- name: Capture baseline of dynamically-generated resources before installation
  ansible.builtin.include_role:
    name: utils
    tasks_from: capture_dynamic_resources.yaml
  vars:
    pipeline_item: "{{ item }}"
  tags:
    - install
    - pre-upgrade
    - update-configuration

- name: Run pre-upgrade checks
  ansible.builtin.include_role:
    name: upgrade
  vars:
    release_namespace: "{{ gmc.namespace }}"
    release_name: "{{ gmc.helm.release_name }}"
    release_enabled: true
    chart_ref: "{{ gmc.helm.chart_directory }}"
    release_values_files: "{{ values_files }}"
  tags:
    - pre-upgrade

- name: Install or Upgrade Helm chart
  kubernetes.core.helm:
    name: "{{ gmc.helm.release_name }}"
    chart_ref: "{{ gmc.helm.chart_directory }}"
    namespace: "{{ gmc.namespace }}"
    values_files: "{{ values_files }}"
    state: present
    create_namespace: true
    timeout: "{{ helm_timeout }}"
    wait: true
  register: helm_repo_install_result
  until: helm_repo_install_result is succeeded
  retries: 5
  delay: 15
  tags:
    - install
    - update-configuration

- name: Extract LLM_VLLM_API_KEY from pipeline configuration
  ansible.builtin.set_fact:
    llm_vllm_api_key: "{{ (lookup('file', pipelines_dir + effective_sample_path) | from_yaml).spec.nodes.root.steps | selectattr('name', 'equalto', 'Llm') | map(attribute='internalService.config.LLM_VLLM_API_KEY') | first | default('') }}"
  when:
    - effective_sample_path is defined
    - (lookup('file', pipelines_dir + effective_sample_path) | from_yaml | default({})).spec.nodes.root.steps | selectattr('name', 'equalto', 'Llm') | selectattr('internalService.config.LLM_VLLM_API_KEY', 'defined') | list | length > 0
  tags:
    - install
    - update-configuration

- name: Create VLLM API key secret from template
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'vllm-api-key-secret.yaml.j2') | from_yaml }}"
  when:
    - llm_vllm_api_key is defined
    - llm_vllm_api_key != ''
  tags:
    - install
    - update-configuration

- name: Apply pipeline
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('file', pipelines_dir + effective_sample_path) }}"
    namespace: "{{ item.namespace }}"
  register: pipeline_apply_result
  tags:
    - install
    - update-configuration

- name: Remove obsolete dynamically-generated resources
  ansible.builtin.include_role:
    name: utils
    tasks_from: remove_obsolete_dynamic_resources.yaml
  vars:
    pipeline_item: "{{ item }}"
  tags:
    - install
    - update-configuration

- name: Remove pipeline namespace
  kubernetes.core.k8s:
    state: absent
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ item.namespace }}"
  tags:
    - uninstall

- name: Uninstall Helm chart
  kubernetes.core.helm:
    name: "{{ gmc.helm.release_name }}"
    namespace: "{{ gmc.namespace }}"
    state: absent
  tags:
    - uninstall

- name: Delete GMC namespace
  kubernetes.core.k8s:
    state: absent
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ gmc.namespace }}"
  tags:
    - uninstall
