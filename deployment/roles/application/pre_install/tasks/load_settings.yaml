---
- name: Load initial configuration
  ansible.builtin.include_tasks:
    file: initial_config.yaml
    apply:
      tags:
        - always
        - update-configuration
  tags:
    - always
    - update-configuration

- name: Load solution configuration
  ansible.builtin.include_tasks:
    file: solution_config.yaml
    apply:
      tags:
        - always
        - update-configuration
  tags:
    - always
    - update-configuration

- name: Verify configuration
  ansible.builtin.include_tasks:
    file: verify_config.yaml
  tags:
    - always

- name: Display configuration summary
  ansible.builtin.debug:
    msg: |

      ==================== CONFIGURATION SUMMARY ====================

      CONFIGURATION SUCCESSFUL

      All configuration checks passed successfully!

      Upload Mode:
        • Upload mode: {{ upload_pipelines | default(false) }}

      Environment Configuration:
        • huggingToken: {{ 'SET' if huggingToken is defined and huggingToken != '' else 'NOT SET (ensure models are publicly available)' }}
        • kubeconfig: {{ kubeconfig if kubeconfig is defined and kubeconfig != '' else 'NOT SET' }}
      {% if tdx is defined and tdx.enabled | default(false) and KBS_ADDRESS is defined and KBS_ADDRESS != '' %}
        • KBS_ADDRESS: {{ KBS_ADDRESS }}
      {% endif %}

      Proxy Configuration:
      {% if httpProxy is defined and httpProxy != '' %}
        • HTTP Proxy: {{ httpProxy }}
      {% endif %}
      {% if httpsProxy is defined and httpsProxy != '' %}
        • HTTPS Proxy: {{ httpsProxy }}
      {% endif %}
      {% if noProxy is defined and noProxy != '' %}
        • Combined NoProxy: {{ noProxy }}
      {% endif %}
      {% if additionalNoProxy is defined and additionalNoProxy != '' %}
        • User Additional NoProxy: {{ additionalNoProxy }}
      {% endif %}
      {% if (httpProxy is not defined or httpProxy == '') and (httpsProxy is not defined or httpsProxy == '') %}
        • Proxy: Not configured
      {% endif %}

      Domain Configuration:
        • UI: {{ FQDN | default('undefined') }}
        • Keycloak: {{ keycloak.domainName | default('undefined') }}
        • Telemetry: {{ telemetry.domainName | default('undefined') }}
        • MinIO: {{ edp.minio.domainName | default('undefined') }}
        • MinIO API: {{ edp.minio.apiDomainName | default('undefined') }}

      Certificate Configuration:
      {% if certs is defined and certs.autoGenerated | default(false) %}
        • Auto-generate certs: enabled
      {% endif %}
      {% if certs is defined and certs.pathToCert is defined and certs.pathToCert != '' %}
        • Cert path: {{ certs.pathToCert }}
      {% endif %}
      {% if certs is defined and certs.pathToKey is defined and certs.pathToKey != '' %}
        • Key path: {{ certs.pathToKey }}
      {% endif %}

      Services Status:
        • Istio: {{ istio.enabled | default('undefined') }}
        • Ingress: {{ ingress.enabled | default('undefined') }}
        • Keycloak: {{ keycloak.enabled | default('undefined') }}
        • APISIX: {{ apisix.enabled | default('undefined') }}
        • Vector DB: {{ vector_databases.enabled | default('undefined') }}
        • EDP: {{ edp.enabled | default('undefined') }}
      {% if edp.enabled and edp.late_chunking is defined %}
        • Late Chunking: {{ edp.late_chunking.enabled | default('undefined') }}
      {% endif %}
        • UI: {{ ui.enabled | default('undefined') }}
        • Telemetry: {{ telemetry.enabled | default('undefined') }}
        • Traces (Telemetry): {{ telemetry.traces.enabled | default('undefined') }}
        • TDX: {{ tdx.enabled | default('undefined') }}

      Model Configuration:
        • LLM Model: {{ llm_model | default('undefined') }}
        • Embedding Model: {{ embedding_model_name | default('undefined') }}
        • Reranking Model: {{ reranking_model_name | default('undefined') }}


      Ready to proceed with deployment!
      ============================================================
  when: configuration_issues | length == 0
  tags:
    - install
    - display-configuration
