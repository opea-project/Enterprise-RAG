---
- name: Pre-fetch role defaults for early availability
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../roles/application/{{ item }}/defaults/main.yaml"
  loop:
    - istio
    - ingress
    - keycloak
    - apisix
    - telemetry
    - ui
    - vector_databases
    - edp
    - fingerprint
    - chat_history
    - nri_balloons
    - pipeline
    - tdx
    - rag_utils
  tags:
    - install
    - display-configuration
    - uninstall

- name: Initialize configuration issues list
  ansible.builtin.set_fact:
    configuration_issues: []
  tags:
    - install
    - display-configuration
    - uninstall

- name: Load huggingToken from HF_TOKEN environment variable if not set in config
  ansible.builtin.set_fact:
    huggingToken: "{{ lookup('env', 'HF_TOKEN') }}"
  when: huggingToken is not defined or huggingToken == "" or huggingToken == "FILL_HERE"
  tags:
    - install
    - display-configuration

- name: Load kubeconfig from KUBECONFIG environment variable if not set in config
  ansible.builtin.set_fact:
    kubeconfig: "{{ lookup('env', 'KUBECONFIG') }}"
  when: kubeconfig is not defined or kubeconfig == "" or kubeconfig == "FILL_HERE"
  tags:
    - install
    - display-configuration
    - uninstall

- name: Create noProxy from additionalNoProxy when proxy is configured
  ansible.builtin.set_fact:
    noProxy: >-
      {{
        (['localhost', '.svc', '.monitoring'] +
         (['.monitoring-traces'] if telemetry.traces.enabled | default(false) else []) +
         ((additionalNoProxy | default('', true)) | string | split(',') | list)) |
        reject('equalto', '') |
        list |
        unique |
        join(',')
      }}
  when: (httpProxy is defined and httpProxy != "") or (httpsProxy is defined and httpsProxy != "")
  tags:
    - install
    - display-configuration


- name: Set noProxy to empty when no proxy is configured
  ansible.builtin.set_fact:
    noProxy: ""
  when: (httpProxy is not defined or httpProxy == "") and (httpsProxy is not defined or httpsProxy == "")
  tags:
    - install
    - display-configuration

- name: Add kubeconfig configuration issue
  ansible.builtin.set_fact:
    configuration_issues: "{{ configuration_issues + ['KUBECONFIG is not set. Please set the KUBECONFIG environment variable or provide a value in the configuration file.'] }}"
  when: kubeconfig is not defined or kubeconfig | length == 0
  tags:
    - install
    - display-configuration
    - uninstall

- name: Load tdx system variable
  ansible.builtin.set_fact:
    KBS_ADDRESS: "{{ lookup('env', 'KBS_ADDRESS') }}"
  when: tdx.enabled
  tags:
    - install
    - display-configuration

- name: Add KBS_ADDRESS configuration issue
  ansible.builtin.set_fact:
    configuration_issues: "{{ configuration_issues + ['KBS_ADDRESS is not set. Please set the KBS_ADDRESS environment variable when TDX CoCo is enabled.'] }}"
  when: tdx.enabled and (KBS_ADDRESS is not defined or KBS_ADDRESS | length == 0)
  tags:
    - install
    - display-configuration

- name: Set facts for domain names if not defined
  ansible.builtin.set_fact:
    ui: >-
      {{ ui | combine({'domainName': FQDN | default(ui.domainName)}) }}
    keycloak: >-
      {{ keycloak | combine({'domainName': 'auth.' + FQDN | default(keycloak.domainName)}) }}
    telemetry: >-
      {{ telemetry | combine({'domainName': 'grafana.' + FQDN | default(telemetry.domainName)}) }}
    edp: >-
      {{ edp | combine({
          'minio': edp.minio | default({}) | combine({
            'domainName': 'minio.' + FQDN | default(edp.minio.domainName),
            'apiDomainName': 's3.' + FQDN | default(edp.minio.apiDomainName)
          })
        })
      }}
  tags:
    - install
    - display-configuration

- name: Add certificate configuration issue
  ansible.builtin.set_fact:
    configuration_issues: "{{ configuration_issues + ['Certificate paths must be provided when autoGenerated is false. Please set certs.pathToCert and certs.pathToKey in the configuration file.'] }}"
  when: certs.autoGenerated is defined and not certs.autoGenerated and (certs.pathToCert is not defined or certs.pathToCert == "" or certs.pathToKey is not defined or certs.pathToKey == "")
  tags:
    - install
    - display-configuration

- name: Add late chunking embedding model compatibility issue
  when:
    - edp.enabled and edp.late_chunking.enabled
  block:
    - name: Set compatible embedding models for late chunking
      ansible.builtin.set_fact:
        late_chunking_compatible_models:
          - "jinaai/jina-embeddings-v2-base-en"
          # Add more compatible models here in the future

    - name: Validate embedding model compatibility for late chunking
      ansible.builtin.set_fact:
        configuration_issues: "{{ configuration_issues + ['Late chunking is enabled but the current embedding model is not compatible. Current value: \"' + (embedding_model_name | default('undefined')) + '\". Compatible models: \"' + (late_chunking_compatible_models | join('\", \"')) + '\". Please change embedding_model_name to one of the compatible models.'] }}"
      when:
        - embedding_model_name | default('undefined') not in late_chunking_compatible_models
  tags:
    - install
    - display-configuration

- name: Display HF_TOKEN warning if not set
  ansible.builtin.debug:
    msg: |
      WARNING: HF_TOKEN is not set!

      If you're using gated models from Hugging Face, you'll need to set the HF_TOKEN
      environment variable or provide huggingToken in your configuration file.

      If you're only using publicly available models, you can ignore this warning.
  when: huggingToken is not defined or huggingToken | length == 0
  tags:
    - install
    - display-configuration


- name: Display configuration summary
  ansible.builtin.debug:
    msg: |

      ==================== CONFIGURATION SUMMARY ====================

      CONFIGURATION SUCCESSFUL

      All configuration checks passed successfully!

      Environment Configuration:
        • huggingToken: {{ 'SET' if huggingToken is defined and huggingToken != '' else 'NOT SET (ensure models are publicly available)' }}
        • kubeconfig: {{ kubeconfig if kubeconfig is defined and kubeconfig != '' else 'NOT SET' }}
      {% if tdx is defined and tdx.enabled | default(false) and KBS_ADDRESS is defined and KBS_ADDRESS != '' %}
        • KBS_ADDRESS: {{ KBS_ADDRESS }}
      {% endif %}

      Proxy Configuration:
      {% if httpProxy is defined and httpProxy != '' %}
        • HTTP Proxy: {{ httpProxy }}
      {% endif %}
      {% if httpsProxy is defined and httpsProxy != '' %}
        • HTTPS Proxy: {{ httpsProxy }}
      {% endif %}
      {% if noProxy is defined and noProxy != '' %}
        • Combined NoProxy: {{ noProxy }}
      {% endif %}
      {% if additionalNoProxy is defined and additionalNoProxy != '' %}
        • User Additional NoProxy: {{ additionalNoProxy }}
      {% endif %}
      {% if (httpProxy is not defined or httpProxy == '') and (httpsProxy is not defined or httpsProxy == '') %}
        • Proxy: Not configured
      {% endif %}

      Domain Configuration:
        • UI: {{ FQDN | default('undefined') }}
        • Keycloak: {{ keycloak.domainName | default('undefined') }}
        • Telemetry: {{ telemetry.domainName | default('undefined') }}
        • MinIO: {{ edp.minio.domainName | default('undefined') }}
        • MinIO API: {{ edp.minio.apiDomainName | default('undefined') }}

      Certificate Configuration:
      {% if certs is defined and certs.autoGenerated | default(false) %}
        • Auto-generate certs: enabled
      {% endif %}
      {% if certs is defined and certs.pathToCert is defined and certs.pathToCert != '' %}
        • Cert path: {{ certs.pathToCert }}
      {% endif %}
      {% if certs is defined and certs.pathToKey is defined and certs.pathToKey != '' %}
        • Key path: {{ certs.pathToKey }}
      {% endif %}

      Services Status:
        • Istio: {{ istio.enabled | default('undefined') }}
        • Ingress: {{ ingress.enabled | default('undefined') }}
        • Keycloak: {{ keycloak.enabled | default('undefined') }}
        • APISIX: {{ apisix.enabled | default('undefined') }}
        • Vector DB: {{ vector_databases.enabled | default('undefined') }}
        • EDP: {{ edp.enabled | default('undefined') }}
      {% if edp.enabled and edp.late_chunking is defined %}
        • Late Chunking: {{ edp.late_chunking.enabled | default('undefined') }}
      {% endif %}
        • UI: {{ ui.enabled | default('undefined') }}
        • Telemetry: {{ telemetry.enabled | default('undefined') }}
        • Traces (Telemetry): {{ telemetry.traces.enabled | default('undefined') }}
        • TDX: {{ tdx.enabled | default('undefined') }}

      Model Configuration:
        • LLM Model: {{ llm_model | default('undefined') }}
        • Embedding Model: {{ embedding_model_name | default('undefined') }}
        • Reranking Model: {{ reranking_model_name | default('undefined') }}


      Ready to proceed with deployment!
      ============================================================
  when: configuration_issues | length == 0
  tags:
    - install
    - display-configuration

- name: Fail with all configuration issues
  ansible.builtin.fail:
    msg: |
      CONFIGURATION FAILED

      {{ configuration_issues | length }} issue(s) must be resolved before continuing:

      {% for issue in configuration_issues %}
      {{ loop.index }}. {{ issue }}
      {% endfor %}

      Please resolve all issues above and run the deployment again.
  when: configuration_issues | length > 0
  tags:
    - install
    - display-configuration
    - uninstall
