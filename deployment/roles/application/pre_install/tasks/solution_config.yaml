---
- name: Load huggingToken from HF_TOKEN environment variable if not set in config
  ansible.builtin.set_fact:
    huggingToken: "{{ lookup('env', 'HF_TOKEN') }}"
  when: huggingToken is not defined or huggingToken == "" or huggingToken == "FILL_HERE"
  tags:
    - install
    - display-configuration

- name: Load tdx system variable
  ansible.builtin.set_fact:
    KBS_ADDRESS: "{{ lookup('env', 'KBS_ADDRESS') }}"
  when: tdx.enabled
  tags:
    - install
    - display-configuration

- name: Add KBS_ADDRESS configuration issue
  ansible.builtin.set_fact:
    configuration_issues: "{{ configuration_issues + ['KBS_ADDRESS is not set. Please set the KBS_ADDRESS environment variable when TDX CoCo is enabled.'] }}"
  when: tdx.enabled and (KBS_ADDRESS is not defined or KBS_ADDRESS | length == 0)
  tags:
    - install
    - display-configuration

- name: Set facts for domain names if not defined
  ansible.builtin.set_fact:
    ui: >
      {{ ui | combine({'domainName': FQDN | default(ui.domainName)}) }}
    keycloak: >
      {{ keycloak | combine({'domainName': 'auth.' + FQDN | default(keycloak.domainName)}) }}
    telemetry: >
      {{ telemetry | combine({'domainName': 'grafana.' + FQDN | default(telemetry.domainName)}) }}
    edp: >
      {{ edp | combine({
          'minio': edp.minio | default({}) | combine({
            'domainName': 'minio.' + FQDN | default(edp.minio.domainName),
            'apiDomainName': 's3.' + FQDN | default(edp.minio.apiDomainName)
          })
        })
      }}
  tags:
    - install
    - display-configuration

- name: Add certificate configuration issue
  ansible.builtin.set_fact:
    configuration_issues: "{{ configuration_issues + ['Certificate paths must be provided when autoGenerated is false. Please set certs.pathToCert and certs.pathToKey in the configuration file.'] }}"
  when: certs.autoGenerated is defined and not certs.autoGenerated and (certs.pathToCert is not defined or certs.pathToCert == "" or certs.pathToKey is not defined or certs.pathToKey == "")
  tags:
    - install
    - display-configuration

- name: Add late chunking embedding model compatibility issue
  when:
    - edp.enabled and edp.late_chunking.enabled
  block:
    - name: Set compatible embedding models for late chunking
      ansible.builtin.set_fact:
        late_chunking_compatible_models:
          - "jinaai/jina-embeddings-v2-base-en"
          # Add more compatible models here in the future

    - name: Validate embedding model compatibility for late chunking
      ansible.builtin.set_fact:
        configuration_issues: "{{ configuration_issues + ['Late chunking is enabled but the current embedding model is not compatible. Current value: \"' + (embedding_model_name | default('undefined')) + '\". Compatible models: \"' + (late_chunking_compatible_models | join('\", \"')) + '\". Please change embedding_model_name to one of the compatible models.'] }}"
      when:
        - embedding_model_name | default('undefined') not in late_chunking_compatible_models
  tags:
    - install
    - display-configuration

- name: Display HF_TOKEN warning if not set
  ansible.builtin.debug:
    msg: |
      WARNING: HF_TOKEN is not set!

      If you're using gated models from Hugging Face, you'll need to set the HF_TOKEN
      environment variable or provide huggingToken in your configuration file.

      If you're only using publicly available models, you can ignore this warning.
  when: huggingToken is not defined or huggingToken | length == 0
  tags:
    - install
    - display-configuration
