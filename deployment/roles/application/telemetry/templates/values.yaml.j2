{#
Copyright (C) 2024-2026 Intel Corporation
SPDX-License-Identifier: Apache-2.0
#}

namespace: {{ pipelines[0].namespace }}

kube-prometheus-stack:
    grafana:
{% if telemetry.additional_values.ingress is not defined %}
        ingress:
            enabled: true
            ingressClassName: "nginx"
            pathType: Prefix
            hosts:
                - {{ telemetry.domainName }}
            path: /
            tls:
                - hosts:
                    - {{ telemetry.domainName }}
                  secretName: {{ telemetry.grafana.tls.secret_name }}
{% endif %}
        admin:
            existingSecret: "{{ telemetry.grafana.auth.admin.password_secret_name }}"
            userKey: user
            passwordKey: password
        env:
            https_proxy: "{{ httpsProxy }}"
            http_proxy: "{{ httpProxy }}"
            no_proxy: "{{ noProxy }}"
    prometheus:
        prometheusSpec:
            additionalServiceMonitors:
            - name: redis-cluster-metrics
              selector:
                  matchLabels:
                      app.kubernetes.io/name: prometheus-redis-exporter
                      app.kubernetes.io/instance: telemetry
              namespaceSelector:
                  matchNames:
                  - vdb
              endpoints:
              - port: redis-exporter
                interval: 30s
                relabelings:
                - sourceLabels: [__meta_kubernetes_namespace]
                  targetLabel: namespace
                  action: replace
                - sourceLabels: [__meta_kubernetes_pod_name]
                  targetLabel: pod
                  action: replace
                - sourceLabels: [__meta_kubernetes_pod_node_name]
                  targetLabel: node
                  action: replace
                - sourceLabels: [__meta_kubernetes_service_name]
                  targetLabel: service
                  action: replace
{% if telemetry.additional_values is defined %}
{{ telemetry.additional_values | to_nice_yaml }}
{% endif %}

{% if vector_databases.enabled and vector_databases.vector_store is defined %}
  {% if vector_databases.vector_store == "redis" %}
  prometheus-redis-exporter:
    enabled: true
    redisAddress: redis://vdb-redis-headless.vdb.svc.cluster.local:6379
    serviceMonitor:
      enabled: true
      targets:
        - url: redis://vdb-redis-headless.vdb.svc.cluster.local:6379
          name: redis-vector-db
  {% endif %}

  {% if vector_databases.vector_store == "redis-cluster" %}
  prometheus-redis-exporter:
    enabled: true
    redisAddress: redis://vdb-redis-cluster-headless.vdb.svc.cluster.local:6379
    serviceMonitor:
      enabled: true
      targets:
        - url: redis://vdb-redis-cluster-headless.vdb.svc.cluster.local:6379
          name: redis-vector-db
  {% endif %}
{% endif %}

{% if audio is defined %}
audio:
  enabled: {{ audio.enabled }}
{% endif %}
