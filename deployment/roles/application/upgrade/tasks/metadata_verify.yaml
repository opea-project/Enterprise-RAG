# Copyright (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
# Metadata Verification Task
# This task processes metadata diffs and validates all changes according to validation rules

- name: Clean previous reports directory
  ansible.builtin.file:
    path: "{{ upgrade_reports_dir }}"
    state: absent

- name: Initialize metadata validation facts
  ansible.builtin.set_fact:
    metadata_validations: []
    metadata_mitigations_required: []
    metadata_mitigations_applied: []
    metadata_validation_errors: []

- name: Find all metadata diff files
  ansible.builtin.find:
    paths: "{{ upgrade_metadata_dir }}"
    patterns: "*-upgrade.diff"
  register: metadata_diff_files

# process each component's metadata diff file
- name: Process each metadata diff file
  ansible.builtin.include_tasks:
    file: process_metadata_diff.yaml
  vars:
    diff_file_path: "{{ diff_file_item.path }}"
    diff_file_name: "{{ diff_file_item.path | basename }}"
  loop: "{{ metadata_diff_files.files }}"
  loop_control:
    loop_var: diff_file_item
    label: "{{ diff_file_item.path | basename }}"

- name: Calculate verification result and status
  ansible.builtin.set_fact:
    metadata_verification_result:
      status: "{{ 'failed' if (metadata_validations | selectattr('response', 'equalto', 'reject') | list | length) > 0 or (metadata_mitigations_required | length) != (metadata_mitigations_applied | length) else 'success' }}"
      total_validations: "{{ metadata_validations | length }}"
      approved_count: "{{ metadata_validations | selectattr('response', 'equalto', 'approve') | list | length }}"
      mitigated_count: "{{ metadata_validations | selectattr('response', 'equalto', 'mitigate') | list | length }}"
      rejected_count: "{{ metadata_validations | selectattr('response', 'equalto', 'reject') | list | length }}"
      mitigations_required: "{{ metadata_mitigations_required | length }}"
      mitigations_applied: "{{ metadata_mitigations_applied | length }}"
      mitigations_pending: "{{ (metadata_mitigations_required | length) - (metadata_mitigations_applied | length) }}"
      errors: "{{ metadata_validation_errors }}"

- name: Convert counts to integers
  ansible.builtin.set_fact:
    metadata_verification_result: "{{ metadata_verification_result | combine({'total_validations': metadata_verification_result.total_validations | int, 'approved_count': metadata_verification_result.approved_count | int, 'mitigated_count': metadata_verification_result.mitigated_count | int, 'rejected_count': metadata_verification_result.rejected_count | int, 'mitigations_required': metadata_verification_result.mitigations_required | int, 'mitigations_applied': metadata_verification_result.mitigations_applied | int, 'mitigations_pending': metadata_verification_result.mitigations_pending | int}) }}"

- name: Display metadata verification summary
  ansible.builtin.debug:
    msg:
      - "Metadata Verification Summary:"
      - "  Status: {{ metadata_verification_result.status | upper }}"
      - "  Total Validations: {{ metadata_verification_result.total_validations }}"
      - "  Approved: {{ metadata_verification_result.approved_count }}"
      - "  Mitigated: {{ metadata_verification_result.mitigated_count }}"
      - "  Rejected: {{ metadata_verification_result.rejected_count }}"
      - "  Mitigations Required: {{ metadata_verification_result.mitigations_required }}"
      - "  Mitigations Applied: {{ metadata_verification_result.mitigations_applied }}"
      - "  Mitigations Pending: {{ metadata_verification_result.mitigations_pending }}"

- name: Fail if mitigations are pending
  ansible.builtin.fail:
    msg: "Metadata verification failed: {{ metadata_verification_result.mitigations_pending }} mitigation(s) pending"
  when: metadata_verification_result.mitigations_pending > 0
