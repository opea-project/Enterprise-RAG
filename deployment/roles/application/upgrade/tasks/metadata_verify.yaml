# Copyright (C) 2025-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
# Metadata Verification Task
# Processes metadata diffs and validates changes according to rules
# Cleans up diff/processed files before check, retains on failure

- name: Clean previous reports directory
  ansible.builtin.file:
    path: "{{ upgrade_reports_dir }}"
    state: absent

- name: Initialize metadata validation facts
  ansible.builtin.set_fact:
    metadata_validations: []
    metadata_mitigations_required: []
    metadata_mitigations_applied: []
    metadata_validation_errors: []

- name: Find all metadata diff files
  ansible.builtin.find:
    paths: "{{ upgrade_metadata_dir }}"
    patterns: "*-upgrade.diff"
  register: metadata_diff_files

# process each component's metadata diff file
- name: Process each metadata diff file
  ansible.builtin.include_tasks:
    file: process_metadata_diff.yaml
  vars:
    diff_file_path: "{{ diff_file_item.path }}"
    diff_file_name: "{{ diff_file_item.path | basename }}"
  loop: "{{ metadata_diff_files.files }}"
  loop_control:
    loop_var: diff_file_item
    label: "{{ diff_file_item.path | basename }}"

- name: Calculate verification result and status
  ansible.builtin.set_fact:
    metadata_verification_result:
      status: "{{ 'failed' if (metadata_validations | selectattr('response', 'equalto', 'reject') | list | length) > 0 or (metadata_mitigations_required | length) != (metadata_mitigations_applied | length) else 'success' }}"
      total_validations: "{{ metadata_validations | length }}"
      approved_count: "{{ metadata_validations | selectattr('response', 'equalto', 'approve') | list | length }}"
      mitigated_count: "{{ metadata_validations | selectattr('response', 'equalto', 'mitigate') | list | length }}"
      rejected_count: "{{ metadata_validations | selectattr('response', 'equalto', 'reject') | list | length }}"
      mitigations_required: "{{ metadata_mitigations_required | length }}"
      mitigations_applied: "{{ metadata_mitigations_applied | length }}"
      mitigations_pending: "{{ (metadata_mitigations_required | length) - (metadata_mitigations_applied | length) }}"
      errors: "{{ metadata_validation_errors }}"

- name: Convert counts to integers
  ansible.builtin.set_fact:
    metadata_verification_result: "{{ metadata_verification_result | combine({'total_validations': metadata_verification_result.total_validations | int, 'approved_count': metadata_verification_result.approved_count | int, 'mitigated_count': metadata_verification_result.mitigated_count | int, 'rejected_count': metadata_verification_result.rejected_count | int, 'mitigations_required': metadata_verification_result.mitigations_required | int, 'mitigations_applied': metadata_verification_result.mitigations_applied | int, 'mitigations_pending': metadata_verification_result.mitigations_pending | int}) }}"

- name: Display metadata verification summary
  ansible.builtin.debug:
    msg:
      - "Metadata Verification Summary:"
      - "  Status: {{ metadata_verification_result.status | upper }}"
      - "  Total Validations: {{ metadata_verification_result.total_validations }}"
      - "  Approved: {{ metadata_verification_result.approved_count }}"
      - "  Mitigated: {{ metadata_verification_result.mitigated_count }}"
      - "  Rejected: {{ metadata_verification_result.rejected_count }}"
      - "  Mitigations Required: {{ metadata_verification_result.mitigations_required }}"
      - "  Mitigations Applied: {{ metadata_verification_result.mitigations_applied }}"
      - "  Mitigations Pending: {{ metadata_verification_result.mitigations_pending }}"

- name: Identify clean components (no rejections or mitigations)
  ansible.builtin.set_fact:
    clean_components: "{{ metadata_validations | selectattr('response', 'in', ['approve']) | map(attribute='component') | unique | list }}"
    problem_components: "{{ (metadata_validations | selectattr('response', 'in', ['reject', 'mitigate']) | map(attribute='component') | unique | list) }}"

- name: Clean metadata artifacts for clean components only
  when: clean_components | length > 0
  block:
    - name: Find metadata files for clean components
      ansible.builtin.find:
        paths: "{{ upgrade_metadata_dir }}"
        patterns:
          - "{{ item }}-*-upgrade.diff"
          - "{{ item }}-*-manifest.yaml.processed.yaml"
          - "{{ item }}-*-upgrade.yaml.processed.yaml"
          - "{{ item }}-*-manifest.yaml"
          - "{{ item }}-*-upgrade.yaml"
      register: component_cleanup_files
      loop: "{{ clean_components }}"
      loop_control:
        label: "{{ item }}"

    - name: Remove metadata files for clean components
      ansible.builtin.file:
        path: "{{ file_item.path }}"
        state: absent
      loop: "{{ component_cleanup_files.results | map(attribute='files') | flatten }}"
      loop_control:
        loop_var: file_item
        label: "{{ file_item.path | basename }}"
      when: component_cleanup_files.results | map(attribute='files') | flatten | length > 0

- name: Retain metadata artifacts for problem components
  ansible.builtin.debug:
    msg: "Metadata verification issues detected - diff files retained for components: {{ problem_components | join(', ') }}"
  when: problem_components | length > 0

# Generate report before failing so it's always available
- name: Generate pre-upgrade report
  ansible.builtin.include_tasks:
    file: pre_upgrade_report.yaml
  tags:
    - pre-upgrade

- name: Fail if changes are rejected
  ansible.builtin.fail:
    msg: |
      Metadata verification failed: {{ metadata_verification_result.rejected_count }} change(s) rejected by validation rules.
      Review diff files at {{ upgrade_metadata_dir }} for details.
      Rejected changes must be addressed before upgrade can proceed.
  when: metadata_verification_result.rejected_count > 0

- name: Fail if mitigations are pending
  ansible.builtin.fail:
    msg: "Metadata verification failed: {{ metadata_verification_result.mitigations_pending }} mitigation(s) pending. Review files at {{ upgrade_metadata_dir }}"
  when: metadata_verification_result.mitigations_pending > 0
