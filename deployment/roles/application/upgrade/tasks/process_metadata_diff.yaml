# Copyright (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
# Process Individual Metadata Diff File
# This task reads a diff file and validates each change block

- name: Read metadata diff file
  ansible.builtin.slurp:
    src: "{{ diff_file_path }}"
  register: diff_content_raw

- name: Parse diff content
  ansible.builtin.set_fact:
    diff_content: "{{ diff_content_raw.content | b64decode }}"

- name: Extract component name from filename
  ansible.builtin.set_fact:
    component_name_raw: "{{ diff_file_name | regex_replace('-upgrade\\.diff$', '') }}"

- name: Deduplicate component name (e.g., edp-edp -> edp, auth-apisix-auth-apisix -> auth-apisix)
  ansible.builtin.command:
    cmd: python3 -c "parts = '{{ component_name_raw }}'.split('-'); n = len(parts); result = '{{ component_name_raw }}'; [result := '-'.join(parts[:i]) for i in range(1, n) if '-'.join(parts[:i]) == '-'.join(parts[i:])]; print(result)"
  register: component_name_dedup
  changed_when: false

- name: Set deduplicated component name
  ansible.builtin.set_fact:
    component_name: "{{ component_name_dedup.stdout }}"

- name: Initialize validation rules list
  ansible.builtin.set_fact:
    all_validation_rules: []

- name: Try loading component-specific validation rules (implicit lookup by name)
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../upgrade/rules/{{ component_name }}.yaml"
  ignore_errors: true
  register: component_rules_loaded

- name: Add component-specific rules to list (checked first)
  ansible.builtin.set_fact:
    all_validation_rules: "{{ validation_rules | default([]) }}"
  when: component_rules_loaded is succeeded

- name: Note when using default rules only
  ansible.builtin.debug:
    msg: "No component-specific rules for '{{ component_name }}', using default validation rules only"
  when: component_rules_loaded is failed

- name: Load default validation rules (always loaded)
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../upgrade/rules/all-default.yaml"
  ignore_errors: true
  register: default_rules_loaded

- name: Append default rules to list (checked last)
  ansible.builtin.set_fact:
    all_validation_rules: "{{ all_validation_rules + (validation_rules | default([])) }}"
  when: default_rules_loaded is succeeded

- name: Apply hard-coded fallback if no rules loaded at all
  ansible.builtin.set_fact:
    all_validation_rules:
      - path_regex: ".*"
        response: "reject"
        note: "All changes require explicit approval - no validation rules found"
  when: all_validation_rules | length == 0

- name: Split diff into blocks using Python
  ansible.builtin.command:
    cmd: python3 -c "import re, sys, json; content = sys.stdin.read(); pattern = r'((?:<<<|>>>)[^:]+:[\\s\\S]*?)(?=(?:<<<|>>>)[^:]+:|<<<>>>|\\Z)'; blocks = re.findall(pattern, content, re.MULTILINE); print(json.dumps([b.strip() for b in blocks]))"
    stdin: "{{ diff_content }}"
  register: split_result
  changed_when: false

- name: Parse split results
  ansible.builtin.set_fact:
    diff_blocks: "{{ split_result.stdout | from_json }}"

- name: Process each diff block with validation rules
  ansible.builtin.include_tasks:
    file: validate_metadata_change.yaml
  vars:
    change_block: "{{ item }}"
    change_index: "{{ ansible_loop.index }}"
  loop: "{{ diff_blocks }}"
  loop_control:
    extended: yes
    label: "Block {{ ansible_loop.index }}"
  when: diff_blocks | length > 0

- name: Record validation for empty diff
  ansible.builtin.set_fact:
    metadata_validations: "{{ metadata_validations + [{'component': component_name, 'file': diff_file_name, 'response': 'approve', 'note': 'No changes detected', 'timestamp': ansible_date_time.iso8601}] }}"
  when: diff_blocks | length == 0
