# Copyright (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
# Upgrade Result Task
# This task evaluates the overall upgrade readiness based on all checks

- name: Initialize pre-upgrade result
  ansible.builtin.set_fact:
    upgrade_result:
      ready: true
      issues: []
      warnings: []

- name: Check version validation result (placeholder for future)
  ansible.builtin.set_fact:
    upgrade_result: "{{ upgrade_result | combine({'ready': false, 'issues': upgrade_result.issues + ['Version check not yet implemented']}) }}"
  when: false  # Will be enabled when version check is implemented

- name: Check metadata verification result
  ansible.builtin.set_fact:
    upgrade_result: "{{ upgrade_result | combine({'ready': false, 'issues': upgrade_result.issues + ['Metadata verification failed: ' + (metadata_verification_result.mitigations_pending | string) + ' pending mitigation(s)']}) }}"
  when:
    - metadata_verification_result is defined
    - metadata_verification_result.status == 'failed'

- name: Check for rejected changes
  ansible.builtin.set_fact:
    upgrade_result: "{{ upgrade_result | combine({'ready': false, 'issues': upgrade_result.issues + ['Metadata verification rejected: ' + (metadata_verification_result.rejected_count | string) + ' change(s) require manual review and cannot proceed']}) }}"
  when:
    - metadata_verification_result is defined
    - metadata_verification_result.rejected_count > 0

- name: Display pre-upgrade result summary
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "Pre-Upgrade Assessment Result"
      - "=========================================="
      - "Ready for Upgrade: {{ 'YES' if upgrade_result.ready else 'NO' }}"
      - "Issues: {{ upgrade_result.issues | length }}"
      - "Warnings: {{ upgrade_result.warnings | length }}"
      - "=========================================="

- name: Display issues
  ansible.builtin.debug:
    msg: "{{ upgrade_result.issues }}"
  when: upgrade_result.issues | length > 0

- name: Display warnings
  ansible.builtin.debug:
    msg: "{{ upgrade_result.warnings }}"
  when: upgrade_result.warnings | length > 0

- name: Fail if upgrade is not ready
  ansible.builtin.fail:
    msg: |
      Pre-upgrade assessment failed. The system is not ready for upgrade.

      Issues found: {{ upgrade_result.issues | length }}
      {% for issue in upgrade_result.issues %}
      - {{ issue }}
      {% endfor %}

      Please review the pre-upgrade report at: {{ upgrade_reports_dir }}/pre-upgrade-report.md
  when: not upgrade_result.ready

- name: Success message
  ansible.builtin.debug:
    msg: |
      âœ… Pre-upgrade assessment completed successfully!

      The system is ready for upgrade.
      {% if upgrade_result.warnings | length > 0 %}

      Note: {{ upgrade_result.warnings | length }} warning(s) detected. Please review the report.
      {% endif %}

      Full report available at: {{ upgrade_reports_dir }}/pre-upgrade-report.md
  when: upgrade_result.ready
