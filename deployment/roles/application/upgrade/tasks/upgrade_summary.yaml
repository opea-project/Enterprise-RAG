# Copyright (C) 2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
# Generate upgrade summary report after installation
# Summarizes mode detection, data consistency, health status

- name: Ensure reports directory exists
  ansible.builtin.file:
    path: "{{ upgrade_reports_dir }}"
    state: directory
    mode: '0755'

- name: Generate upgrade summary report
  ansible.builtin.copy:
    dest: "{{ upgrade_reports_dir }}/upgrade-summary.md"
    mode: '0644'
    content: |
      # Upgrade Summary Report

      Generated: {{ ansible_date_time.iso8601 }}

      ## Installation Mode

      | Property | Value |
      |----------|-------|
      | Mode | {{ install_mode | default('fresh_install') | upper }} |
      | Previous Version | {{ deployed_ver | default('N/A') }} |
      | Installed Version | {{ solution_version }} |

      ## Health Status

      ### Pre-Install Health
      {% if pre_install_health_check is defined %}
      - Status: {{ pre_install_health_check.status | default('unknown') }}
      - Undesirable Pods: {{ pre_install_health_check.undesirable_pods | default([]) | length }}
      {% else %}
      - Status: Not captured
      {% endif %}

      ### Post-Install Health
      {% if post_install_health_check is defined %}
      - Status: {{ post_install_health_check.status | default('unknown') }}
      - Undesirable Pods: {{ post_install_health_check.undesirable_pods | default([]) | length }}
      {% else %}
      - Status: Not captured
      {% endif %}

      ## Data Consistency

      {% if data_consistency_pre_report is defined %}
      ### Pre-Upgrade Data
      {{ data_consistency_pre_report | default('Not captured') }}
      {% endif %}

      {% if data_consistency_post_report is defined %}
      ### Post-Upgrade Data
      {{ data_consistency_post_report | default('Not captured') }}
      {% endif %}

      ## Metadata Verification

      {% if metadata_verification_result is defined %}
      - Status: {{ metadata_verification_result.status | default('N/A') | upper }}
      - Validations: {{ metadata_verification_result.total_validations | default(0) }}
      - Approved: {{ metadata_verification_result.approved_count | default(0) }}
      - Rejected: {{ metadata_verification_result.rejected_count | default(0) }}
      {% else %}
      - Status: Not performed (fresh install or refresh)
      {% endif %}

      ## Result

      {% if post_install_health_check is defined and post_install_health_check.status == 'success' %}
      **SUCCESS** - Upgrade completed successfully
      {% elif post_install_health_check is defined %}
      **WARNING** - Upgrade completed with health issues
      {% else %}
      **UNKNOWN** - Health status not captured
      {% endif %}
  when: is_upgrade_mode | default(false) | bool

- name: Display upgrade summary location
  ansible.builtin.debug:
    msg: "Upgrade summary report: {{ upgrade_reports_dir }}/upgrade-summary.md"
  when: is_upgrade_mode | default(false) | bool
