- name: Set balloons policy file
  ansible.builtin.set_fact:
    balloons_policy_file: "{{ tmp_dir }}/{{ balloons.helm.release_name }}-{{ item.key }}-override-values.yaml"
  tags:
    - install

- name: Generate Balloons policy
  ansible.builtin.template:
    src: "values.yaml.j2"
    dest: "{{ balloons_policy_file }}"
    mode: '0644'
  vars:
    nodeName: "{{ item.key }}"
    amx_supported: "{{ item.value.amx_supported }}"
    maxBalloonsVLLM: "{{ item.value.maxBalloonsVLLM }}"
    maxBalloonsReranker: "{{ item.value.maxBalloonsReranker }}"
    vllm_cpus: "{{ VLLM_CPUS }}"
    reranker_cpus: "{{ RERANKER_CPUS }}"
  tags:
    - install

- name: Apply balloons policy
  kubernetes.core.k8s:
    state: present
    src: "{{ balloons_policy_file }}"
  tags:
    - install

- name: Identify if node is eligible for inference
  set_fact:
    inference_eligible_label: >-
      {{ 'true' if (item.value.amx_supported | bool and item.value.maxBalloonsReranker | int != 0) else 'false' }}
  tags:
    - install

- name: Identify if node is eligible for vllm
  set_fact:
    inference_eligible_vllm_label: >-
      {{ 'true' if (item.value.amx_supported | bool and item.value.maxBalloonsVLLM | int != 0) else 'false' }}
  tags:
    - install

- name: Label node as inference-eligible for inference
  kubernetes.core.k8s:
    state: patched
    kind: Node
    api_version: v1
    name: "{{ item.key }}"
    definition:
      metadata:
        name: "{{ item.key }}"
        labels:
          inference-eligible: "{{ inference_eligible_label | string | lower }}"
  tags:
    - install

- name: Label node as inference-eligible for vllm
  kubernetes.core.k8s:
    state: patched
    kind: Node
    api_version: v1
    name: "{{ item.key }}"
    definition:
      metadata:
        name: "{{ item.key }}"
        labels:
          inference-eligible-vllm: "{{ inference_eligible_vllm_label | string | lower }}"
  tags:
    - install

- name: Add taint if node is eligible for vllm
  kubernetes.core.k8s:
    state: patched
    kind: Node
    api_version: v1
    name: "{{ item.key }}"
    definition:
      spec:
        taints:
          - key: inference_eligible_vllm
            value: "true"
            effect: PreferNoSchedule
  when: inference_eligible_vllm_label | lower == 'true'
  tags:
    - install

- name: Add taint if node is eligible for inference
  kubernetes.core.k8s:
    state: patched
    kind: Node
    api_version: v1
    name: "{{ item.key }}"
    definition:
      spec:
        taints:
          - key: inference_eligible
            value: "true"
            effect: PreferNoSchedule
  when: inference_eligible_label | lower == 'true'
  tags:
    - install
