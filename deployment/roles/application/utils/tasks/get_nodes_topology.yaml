# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Ensure topology-discovery namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: topology-discovery
  tags:
    - install
    - topology-preview

- name: label topology-discovery namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: topology-discovery
        labels:
          pod-security.kubernetes.io/enforce: "privileged"
  when: enforcePSS
  tags:
    - install
    - topology-preview

- name: Create a topology discovery daemonset
  kubernetes.core.k8s:
    state: present
    namespace: topology-discovery
    definition:
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: node-topology-debugger
        namespace: topology-discovery
      spec:
        selector:
          matchLabels:
            app: node-topology-debugger
        template:
          metadata:
            labels:
              app: node-topology-debugger
          spec:
            securityContext:
              fsGroup: 2000
              runAsGroup: 3000
              runAsNonRoot: true
              runAsUser: 1000
              seccompProfile:
                type: RuntimeDefault
            containers:
            - name: ubuntu
              image: ubuntu
              command: [ "sleep", "infinity" ]
            restartPolicy: Always
  tags:
    - install
    - topology-preview

- name: Wait for node-topology-debugger pods to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: topology-discovery
    label_selectors:
      - app=node-topology-debugger
  register: pods_info
  until: pods_info.resources | length > 0 and (pods_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length) == (pods_info.resources | length)
  retries: 30
  delay: 10
  tags:
    - install
    - topology-preview

- name: Initialize cpu_topology_per_node dict
  set_fact:
    cpu_topology_per_node: {}
  tags:
    - install
    - topology-preview

- name: Set default VLLM_CPUS from resources reference file
  set_fact:
    VLLM_CPUS: >-
      {{
        (
          (
            lookup('file', pipelines_dir ~ '/' ~ (
              pipelines
              | selectattr('type', 'in', ['chatqa', 'docsum'])
              | map(attribute='resourcesPath')
              | first
            ), errors='ignore')
            | from_yaml
          )
          | default({})
        ).get('services', {}).get('vllm', {}).get('resources', {}).get('requests', {}).get('cpu', 0)
        | int
      }}
  tags:
    - install
    - topology-preview

- name: Set RERANKER_CPUS from resources reference file
  set_fact:
    RERANKER_CPUS: >-
      {{
        (
          (
            lookup('file', pipelines_dir ~ '/' ~ (
              pipelines
              | selectattr('type', 'in', ['chatqa', 'docsum'])
              | map(attribute='resourcesPath')
              | first
            ), errors='ignore')
            | from_yaml
          )
          | default({})
        ).get('services', {}).get('torchserve_reranking', {}).get('resources', {}).get('requests', {}).get('cpu', 0)
        | int
      }}
  tags:
    - install
    - topology-preview

- name: Set EMBEDDING_CPUS from resources reference file
  set_fact:
    EMBEDDING_CPUS: >-
      {{
        (
          (
            lookup('file', pipelines_dir ~ '/' ~ (
              pipelines
              | selectattr('type', 'in', ['chatqa', 'docsum'])
              | map(attribute='resourcesPath')
              | first
            ), errors='ignore')
            | from_yaml
          )
          | default({})
        ).get('services', {}).get('torchserve_embedding', {}).get('resources', {}).get('requests', {}).get('cpu', 0)
        | int
      }}
  tags:
    - install
    - topology-preview

- name: Gather CPU/NUMA/AMX info for each node
  include_tasks: get_single_node_topology.yaml
  vars:
    node_name: "{{ item.spec.nodeName }}"
    pod_name: "{{ item.metadata.name }}"
  loop: "{{ pods_info.resources }}"
  loop_control:
    label: "{{ item.spec.nodeName }}"
  tags:
    - install
    - topology-preview

- name: Check if any node is Gaudi
  set_fact:
    gaudi_detected: "{{ cpu_topology_per_node.values() | selectattr('gaudi', 'equalto', true) | list | length > 0 }}"
  tags:
    - install
    - topology-preview

- name: Calculate optimal replicas using Python script
  ansible.builtin.shell: |
    python3 {{ playbook_dir }}/../scripts/calculate_replicas.py \
      --nodes-dict '{{ cpu_topology_per_node | to_json }}' \
      --vllm-size {{ VLLM_CPUS }} \
      --reranking-size {{ RERANKER_CPUS }} \
      --embedding-size {{ EMBEDDING_CPUS }} \
      --throughput-mode {{ balloons.throughput_mode | default(true) }} \
      --edp-enabled {{ edp.enabled | default(false) }} \
      --telemetry-enabled {{ telemetry.enabled | default(false) }} \
      --vector-databases-enabled {{ vector_databases.enabled | default(false) }} \
      --memory-overcommit-buffer-percent {{ balloons.memory_overcommit_buffer | default(0.1) }}
  register: replicas_calculation_result
  tags:
    - install
    - topology-preview

- name: Delete node-topology-debugger daemonset
  kubernetes.core.k8s:
    state: absent
    kind: DaemonSet
    name: node-topology-debugger
    namespace: topology-discovery
  tags:
    - install
    - uninstall
    - topology-preview

- name: Delete topology-discovery namespace
  kubernetes.core.k8s:
    state: absent
    kind: Namespace
    name: topology-discovery
  tags:
    - install
    - uninstall
    - topology-preview

- name: Create log directory if it does not exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '755'
  loop:
    - "{{ log_dir }}"
    - "{{ tmp_dir }}"
  tags:
    - install
    - topology-preview

- name: Save replicas calculation output to file
  copy:
    content: "{{ replicas_calculation_result.stdout | from_json | to_nice_json }}"
    dest: "{{ tmp_dir }}/inference_pods_distribution.yaml"
    mode: '0644'
  tags:
    - install
    - topology-preview

- name: Display topology calculation results
  ansible.builtin.pause:
    prompt: |
      ============================================================
      Topology calculation complete!
      Results saved to: {{ tmp_dir }}/inference_pods_distribution.yaml

      Review the results below and press ENTER to continue...
      ============================================================

      ====== Topology Calculation Summary ======
      {% for node, info in (replicas_calculation_result.stdout | from_json).items() if node not in ['total_replicas', 'gaudi_nodes_count'] %}
      Node: {{ node }}
        Inference Groups: {{ info.replicas }}
        Adjusted VLLM Size: {{ info.adjusted_vllm_size }}
        Calculation Method: {{ info.calculation_method }}
        Gaudi: {{ info.gaudi | default(false) }}
        AMX Supported: {{ info.amx_supported | default(false) }}
        Inference memory request: {{ info.memory_usage_percent }}%
        VLLM Replicas: {{ info.vllm.replicas }}
        VLLM CPU Size: {{ info.vllm.adjusted_cpu_size }}
        Embedding Replicas: {{ info.torchserve_embedding.replicas }}
        Embedding CPU Size: {{ info.torchserve_embedding.cpu_size }}
        Reranking Replicas: {{ info.torchserve_reranking.replicas }}
        Reranking CPU Size: {{ info.torchserve_reranking.cpu_size }}
      ------------------------------------------
      {% endfor %}
      Total Inference Groups (Counted for non-Gaudi nodes with AMX support): {{ (replicas_calculation_result.stdout | from_json).total_replicas }}
      Gaudi Nodes Count: {{ (replicas_calculation_result.stdout | from_json).gaudi_nodes_count }}
      ==========================================
  tags:
    - topology-preview

- name: Parse replicas calculation output
  set_fact:
    optimal_replicas: "{{ replicas_calculation_result.stdout | trim | from_json }}"
  tags:
    - install
    - topology-preview

- name: Fail if no possible working setup (no replicas and no Gaudi nodes)
  fail:
    msg: >-
      No possible working setup: total_replicas and gaudi_nodes_count are both zero.
      The current hardware topology does not allow any service replicas to be scheduled.
      Please check your cluster configuration and available resources.
  when:
    - optimal_replicas.total_replicas == 0
    - optimal_replicas.gaudi_nodes_count == 0
  tags:
    - install
    - topology-preview
