# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Generate self-signed certificate
  when: certs.autoGenerated
  tags:
    - install
  block:
    - name: Set list of domain names for CSR
      ansible.builtin.set_fact:
        extra_san: >-
          {{
            [] +
            ([ui.domainName] if ui.enabled | default(false) else []) +
            ([keycloak.domainName] if keycloak.enabled | default(false) else []) +
            ([edp.minio.domainName] if (edp.enabled and edp.storageType == "minio") | default(false) else []) +
            ([edp.minio.apiDomainName] if (edp.enabled and edp.storageType == "minio") | default(false) else []) +
            ([telemetry.domainName] if telemetry.enabled | default(false) else [])
          }}
      tags:
        - install

    - name: Generate a private key
      community.crypto.openssl_privatekey:
        path: "{{ log_dir }}/tls.key"
        type: RSA
        size: 4096
      tags:
        - install

    - name: Generate a CSR with SANs
      community.crypto.openssl_csr:
        path: "{{ log_dir }}/tls.csr"
        privatekey_path: "{{ log_dir }}/tls.key"
        common_name: "{{ FQDN }}"
        subject_alt_name: "{{ extra_san | map('regex_replace', '^', 'DNS:') | join(',') }}"
      tags:
        - install

    - name: Generate a self-signed certificate with SANs
      community.crypto.x509_certificate:
        path: "{{ log_dir }}/tls.crt"
        privatekey_path: "{{ log_dir }}/tls.key"
        csr_path: "{{ log_dir }}/tls.csr"
        provider: selfsigned
        state: present
      tags:
        - install

    - name: Set the path to the generated certificate and key
      ansible.builtin.set_fact:
        pathToCert: "{{ log_dir }}/tls.crt"
        pathToKey: "{{ log_dir }}/tls.key"
      tags:
        - install

- name: Load existing certificates
  ansible.builtin.set_fact:
    pathToCert: "{{ certs.pathToCert }}"
    pathToKey: "{{ certs.pathToKey }}"
  when: not certs.autoGenerated
  tags:
    - install
