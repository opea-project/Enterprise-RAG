# Copyright (C) 2025-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
- name: Transform upgrade file to manifest format
  ansible.builtin.shell: |
    python3 -c "
    import yaml
    import sys
    with open('{{ upgrade_file_path }}', 'r') as f:
        docs = list(yaml.safe_load_all(f))
    docs = [doc for doc in docs if doc is not None]
    with open('{{ upgrade_file_path }}.transformed.yaml', 'w') as f:
        yaml.dump(docs, f, default_flow_style=False, sort_keys=True)
    "
  args:
    creates: "{{ upgrade_file_path }}.transformed.yaml"

- name: Transform manifest file
  ansible.builtin.copy:
    src: "{{ manifest_file_path }}"
    dest: "{{ manifest_file_path }}.transformed.yaml"
    remote_src: true

- name: Process manifest files with transformer
  ansible.builtin.script:
    cmd: >
      {{ role_path }}/files/manifest_transformer.py
      {{ manifest_file_path }}.transformed.yaml
      {{ upgrade_file_path }}.transformed.yaml
      {{ manifest_file_path }}.processed.yaml
      {{ upgrade_file_path }}.processed.yaml
  args:
    executable: python3

- name: Load processed manifest data
  ansible.builtin.slurp:
    src: "{{ manifest_file_path }}.processed.yaml"
  register: processed_manifest_data

- name: Load processed upgrade data
  ansible.builtin.slurp:
    src: "{{ upgrade_file_path }}.processed.yaml"
  register: processed_upgrade_data

- name: Generate structured diff
  ansible.builtin.command:
    cmd: >
      python3 {{ playbook_dir }}/../scripts/metadata_diff.py
      {{ manifest_file_path }}.processed.yaml
      {{ upgrade_file_path }}.processed.yaml
      {{ upgrade_metadata_dir }}/{{ release_namespace }}-{{ release_name }}-upgrade.diff
  register: structured_diff_result

- name: Clean up temporary files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ manifest_file_path }}.transformed.yaml"
    - "{{ upgrade_file_path }}.transformed.yaml"
  # Note: .processed.yaml and .diff files are retained for debugging and cleaned up
  # only for clean components after successful verification in metadata_verify.yaml
