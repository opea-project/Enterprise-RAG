# Copyright (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
- name: Password management tasks for deployment passwords
  vars:
    secure_logs: true
  no_log: "{{ secure_logs }}"
  block:
    - name: Find all secrets labeled with managed secret indicator
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        label_selectors:
          - "{{ managed_secret_label }}=true"
      register: managed_secrets

    - name: Initialize password_image
      set_fact:
        password_image: {}

    - name: Parse password mappings from annotation
      set_fact:
        password_mappings: "{{ (item.metadata.annotations[password_mappings_annotation] | default('') | from_yaml) if item.metadata.annotations[password_mappings_annotation] is defined else [] }}"
      loop: "{{ managed_secrets.resources }}"
      vars:
        item: "{{ current_secret }}"
      register: password_mappings_results

    - name: Extract passwords from secret
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: "{{ item.metadata.name }}"
        namespace: "{{ item.metadata.namespace }}"
      loop: "{{ managed_secrets.resources }}"
      when: item.metadata.annotations[password_mappings_annotation] is defined and item.metadata.annotations[password_mappings_annotation] != ""
      register: extracted_passwords

    - name: Store extracted passwords in password_image
      set_fact:
        password_image: "{{ password_image | combine(secret_passwords) }}"
      vars:
        secret_passwords: |
          {%- set result = {} -%}
          {%- if item.resources and item.resources[0] -%}
            {%- set secret = item.resources[0] -%}
            {%- set mappings = (secret.metadata.annotations[password_mappings_annotation] | default('') | from_yaml) if secret.metadata.annotations[password_mappings_annotation] is defined else [] -%}
            {%- for mapping in mappings -%}
              {%- set parts = mapping.split('=') -%}
              {%- if parts | length == 2 -%}
                {%- set variable = parts[0] -%}
                {%- set key = parts[1] -%}
                {%- if variable.endswith('_USERNAME') -%}
                  {%- set _ = result.update({variable: key}) -%}
                {%- elif secret.data[key] is defined -%}
                  {%- set _ = result.update({variable: secret.data[key] | b64decode}) -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
          {{ result }}
      loop: "{{ extracted_passwords.results }}"
      when: item.resources is defined and item.resources | length > 0

    - name: Check if credentials file exists
      stat:
        path: "{{ password_file }}"
      register: credentials_file_stat

    - name: Load existing credentials from file
      slurp:
        src: "{{ password_file }}"
      register: existing_credentials_raw
      when: credentials_file_stat.stat.exists

    - name: Parse existing credentials
      set_fact:
        existing_credentials: "{{ (existing_credentials_raw.content | b64decode | from_yaml) if credentials_file_stat.stat.exists and (existing_credentials_raw.content | b64decode | from_yaml) is mapping else {} }}"

    - name: Merge discovered passwords with existing credentials
      set_fact:
        merged_credentials: "{{ existing_credentials | combine(password_image) }}"

    - name: Generate credentials file from merged password image
      template:
        src: credentials_template.j2
        dest: "{{ password_file }}"
      vars:
        credentials: "{{ merged_credentials }}"
