---
- name: Pre-fetch role defaults for early availability
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../roles/application/{{ item }}/defaults/main.yaml"
  loop:
    - istio
    - ingress
    - keycloak
    - apisix
    - telemetry
    - ui
    - vector_databases
    - edp
    - fingerprint
    - chat_history
    - nri_balloons
    - pipeline
    - tdx
    - rag_utils
  tags:
    - config

- name: Set default ansible fact
  ansible.builtin.set_fact:
    config_valid: true
  tags:
    - config

# Check if required fields are set
- name: Check if required fields are set
  ansible.builtin.set_fact:
    config_valid: false
    missing_fields: "{{ missing_fields | default([]) + [item.field] }}"
  when: (item.value is not defined) or (item.value | length == 0) or (item.value == 'FILL_HERE')
  loop:
    - { field: "FQDN", value: "{{ FQDN | default('') }}" }
  no_log: "{{ secure_logs }}"
  tags:
    - config

# Check huggingToken and add warning if missing
- name: Check huggingToken configuration
  ansible.builtin.set_fact:
    hugging_token_warnings: "{{ hugging_token_warnings | default([]) + ['Hugging Face token is not configured - gated models in Hugging Face will not be accessible'] }}"
  when: (huggingToken is not defined) or (huggingToken | length == 0)
  no_log: "{{ secure_logs }}"
  tags:
    - config

# Check kubeconfig if deploy_k8s is false
- name: Check if kubeconfig exists
  tags:
    - config
  block:
    - name: Check if kubeconfig exists
      ansible.builtin.stat:
        path: "{{ kubeconfig }}"
      register: kubeconfig_stat

    - name: Set kubeconfig issues if file doesn't exist
      ansible.builtin.set_fact:
        config_valid: false
        kubeconfig_issues: "{{ kubeconfig_issues | default([]) + ['Kubeconfig file not found at ' + kubeconfig] }}"
      when: not kubeconfig_stat.stat.exists

# Check CSI driver type
- name: Check CSI driver type
  ansible.builtin.set_fact:
    config_valid: false
    invalid_csi: "{{ install_csi }}"
  when: install_csi is defined and install_csi | length > 0 and install_csi not in ['local-path-provisioner', 'nfs', 'netapp-trident']
  tags:
    - config

# Check certificates configuration
- name: Check certificates configuration
  when: (certs is defined) and (certs.autoGenerated is defined) and (not certs.autoGenerated | bool)
  tags:
    - config
  block:
    - name: Check certificate paths
      ansible.builtin.set_fact:
        config_valid: false
        cert_issues: "{{ cert_issues | default([]) + [item.issue] }}"
      when: (item.value is not defined) or (item.value | length == 0)
      loop:
        - { issue: "Certificate path not specified", value: "{{ certs.pathToCert | default('') }}" }
        - { issue: "Certificate key path not specified", value: "{{ certs.pathToKey | default('') }}" }

# Check late chunking and embedding model compatibility
- name: Check late chunking and embedding model compatibility
  when: edp.enabled and edp.late_chunking.enabled
  tags:
    - config
  block:
    - name: Set compatible embedding models for late chunking
      ansible.builtin.set_fact:
        late_chunking_compatible_models:
          - "jinaai/jina-embeddings-v2-base-en"
          # Add more compatible models here in the future

    - name: Validate embedding model compatibility for late chunking
      ansible.builtin.set_fact:
        late_chunking_issues: "{{ late_chunking_issues | default([]) + ['Late chunking is enabled but the current embedding model is not compatible. Current value: \"' + (embedding_model_name | default('undefined')) + '\". Compatible models: \"' + (late_chunking_compatible_models | join('\", \"')) + '\". Please change embedding_model_name to one of the compatible models.'] }}"
      when: embedding_model_name | default('undefined') not in late_chunking_compatible_models

    - name: Update config validity based on late chunking embedding model compatibility check
      ansible.builtin.set_fact:
        config_valid: "{{ config_valid and (late_chunking_issues is not defined or late_chunking_issues | length == 0) }}"

# Check balloons and vLLM embedding compatibility
- name: Check balloons and vLLM embedding compatibility
  when: balloons is defined and balloons.enabled is defined and balloons.enabled
  tags:
    - config
  block:
    - name: Check each pipeline for vLLM embedding usage
      ansible.builtin.set_fact:
        vllm_embedding_issues: "{{ vllm_embedding_issues | default([]) + ['Pipeline \"' + item.namespace + '\" uses vLLM for embeddings (VLLMEmbedding service) which is not supported with balloons policy. Please use TorchServe for embeddings when balloons are enabled, or disable balloons to use vLLM embeddings.'] }}"
      when:
        - item.samplePath is defined
        - lookup('file', pipelines_dir + '/' + item.samplePath) is search('VLLMEmbedding')
      loop: "{{ pipelines }}"

    - name: Update config validity based on balloons and vLLM embedding compatibility check
      ansible.builtin.set_fact:
        config_valid: "{{ config_valid and (vllm_embedding_issues is not defined or vllm_embedding_issues | length == 0) }}"

# Display validation results
- name: Display validation results
  ansible.builtin.debug:
    msg: |
      Configuration validation results:
      {% if not config_valid %}
      VALIDATION FAILED: Issues were found in your configuration
      {% if missing_fields is defined and missing_fields|length > 0 %}
      - Missing required fields: {{ missing_fields | join(', ') }}
      {% endif %}
      {% if kubeconfig_issues is defined and kubeconfig_issues|length > 0 %}
      - Kubeconfig issues:
        {% for issue in kubeconfig_issues %}
        * {{ issue }}
        {% endfor %}
      {% endif %}
      {% if invalid_csi is defined %}
      - Invalid CSI driver type: '{{ invalid_csi }}'. Supported types are: 'local-path-provisioner', 'nfs'
      {% endif %}
      {% if late_chunking_issues is defined and late_chunking_issues|length > 0 %}
      - Late chunking configuration issues:
        {% for issue in late_chunking_issues %}
        * {{ issue }}
        {% endfor %}
      {% endif %}
      {% if vllm_embedding_issues is defined and vllm_embedding_issues|length > 0 %}
      - vLLM embedding with balloons configuration issues:
        {% for issue in vllm_embedding_issues %}
        * {{ issue }}
        {% endfor %}
      {% endif %}
      {% else %}
      VALIDATION PASSED: Configuration is valid
      - Kubeconfig: {{ kubeconfig }} exists.
      {% if huggingToken is defined and huggingToken | length > 0 %}
      - Hugging Face token is configured properly
      {% endif %}
      {% if edp.enabled and edp.late_chunking.enabled %}
      - Late chunking is configured properly with compatible embedding model: {{ embedding_model_name }}
      {% endif %}
      {% endif %}
      {% if hugging_token_warnings is defined and hugging_token_warnings|length > 0 %}

      WARNINGS:
      {% for warning in hugging_token_warnings %}
      - {{ warning }}
      {% endfor %}
      {% endif %}
  tags:
    - config

- name: Fail if validation failed
  ansible.builtin.fail:
    msg: "Configuration validation failed. Please fix the issues described above."
  when: not config_valid
  tags:
    - config
