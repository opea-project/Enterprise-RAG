- name: Validate local registry configuration
  ansible.builtin.fail:
    msg: |
      Local registry is enabled but 'insecure_registry' variable is not defined or empty.

      To fix this, add the following to your config.yaml:

      local_registry: true
      insecure_registry: "registry_host:32000"

      Where:
      - The hostname should be available for all the nodes (for example, you can use your control plane node for simplicity)
      - The port should be an unused NodePort (30000-32767 range)
  when:
    - local_registry is defined
    - local_registry | bool
    - (insecure_registry is not defined or insecure_registry == "")
  tags:
    - install
    - post-install

- name: Create namespace for local registry
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: local-registry
    state: present
  tags:
    - install
    - post-install

- name: Wait for default service account in local-registry
  kubernetes.core.k8s_info:
    kind: ServiceAccount
    namespace: local-registry
    name: default
  register: sa_info
  until: sa_info.resources | length > 0
  retries: 10
  delay: 3
  tags:
    - install
    - post-install

- name: Create registry pod
  kubernetes.core.k8s:
    api_version: v1
    kind: Pod
    namespace: local-registry
    name: registry
    definition:
      metadata:
        labels:
          app: registry
      spec:
        containers:
          - name: registry
            image: registry:2
            ports:
              - containerPort: 5000
    state: present
  tags:
    - install
    - post-install

- name: Create registry service
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'registry-service.yaml.j2') | from_yaml }}"
  tags:
    - install
    - post-install

- name: Delete registry service
  kubernetes.core.k8s:
    api_version: v1
    kind: Service
    namespace: local-registry
    name: registry
    state: absent
  tags:
    - delete

- name: Delete registry pod
  kubernetes.core.k8s:
    api_version: v1
    kind: Pod
    namespace: local-registry
    name: registry
    state: absent
  tags:
    - delete

- name: Delete namespace for local registry
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: local-registry
    state: absent
  tags:
    - delete
