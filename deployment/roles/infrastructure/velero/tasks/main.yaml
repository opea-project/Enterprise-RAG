# Copyright (C) 2024-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
- name: Create tmp directory if it does not exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '755'
  loop:
    - "{{ log_dir }}"
    - "{{ tmp_dir }}"
  tags:
    - install
    - post-install

- name: Load credentials from password management
  ansible.builtin.include_role:
    name: password_mgmt
    tasks_from: lookup.yaml
    apply:
      tags:
        - install
        - post-install
  tags:
    - install
    - post-install

- name: Validate options
  fail:
    msg: "Configuration is not valid: enabling velero requires install_server or install_client to be true."
  when: not velero.install_server and not velero.install_client
  tags:
    - install
    - post-install

- name: Set roles facts
  ansible.builtin.set_fact:
    velero_helm_override_values_path: "{{ tmp_dir }}/{{ velero.helm.chart_name }}-override-values.yaml"
  tags:
    - install
    - post-install

- name: Ensure Helm repositories
  kubernetes.core.helm_repository:
    name: "{{ velero.helm.repo_name }}"
    repo_url: "{{ velero.helm.repo_url }}"
    state: present
  when: velero.install_server
  tags:
    - install
    - post-install

- name: Ensure SeaweedFS Helm repository
  kubernetes.core.helm_repository:
    name: "{{ velero.helm.repo_seaweedfs_name }}"
    repo_url: "{{ velero.helm.repo_seaweedfs_url }}"
    state: present
  when: velero.install_server
  tags:
    - install
    - post-install

- name: Build Helm chart dependencies
  ansible.builtin.command:
    cmd: helm dependency build
    chdir: "{{ velero.helm.chart_directory }}"
  when: velero.install_server
  register: helm_repo_add_result
  until: helm_repo_add_result is succeeded
  retries: 5
  delay: 15
  tags:
    - install
    - post-install

- name: Ensure namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ velero.namespace }}"
  tags:
    - install
    - post-install

- name: Load init passwords
  ansible.builtin.include_role:
    name: generate_password
    apply:
      tags:
        - install
        - post-install
  tags:
    - install
    - post-install

- name: Generate random string for SeaweedFS keys
  ansible.builtin.include_role:
    name: generate_password
    tasks_from: generate_key
    apply:
      tags:
        - install
        - post-install
  loop:
    - { name: VELERO_SEAWEEDFS_ACCESS_KEY }
    - { name: VELERO_SEAWEEDFS_SECRET_KEY }
  no_log: "{{ secure_logs }}"
  tags:
    - install
    - post-install

- name: Get all StorageClasses
  kubernetes.core.k8s_info:
    api_version: storage.k8s.io/v1
    kind: StorageClass
  register: sc_list
  tags:
    - install
    - post-install

- name: Determine StorageClass for Velero
  set_fact:
    velero_storage_class_name: >-
      {%- if velero.storage_class is defined and velero.storage_class != "" -%}
        {{ velero.storage_class }}
      {%- else -%}
        {%- for item in sc_list.resources -%}
          {%- if item.metadata.annotations is defined and item.metadata.annotations.get('storageclass.kubernetes.io/is-default-class', 'false') == 'true' -%}
            {{ item.metadata.name }}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
  tags:
    - install
    - post-install

- name: Fail if no StorageClass available for Velero
  ansible.builtin.fail:
    msg: "No StorageClass available for Velero. Either set velero.storage_class in config.yaml or ensure a default StorageClass exists in your cluster."
  when: velero_storage_class_name == ""
  tags:
    - install
    - post-install

- name: Get the StorageClass object that Velero will use
  ansible.builtin.set_fact:
    velero_sc_object: >-
      {%- for item in sc_list.resources -%}
        {%- if item.metadata.name == velero_storage_class_name -%}
          {{ item }}
        {%- endif -%}
      {%- endfor -%}
  tags:
    - install
    - post-install

- name: Fail if specified StorageClass not found
  ansible.builtin.fail:
    msg: "StorageClass '{{ velero_storage_class_name }}' not found in cluster. Available: {{ sc_list.resources | map(attribute='metadata.name') | list | join(', ') }}"
  when: velero_sc_object == ""
  tags:
    - install
    - post-install

- name: Generate override values file from template
  ansible.builtin.template:
    src: "values.yaml.j2"
    dest: "{{ velero_helm_override_values_path }}"
    mode: '0644'
  tags:
    - install
    - post-install

- name: Define SeaweedFS S3 config for Velero
  ansible.builtin.set_fact:
    velero_s3_auth_config:
      identities:
        - name: "velero"
          credentials:
            - accessKey: "{{ VELERO_SEAWEEDFS_ACCESS_KEY }}"
              secretKey: "{{ VELERO_SEAWEEDFS_SECRET_KEY }}"
          actions:
            - "Read"
            - "Write"
            - "List"
            - "Tagging"
            - "Admin"
  tags:
    - install
    - post-install

- name: Create SeaweedFS S3 secret for Velero
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: seaweedfs-s3-secret
        namespace: "{{ velero.namespace }}"
      type: Opaque
      data:
        admin_access_key_id: "{{ VELERO_SEAWEEDFS_ACCESS_KEY | b64encode }}"
        admin_secret_access_key: "{{ VELERO_SEAWEEDFS_SECRET_KEY | b64encode }}"
        seaweedfs_s3_config: "{{ velero_s3_auth_config | to_json | b64encode }}"
  tags:
    - install
    - post-install

- name: Create VolumeSnapshotClass for NFS CSI driver
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: snapshot.storage.k8s.io/v1
      kind: VolumeSnapshotClass
      metadata:
        name: nfs-csi-snapclass
        labels:
          velero.io/csi-volumesnapshot-class: "true"
          meta.erag/sc-managed-by: "velero-role"
      driver: nfs.csi.k8s.io
      deletionPolicy: Delete
  when:
    - velero.enabled
    - velero.install_server
    - velero.install_snapshot_class
    - install_csi is defined
    - install_csi == "nfs"
  tags:
    - install
    - post-install

- name: Set values_files list
  ansible.builtin.set_fact:
    values_files: >
      {{
        [velero.helm.default_values_file] +
        [velero_helm_override_values_path]
      }}
  tags:
    - install
    - post-install

- name: Install or Upgrade Helm chart
  kubernetes.core.helm:
    name: "{{ velero.helm.release_name }}"
    chart_ref: "{{ velero.helm.chart_directory }}"
    namespace: "{{ velero.namespace }}"
    values_files: "{{ values_files }}"
    state: present
    dependency_update: true
    create_namespace: true
    timeout: "{{ helm_timeout }}"
    wait: true
  register: helm_repo_install_result
  until: helm_repo_install_result is succeeded
  retries: 5
  delay: 15
  tags:
    - install
    - post-install

- name: Mark SeaweedFS secrets for password management
  ansible.builtin.include_role:
    name: password_mgmt
    tasks_from: markup.yaml
    apply:
      tags:
        - install
        - post-install
  vars:
    namespace: "{{ velero.namespace }}"
    secret_name: "seaweedfs-s3-secret"
    password_mappings:
      - { key: admin_access_key_id, variable: VELERO_SEAWEEDFS_ACCESS_KEY, user: "" }
      - { key: admin_secret_access_key, variable: VELERO_SEAWEEDFS_SECRET_KEY, user: "" }
  tags:
    - install
    - post-install

- name: Wait for velero pods to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ velero.namespace }}"
    label_selectors:
      - app.kubernetes.io/name=velero
  register: velero_pods_info
  until: velero_pods_info.resources | length > 0 and velero_pods_info.resources[0].status.phase == "Running"
  retries: 30
  delay: 10
  tags:
    - install
    - post-install

- name: Get velero server running pod name
  ansible.builtin.set_fact:
    velero_pod_name: "{{ velero_pods_info.resources[0].metadata.name }}"
  tags:
    - install
    - post-install

- name: Discover velero version
  kubernetes.core.k8s_exec:
    pod: "{{ velero_pod_name }}"
    container: velero
    namespace: "{{ velero.namespace }}"
    command: /velero version
  register: velero_version_check
  tags:
    - install
    - post-install

- name: Extract velero server version
  ansible.builtin.set_fact:
    velero_server_version: "{{ (velero_version_check.stdout | replace('\t', '  ') | from_yaml).Server.Version }}"
  tags:
    - install
    - post-install

- name: Verify velero server reports correct version
  fail:
    msg: "Can't identify velero server version to confirm it's working"
  when:
    velero_server_version is not regex('^[vV][0-9]+\.[0-9]+\.[0-9]+$')
  tags:
    - install
    - post-install

- name: Select velero client version to install
  ansible.builtin.set_fact:
    velero_client_target_version: >-
      {{ velero.client_version if (velero.client_version != "automatic") else velero_server_version }}
  when:
    velero.install_client
  tags:
    - install
    - post-install

- name: Discover local velero client version
  ansible.builtin.command: velero version
  register: velero_local_client_check
  ignore_errors: true
  when:
    velero.install_client
  tags:
    - install
    - post-install

- name: Extract local velero client version
  ansible.builtin.set_fact:
    velero_local_client_version: "{{ (velero_local_client_check.stdout | replace('\t', '  ') | from_yaml).Client.Version }}"
  when:
    velero.install_client and velero_local_client_check.rc == 0
  tags:
    - install
    - post-install

- name: Decide if velero client needs to be installed
  ansible.builtin.set_fact:
    velero_do_install_client: >-
      {{ velero_local_client_check.rc != 0 or velero_local_client_version  != velero_client_target_version }}
  when:
    velero.install_client
  tags:
    - install
    - post-install

- name: Download velero client archive
  ansible.builtin.get_url:
    url: https://github.com/vmware-tanzu/velero/releases/download/{{velero_client_target_version}}/velero-{{velero_client_target_version}}-linux-amd64.tar.gz
    dest: /tmp/velero-{{ velero_client_target_version }}-linux-amd64.tar.gz
    mode: '0644'
  when:
    velero.install_client and velero_do_install_client
  tags:
    - install
    - post-install

- name: Extract velero binary
  become: true
  ansible.builtin.unarchive:
    src: /tmp/velero-{{ velero_client_target_version }}-linux-amd64.tar.gz
    dest: /usr/local/bin
    remote_src: true
    extra_opts:
      - "--strip-components=1"
  when:
    velero.install_client and velero_do_install_client
  tags:
    - install
    - post-install

- name: Set ownership and permissions for velero binary
  become: true
  ansible.builtin.file:
    path: /usr/local/bin/velero
    owner: "{{ ansible_user_id | default(lookup('env', 'USER')) }}"
    mode: '0755'
  when:
    velero.install_client and velero_do_install_client
  tags:
    - install
    - post-install

- name: Discover velero client version
  ansible.builtin.command: velero version
  register: velero_client_version_check
  ignore_errors: true
  tags:
    - install
    - post-install

- name: Sanity check - fail if velero client is unavailable and not requested to install
  fail:
    msg: >
      Velero client is unavailable and not enabled for install.
      Backup and restore procedures can't be enabled.
      Install velero client separately or enable it in config.yaml (install_client: true).
  when:
    - velero_client_version_check.rc != 0 and not velero.install_client
  tags:
    - install
    - post-install

- name: Extract velero client version
  ansible.builtin.set_fact:
    velero_client_version: "{{ (velero_client_version_check.stdout | replace('\t', '  ') | from_yaml).Client.Version }}"
  tags:
    - install
    - post-install

- name: Print out discovered client version
  ansible.builtin.debug:
    msg: "[DEBUG]: Discovered client version: {{ velero_client_version }}"
  tags:
    - install
    - post-install

- name: Verify velero client reports correct version
  fail:
    msg: "Can't identify velero client version to confirm it's working"
  when:
    velero_client_version is not regex('^[vV][0-9]+\.[0-9]+\.[0-9]+$')
  tags:
    - install
    - post-install

- name: Verify that velero client and server versions match
  ansible.builtin.debug:
    msg: >
      [WARNING]: Velero client and server versions do not match: client version: {{ velero_client_version }} and server version: {{ velero_server_version }}. This may impact correctness of the backup and restore procedures.
  when:
    - velero_client_version != velero_server_version
  tags:
    - install
    - post-install

- name: Remove tmp directory
  ansible.builtin.file:
    path: "{{ tmp_dir }}"
    state: absent
  tags:
    - install
    - post-install

- name: Get all Restore objects
  kubernetes.core.k8s_info:
    api_version: velero.io/v1
    kind: Restore
    namespace: "{{ velero.namespace }}"
  register: restore_objects
  when:
    - velero.enabled
    - velero.install_server
  tags:
    - delete
    - post-delete
    - velero-delete

- name: Delete all Restore objects using velero CLI
  ansible.builtin.command:
    cmd: velero restore delete {{ item.metadata.name }} --confirm --namespace {{ velero.namespace }}
  loop: "{{ restore_objects.resources }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  when:
    - velero.enabled
    - velero.install_server
    - restore_objects.resources | length > 0
  ignore_errors: true
  tags:
    - delete
    - post-delete
    - velero-delete

- name: Get all Backup objects
  kubernetes.core.k8s_info:
    api_version: velero.io/v1
    kind: Backup
    namespace: "{{ velero.namespace }}"
  register: backup_objects
  when:
    - velero.enabled
    - velero.install_server
  tags:
    - delete
    - post-delete
    - velero-delete

- name: Delete all Backup objects using velero CLI
  ansible.builtin.command:
    cmd: velero backup delete {{ item.metadata.name }} --confirm --namespace {{ velero.namespace }}
  loop: "{{ backup_objects.resources }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  when:
    - velero.enabled
    - velero.install_server
    - backup_objects.resources | length > 0
  ignore_errors: true
  tags:
    - delete
    - post-delete
    - velero-delete

- name: Uninstall Velero Helm chart
  kubernetes.core.helm:
    name: "{{ velero.helm.release_name }}"
    namespace: "{{ velero.namespace }}"
    state: absent
  when:
    - velero.enabled
    - velero.install_server
  tags:
    - delete
    - post-delete
    - velero-delete

- name: Delete VolumeSnapshotClasses created by Velero role
  kubernetes.core.k8s:
    state: absent
    api_version: snapshot.storage.k8s.io/v1
    kind: VolumeSnapshotClass
    label_selectors:
      - meta.erag/sc-managed-by=velero-role
  when:
    - velero.enabled
    - velero.install_server
  ignore_errors: true
  tags:
    - delete
    - post-delete
    - velero-delete

- name: Wait for velero pods to be deleted
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ velero.namespace }}"
    label_selectors:
      - app.kubernetes.io/name=velero
  register: velero_pods_info
  until: velero_pods_info.resources | length == 0
  retries: 30
  delay: 10
  when:
    - velero.enabled
    - velero.install_server
  tags:
    - delete
    - post-delete
    - velero-delete

- name: Delete velero namespace
  kubernetes.core.k8s:
    state: absent
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ velero.namespace }}"
  when:
    - velero.enabled
    - velero.install_server
  tags:
    - delete
    - post-delete
    - velero-delete
