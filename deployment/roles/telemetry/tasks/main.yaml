# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
# telemetry might be moved to other playbook ; but needs to be designed how to interact with istio
- name: Set roles facts
  ansible.builtin.set_fact:
    telemetry_monitoring_helm_override_values_path: "{{ log_dir }}/telemetry-monitoring-override-values.yaml"
  tags:
    - install
    - update
    - uninstall

# Important: Loki and Tempo depend on correct DNS resolution to communicate with each other (via service discovery).
# kind clusters typically use 'kube-dns' instead of 'coredns'.
# Checks if we're running in a kind environment to decide whether to use kube-dns or coredns
- name: Get node list
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
  register: node_list
  tags:
    - install
    - update

- name: Determine DNS service name based on environment
  ansible.builtin.set_fact:
    dns_service_name: "{{ 'kube-dns' if 'kind' in node_list.resources | map(attribute='metadata.name') | list | join(' ') else 'coredns' }}"
  tags:
    - install
    - update

- ansible.builtin.debug:
    msg: "Kind environment detected. Using 'kube-dns' as the DNS service."
  when: "'kube-dns' in dns_service_name"
  tags:
    - install
    - update

- name: Update Helm repositories
  kubernetes.core.helm_repository:
    name: "{{ item.name }}"
    repo_url: "{{ item.url }}"
    state: present
  loop:
    - { url: "{{ telemetry.prometheus.helm_repo }}", name: "prometheus-community" }
    - { url: "{{ telemetry.grafana.helm_repo }}", name: "grafana" }
    - { url: "{{ telemetry.opensearch.helm_repo }}", name: "opensearch" }
    - { url: "{{ telemetry.opensearch_collector.helm_repo }}", name: "opentelemetry" }
  tags:
    - install
    - update

- name: Build Helm chart dependencies
  ansible.builtin.command:
    cmd: helm dependency build
    chdir: "{{ item }}"
  with_items:
    - "{{ telemetry.monitoring.charts_path }}"
    - "{{ telemetry.logging.charts_path }}"
    - "{{ telemetry.traces.charts_path }}"
    - "{{ telemetry.traces_instr.charts_path }}"
  # when: not all_deps_ok
  tags:
    - install
    - update

- name: Ensure namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ item }}"
  with_items:
    - "{{ telemetry.monitoring.namespace }}"
    - "{{ telemetry.traces.namespace }}"
  tags:
    - install
    - update

# - name: Add istio label to namespace
#   kubernetes.core.k8s:
#     api_version: v1
#     kind: Namespace
#     name: "{{ item }}"
#     labels:
#       istio.io/dataplane-mode: ambient
#     force: true
#   with_items:
#     - "{{ telemetry.monitoring.namespace }}"
#     - "{{ telemetry.traces.namespace }}"
#   tags:
#     - install
#     - update

- name: Create TLS secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ telemetry.grafana.tls_secret_name }}"
        namespace: "{{ telemetry.monitoring.namespace }}"
      data:
        tls.crt: "{{ lookup('file', pathToCert) | b64encode }}"
        tls.key: "{{ lookup('file', pathToKey) | b64encode }}"
      type: kubernetes.io/tls
  tags:
    - install
    - update

- name: Set facts for password generation
  ansible.builtin.set_fact:
    telemetry_password_file_path: "{{ log_dir }}/{{ telemetry.grafana.auth.admin.password_file_name }}.txt"
  tags:
    - install
    - uninstall

- name: Generate password or load from file
  ansible.builtin.include_role:
    name: generate_password
  with_items:
    - { generate_password_path: "{{ telemetry_password_file_path }}" }
  tags:
    - install

- name: Set generated passwords
  ansible.builtin.set_fact:
    telemetry_admin_password: "{{ password }}"
  tags:
    - install

- name: Create password secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ telemetry.grafana.auth.admin.password_secret_name }}"
        namespace: "{{ telemetry.monitoring.namespace }}"
      data:
        user: "{{ telemetry.grafana.auth.admin.username | b64encode }}"
        password: "{{ telemetry_admin_password | b64encode }}"
  no_log: true
  tags:
    - install

- name: Generate override values file from template
  ansible.builtin.template:
    src: "values.yaml.j2"
    dest: "{{ telemetry_monitoring_helm_override_values_path }}"
    mode: '0644'
  tags:
    - install
    - update

- name: Set values_files list
  ansible.builtin.set_fact:
    values_files: >
      {{
        [telemetry.monitoring.helm_default_values_file] +
        [telemetry_monitoring_helm_override_values_path]
      }}
  tags:
    - install
    - update

- name: Get the secret from the source namespace
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: vector-database-config
    namespace: chatqa
  register: secret_info
  no_log: true
  tags:
    - install
    - update

- name: Create the secret in the target namespace
  kubernetes.core.k8s:
    api_version: v1
    kind: Secret
    name: vector-database-config
    namespace: "{{ telemetry.monitoring.namespace }}"
    state: present
    definition:
      metadata:
        name: "{{ secret_info.resources[0].metadata.name }}"
        namespace: "{{ telemetry.monitoring.namespace }}"
      data: "{{ secret_info.resources[0].data }}"
      type: "{{ secret_info.resources[0].type }}"
  no_log: true
  tags:
    - install
    - update

- name: Install monitoring Helm chart
  kubernetes.core.helm:
    name: telemetry
    chart_ref: "{{ telemetry.monitoring.charts_path }}"
    release_namespace: "{{ telemetry.monitoring.namespace }}"
    state: present
    values_files: "{{ values_files }}"
    create_namespace: true
    wait: true
  tags:
    - install
    - update

- name: Set otelcol-logs image repository and tag based on condition
  ansible.builtin.set_fact:
    helm_otelcol_logs_image_repo: "{{ registry if use_alternate_tagging else registry ~ '/otelcol-contrib-journalctl' }}"
    helm_otelcol_logs_image_tag: "{{ 'otelcol-contrib-journalctl_' ~ tag if use_alternate_tagging else tag }}"
  tags:
    - install
    - update

- name: Install logging Helm chart
  kubernetes.core.helm:
    name: telemetry-logs
    chart_ref: "{{ telemetry.logging.charts_path }}"
    release_namespace: "{{ telemetry.monitoring.namespace }}"
    state: present
    values_files:
      - "{{ telemetry.logging.helm_default_values_file }}"
      - "{{ telemetry.logging.helm_journalctl_values_file }}"
    values:
      global:
        dnsService: "{{ dns_service_name }}"
      otelcol-logs:
        image:
          repository: "{{ helm_otelcol_logs_image_repo }}"
          tag: "{{ helm_otelcol_logs_image_tag }}"
    create_namespace: true
    wait: true
  tags:
    - install
    - update

- name: Install traces Helm chart
  kubernetes.core.helm:
    name: telemetry-traces
    chart_ref: "{{ telemetry.traces.charts_path }}"
    release_namespace: "{{ telemetry.traces.namespace }}"
    state: present
    values_files: "{{ telemetry.traces.helm_default_values_file }}"
    values:
      global:
        dnsService: "{{ dns_service_name }}"
    create_namespace: true
    wait: true
  tags:
    - install
    - update

- name: Install traces instrumentation Helm chart
  kubernetes.core.helm:
    name: telemetry-traces-instr
    chart_ref: "{{ telemetry.traces_instr.charts_path }}"
    release_namespace: "{{ telemetry.traces.namespace }}"
    state: present
    values_files: "{{ telemetry.traces_instr.helm_default_values_file }}"
    create_namespace: true
    wait: true
  tags:
    - install
    - update

- name: Delete CRD
  kubernetes.core.k8s:
    state: absent
    definition:
      apiVersion: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition
      metadata:
        name: otelcols/otelcol-traces
  tags:
    - uninstall

- name: Delete mutating webhook configuration if it exists
  kubernetes.core.k8s:
    state: absent
    api_version: admissionregistration.k8s.io/v1
    kind: MutatingWebhookConfiguration
    name: telemetry-traces-otel-operator-mutation
  ignore_errors: true
  tags:
    - uninstall

- name: Delete validating webhook configuration if it exists
  kubernetes.core.k8s:
    state: absent
    api_version: admissionregistration.k8s.io/v1
    kind: ValidatingWebhookConfiguration
    name: telemetry-traces-otel-operator-validation
  ignore_errors: true
  tags:
    - uninstall

# temporary mitigation
- name: Patch otelcol-traces to remove finalizers using kubectl
  ansible.builtin.command:
    cmd: kubectl patch otelcols otelcol-traces -n {{ telemetry.traces.namespace }} --type='merge' -p '{"metadata":{"finalizers":[]}}'
  ignore_errors: true
  tags:
    - uninstall

- name: Delete monitoring Helm chart
  kubernetes.core.helm:
    name: telemetry
    release_namespace: "{{ telemetry.monitoring.namespace }}"
    state: absent
  tags:
    - uninstall

- name: Delete logging Helm chart
  kubernetes.core.helm:
    name: telemetry-logs
    release_namespace: "{{ telemetry.monitoring.namespace }}"
    state: absent
  tags:
    - uninstall

- name: Delete traces-instr Helm chart
  kubernetes.core.helm:
    name: telemetry-traces-instr
    release_namespace: "{{ telemetry.traces.namespace }}"
    state: absent
  tags:
    - uninstall

- name: Delete traces Helm chart
  kubernetes.core.helm:
    name: telemetry-traces
    release_namespace: "{{ telemetry.traces.namespace }}"
    state: absent
  tags:
    - uninstall

- name: Delete namespace
  kubernetes.core.k8s:
    state: absent
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ item }}"
  with_items:
    - "{{ telemetry.monitoring.namespace }}"
    - "{{ telemetry.traces.namespace }}"
  tags:
    - uninstall

- name: Remove password file
  ansible.builtin.file:
    state: absent
    path: "{{ item }}"
  with_items:
    - "{{ telemetry_password_file_path }}"
  tags:
    - uninstall
