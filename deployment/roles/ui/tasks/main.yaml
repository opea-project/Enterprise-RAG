# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
# reminder to check if in already built image i can create entrypoint script that would sed the static pages from auth.erag.com
# to something that I'd specify in helm values.yaml to be able to dynamic linking stuff instead of having to rebuilt images ...
- name: Set override_values.yaml path
  ansible.builtin.set_fact:
    ui_helm_override_values_path: "{{ log_dir }}/{{ ui.helm.chart_name }}-override-values.yaml"
  tags:
    - always

- name: Generate override values file from template
  ansible.builtin.template:
    src: "values.yaml.j2"
    dest: "{{ ui_helm_override_values_path }}"
    mode: '0644'
  tags:
    - install
    - update

- name: Set values_files list
  ansible.builtin.set_fact:
    values_files: >
      {{
        [ui.helm.default_values_file] +
        [ui_helm_override_values_path]
      }}
  tags:
    - install
    - update

- name: Install or Upgrade Helm chart
  kubernetes.core.helm:
    name: "{{ ui.helm.release_name }}"
    chart_ref: "{{ ui.helm.chart_directory }}"
    namespace: "{{ ui.namespace }}"
    values_files: "{{ values_files }}"
    state: present
    create_namespace: true
    timeout: "{{ helm_timeout }}"
  tags:
    - install
    - update

- name: Uninstall Helm chart
  kubernetes.core.helm:
    name: "{{ ui.helm.release_name }}"
    namespace: "{{ ui.namespace }}"
    state: absent
  tags:
    - uninstall

- name: Delete namespace
  kubernetes.core.k8s:
    state: absent
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ ui.namespace }}"
  tags:
    - uninstall
