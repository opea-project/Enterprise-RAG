# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

[tox]
requires =
    tox==4.30.2
    tox-uv==1.28.0
    uv==0.8.17

env_list =
    py312

[testenv]
basepython = python3.12

# -----------------------------------------------------------------------------

[testenv:embeddings_unit_tests]
description = Run embeddings microservice unit tests
runner = uv-venv-lock-runner
set_env =
    PYTHONPATH = .
uv_sync_flags = --project, comps/embeddings/impl/microservice/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/embeddings --cov-report=term-missing tests/unit/embeddings {posargs}

# -----------------------------------------------------------------------------

[testenv:llms_unit_tests]
description = Run llms microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/llms/impl/microservice/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/llms --cov-report=term-missing tests/unit/llms {posargs}

# -----------------------------------------------------------------------------

[testenv:docsum_unit_tests]
description = Run docsum microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/docsum/impl/microservice/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/docsum --cov-report=term-missing tests/unit/docsum {posargs}

# -----------------------------------------------------------------------------

[testenv:text_extractor_unit_tests]
description = Run Text Extractor microservice unit tests
runner = uv-venv-lock-runner
allowlist_externals =
    apt
commands_pre =
    apt install -y libgl1 asciidoctor libcairo2 libreoffice-nogui libmagic1
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/text_extractor/impl/microservice/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/text_extractor --cov-report=term-missing tests/unit/text_extractor {posargs}

# -----------------------------------------------------------------------------

[testenv:text_compression_unit_tests]
description = Run Text Compression microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/text_compression/impl/microservice/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/text_compression --cov-report=term-missing tests/unit/text_compression {posargs}

# -----------------------------------------------------------------------------

[testenv:text_splitter_unit_tests]
description = Run Text Splitter microservice unit tests
runner = uv-venv-lock-runner
uv_python_preference = only-managed
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/text_splitter/impl/microservice/pyproject.toml
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/text_splitter --cov-report=term-missing tests/unit/text_splitter {posargs}

# -----------------------------------------------------------------------------

[testenv:ingestion_unit_tests]
description = Run ingestion microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/ingestion/impl/microservice/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/ingestion --cov-report=term-missing tests/unit/ingestion {posargs}

# -----------------------------------------------------------------------------

[testenv:prompt_template_unit_tests]
description = Run Prompt Template microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/prompt_template/impl/microservice/pyproject.toml
uv_python_preference = only-managed
allowlist_externals =
    apt
commands_pre =
    apt install -y build-essential
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/prompt_template --cov-report=term-missing tests/unit/prompt_template {posargs}

# -----------------------------------------------------------------------------

[testenv:prompt_registry_unit_tests]
description = Run Prompt Registry microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/prompt_registry/impl/microservice/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/prompt_registry --cov-report=term-missing tests/unit/prompt_registry {posargs}

# -----------------------------------------------------------------------------

[testenv:retrievers_unit_tests]
description = Run retriever microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/retrievers/impl/microservice/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/retrievers --cov-report=term-missing tests/unit/retrievers {posargs}

# -----------------------------------------------------------------------------

[testenv:reranks_unit_tests]
description = Run reranks microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/reranks/impl/microservice/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/reranks --cov-report=term-missing tests/unit/reranks {posargs}

# -----------------------------------------------------------------------------

[testenv:vectorstores_unit_tests]
description = Run vectorstores microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/vectorstores/impl/requirements/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/vectorstores --cov-report=term-missing tests/unit/vectorstores {posargs}

# -----------------------------------------------------------------------------

[testenv:llm_guard_input_guardrail_unit_tests]
description = Run LLm Guard Input Guardrail microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/guardrails/llm_guard_input_guardrail/impl/microservice/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/guardrails/llm_guard_input_guardrail --cov-report=term-missing tests/unit/guardrails/llm_guard_input_guardrail {posargs}

# -----------------------------------------------------------------------------

[testenv:llm_guard_output_guardrail_unit_tests]
description = Run LLm Guard Output Guardrail microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/guardrails/llm_guard_output_guardrail/impl/microservice/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/guardrails/llm_guard_output_guardrail --cov-report=term-missing tests/unit/guardrails/llm_guard_output_guardrail {posargs}

# -----------------------------------------------------------------------------

[testenv:llm_guard_dataprep_guardrail_unit_tests]
description = Run LLm Guard Dataprep Guardrail microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/guardrails/llm_guard_dataprep_guardrail/impl/microservice/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/guardrails/llm_guard_dataprep_guardrail --cov-report=term-missing tests/unit/guardrails/llm_guard_dataprep_guardrail {posargs}

# -----------------------------------------------------------------------------

[testenv:language_detection_unit_tests]
description = Run Language Detection microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/language_detection/impl/microservice/pyproject.toml
uv_python_preference = only-managed
allowlist_externals =
    apt
commands_pre =
    apt install -y build-essential
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/language_detection --cov-report=term-missing tests/unit/language_detection {posargs}

# -----------------------------------------------------------------------------

[testenv:hierarchical_dataprep_unit_tests]
description = Run hierarchical dataprep microservice unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/hierarchical_dataprep/impl/microservice/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/hierarchical_dataprep --cov-report=term-missing tests/unit/hierarchical_dataprep {posargs}

# -----------------------------------------------------------------------------

[testenv:chat_history_unit_tests]
description = Run Chat History unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, comps/chat_history/impl/microservice/pyproject.toml
uv_python_preference = only-managed
allowlist_externals =
    apt
commands_pre =
    apt install -y build-essential
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=comps/chat_history --cov-report=term-missing tests/unit/chat_history {posargs}

# -----------------------------------------------------------------------------

[testenv:edp_unit_tests]
description = Run Enhanced Dataprep unit tests
runner = uv-venv-lock-runner
setenv =
    PYTHONPATH = .
uv_sync_flags = --project, edp/app/pyproject.toml
uv_python_preference = only-managed
basepython = python3.11
extras =
    test
commands =
    pytest -s --disable-warnings --cov=edp/app --cov-report=term-missing edp/tests {posargs}

# -----------------------------------------------------------------------------

[testenv:microservices]
description = Run microservices tests
changedir = tests/microservices
passenv =
    HF_TOKEN
deps =
    -r tests/microservices/requirements.txt
commands =
    pytest -s --capture=tee-sys --alluredir allure-results --clean-alluredir {posargs}

# -----------------------------------------------------------------------------

[testenv:usvc-benchmark]
description = Run benchmark  usvc tests
deps = {[testenv:test-base]deps}
       pytest-repeat
       -r tests/microservices/requirements.txt
passenv = {[testenv:test-base]passenv}
          HF_TOKEN
changedir = {[testenv:test-base]changedir}/benchmark_microservices
setenv = {[testenv:test-base]setenv}
         PYTHONPATH={toxinidir}/..
commands =
    pytest -vv -s --capture=tee-sys --alluredir ../allure-results --log-format="%(asctime)s %(levelname)s [%(module)s] %(message)s" --clean-alluredir {posargs}

# -----------------------------------------------------------------------------

[testenv:test-base]
description = Base configuration for tests
changedir = tests
setenv =
    http_proxy=
    https_proxy=
    HTTP_PROXY=
    HTTPS_PROXY=
    PYTHONPATH={toxinidir}
passenv =
    KUBECONFIG
    NO_PROXY
    no_proxy
deps =
    -r tests/e2e/validation/requirements.txt

# -----------------------------------------------------------------------------

[testenv:e2e]
description = Run end-to-end tests on a running cluster
deps = {[testenv:test-base]deps}
setenv = {[testenv:test-base]setenv}
passenv = {[testenv:test-base]passenv}
changedir = {[testenv:test-base]changedir}
commands =
    pytest -vv -s --capture=tee-sys --alluredir allure-results --clean-alluredir --log-format="%(asctime)s %(levelname)s [%(module)s] %(message)s" e2e/validation {posargs}

# -----------------------------------------------------------------------------

[testenv:e2e-smoke]
description = Run end-to-end tests on a running cluster
deps = {[testenv:test-base]deps}
setenv = {[testenv:test-base]setenv}
passenv = {[testenv:test-base]passenv}
changedir = {[testenv:test-base]changedir}
commands = 
    pytest -vv -s --capture=tee-sys --alluredir allure-results --clean-alluredir -log-format="%(asctime)s %(levelname)s [%(module)s] %(message)s" e2e/validation -m smoke {posargs}


# -----------------------------------------------------------------------------

[testenv:e2e-benchmark-edp]
description = Run edp benchmarks on deployed RAG
deps = {[testenv:test-base]deps}
        -r tests/e2e/benchmarks/edp/requirements.txt
setenv = {[testenv:test-base]setenv}
passenv = {[testenv:test-base]passenv}
          ELASTIC_USER
          ELASTIC_PASSWORD
changedir = {[testenv:test-base]changedir}
commands =
    pytest -vv -s --capture=tee-sys --alluredir allure-results --clean-alluredir --log-format="%(asctime)s %(levelname)s [%(module)s] %(message)s" e2e/benchmarks/edp {posargs}

# -----------------------------------------------------------------------------

[testenv:e2e-evals]
description = Run evaluation metrics tests
deps = {[testenv:test-base]deps}
        -r tests/e2e/evals/evaluation/rag_eval/requirements.txt
setenv = {[testenv:test-base]setenv}
passenv = {[testenv:test-base]passenv}
changedir = {[testenv:test-base]changedir}
commands =
    pytest -vv -s --capture=tee-sys --alluredir allure-results --clean-alluredir --log-format="%(asctime)s %(levelname)s [%(module)s] %(message)s" e2e/evals {posargs}

# -----------------------------------------------------------------------------

[testenv:e2e-ui]
description = Run UI tests with Playwright using E2E credential file approach
deps = {[testenv:test-base]deps}
       -r tests/e2e/ui/requirements.txt
setenv = {[testenv:test-base]setenv}
passenv = {[testenv:test-base]passenv}
          DISPLAY
          HEADLESS
          XAUTHORITY
          ERAG_DOMAIN
allowlist_externals = mkdir
changedir = {[testenv:test-base]changedir}
commands_pre = 
    playwright install firefox
    mkdir -p test-results/screenshots test-results/videos test_logs
commands = pytest -vv -s --capture=tee-sys  --alluredir allure-results --clean-alluredir --log-format="%(asctime)s %(levelname)s [%(module)s] %(message)s" --credentials-file=../../deployment/ansible-logs/default_credentials.txt e2e/ui/ {posargs}

# -----------------------------------------------------------------------------
